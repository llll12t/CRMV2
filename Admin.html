<!DOCTYPE html>
<html lang="th" data-theme="corporate">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM-3RN Admin</title>
  <!-- Load config before main script -->
  <script src="config-admin.js"></script>
  <!-- DaisyUI CDN (includes Tailwind CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f1f5f9; } /* Light gray background */
    .hidden { display: none !important; }
    .loading-spinner {
      border: 4px solid oklch(var(--b2)/0.5); border-top: 4px solid oklch(var(--p));
      border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .table-responsive { overflow-x: auto; }
    .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
  </style>
</head>

<body>
  <!-- Login Overlay -->
  <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
      <div class="card w-96 bg-base-100 shadow-xl">
          <div class="card-body">
              <h2 class="card-title justify-center">Admin Login</h2>
              <div id="login-error" class="text-error text-center text-sm hidden"></div>
              <div class="form-control">
                  <label class="label"><span class="label-text">Username</span></label>
                  <input type="text" id="username" placeholder="username" class="input input-bordered" />
              </div>
              <div class="form-control">
                  <label class="label"><span class="label-text">Password</span></label>
                  <input type="password" id="password" placeholder="password" class="input input-bordered" />
              </div>
              <div class="card-actions justify-end mt-4">
                  <button id="loginBtn" class="btn btn-primary w-full">Login</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Main App Content (hidden until logged in) -->
  <div id="main-app" class="drawer lg:drawer-open hidden">
    <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content flex flex-col">
      <!-- Navbar -->
      <div class="navbar bg-base-100 shadow-md p-4 mb-6 sticky top-0 z-40">
        <div class="flex-none lg:hidden">
          <label for="my-drawer-2" aria-label="open sidebar" class="btn btn-square btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
          </label>
        </div>
        <div class="flex-1 px-2 mx-2"><h1 class="text-xl font-bold">CRM-3RN Admin</h1></div>
        <div class="flex-none"><button id="logoutBtn" class="btn btn-sm btn-ghost">Logout</button></div>
      </div>

      <!-- Main content area -->
      <main class="container mx-auto p-4 flex-grow">
        <div id="app-container">
          <div class="text-center text-base-content text-opacity-50 py-8"><div class="loading-spinner mx-auto mb-4"></div>กำลังโหลด...</div>
        </div>
      </main>
    </div>

    <!-- Sidebar -->
    <aside class="drawer-side z-50">
      <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label>
      <ul class="menu p-4 w-80 min-h-full bg-base-200 text-base-content">
        <li class="menu-title text-lg font-bold p-4">เมนูผู้ดูแลระบบ</li>
        <li><a href="#dashboard" class="nav-link">ภาพรวม</a></li>
        <li><a href="#users" class="nav-link">จัดการผู้ใช้</a></li>
        <li><a href="#items" class="nav-link">จัดการของรางวัล</a></li>
        <li><a href="#warehouse" class="nav-link">คลังสินค้า</a></li>
        <li><a href="#events" class="nav-link">จัดการกิจกรรม</a></li>
        <li><a href="#codes" class="nav-link">จัดการโค้ด</a></li>
        <li><a href="#history" class="nav-link">ประวัติการทำรายการ</a></li>
        <li><a href="#settings" class="nav-link">ตั้งค่าระบบ</a></li>
      </ul>
    </aside>
  </div>

  <!-- MODALS (Alert, Confirm, Form) -->
  <dialog id="customAlertDialog" class="modal"><div class="modal-box text-center"><h3 id="customAlertTitle" class="font-bold text-lg mb-3"></h3><p id="customAlertMessage" class="py-4 whitespace-pre-line"></p><div class="modal-action justify-center"><button id="customAlertButton" class="btn btn-primary w-full">ตกลง</button></div></div></dialog>
  <dialog id="customConfirmDialog" class="modal"><div class="modal-box text-center"><h3 id="customConfirmTitle" class="font-bold text-lg mb-3"></h3><p id="customConfirmMessage" class="py-4"></p><div class="modal-action justify-around"><button id="customConfirmCancelButton" class="btn btn-outline">ยกเลิก</button><button id="customConfirmConfirmButton" class="btn btn-primary">ยืนยัน</button></div></div></dialog>
  <dialog id="dataFormModal" class="modal"><div class="modal-box"><h3 id="dataFormModalTitle" class="font-bold text-lg mb-4"></h3><form id="dataForm" method="dialog"><div id="formFields" class="space-y-4"></div><div class="modal-action"><button type="button" id="formCancelBtn" class="btn btn-outline">ยกเลิก</button><button type="submit" id="formSaveBtn" class="btn btn-primary">บันทึก</button></div></form></div></dialog>

  <!-- TEMPLATES -->
  <template id="view-dashboard">
    <h2 class="text-3xl font-bold mb-6 text-center">ภาพรวมระบบ</h2>
    <div class="stats stats-vertical lg:stats-horizontal shadow w-full mb-8">
      <div class="stat"><div class="stat-title">ผู้ใช้ทั้งหมด</div><div id="statTotalUsers" class="stat-value">0</div><div id="statNewUsersToday" class="stat-desc"></div></div>
      <div class="stat"><div class="stat-title">ของรางวัล</div><div id="statTotalItems" class="stat-value">0</div><div id="statRedeemedItems" class="stat-desc"></div></div>
      <div class="stat"><div class="stat-title">กิจกรรม & โค้ด</div><div id="statTotalEvents" class="stat-value">0</div><div id="statTotalCodes" class="stat-desc"></div></div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="card bg-base-100 shadow-xl"><div class="card-body"><h3 class="card-title">ผู้ใช้ตามระดับ (LV)</h3><div class="relative h-64"><canvas id="userLevelChart"></canvas></div></div></div>
      <div class="card bg-base-100 shadow-xl"><div class="card-body"><h3 class="card-title">สถิติพ้อยต์ (รับ/ใช้)</h3><div class="relative h-64"><canvas id="pointStatsChart"></canvas></div></div></div>
    </div>
  </template>

  <template id="view-users">
    <h2 class="text-2xl font-bold mb-4">จัดการผู้ใช้</h2>
    <div class="flex flex-col md:flex-row gap-4 mb-4">
      <input type="text" id="userSearchInput" placeholder="ค้นหา (LINE ID / ชื่อ / เบอร์โทร)" class="input input-bordered flex-grow" />
      <button id="userSearchBtn" class="btn btn-primary">ค้นหา</button>
      <button id="addUserBtn" class="btn btn-secondary">เพิ่มผู้ใช้ใหม่</button>
    </div>
    <div class="table-responsive rounded-lg bg-base-100 shadow-md"><table class="table w-full table-zebra"><thead class="bg-base-200"><tr><th>LINE ID</th><th>ชื่อ</th><th>เบอร์โทร</th><th>พ้อยต์</th><th>ระดับ</th><th>Tags</th><th>จัดการ</th></tr></thead><tbody id="userTableBody"></tbody></table></div>
  </template>

  <template id="view-items">
    <h2 class="text-2xl font-bold mb-4">จัดการของรางวัล</h2>
    <button id="addItemBtn" class="btn btn-secondary mb-4">เพิ่มของรางวัลใหม่</button>
    <div class="table-responsive rounded-lg bg-base-100 shadow-md"><table class="table w-full table-zebra"><thead class="bg-base-200"><tr><th>ID</th><th>ชื่อ</th><th>พ้อยต์</th><th>ประเภท</th><th>รูปภาพ</th><th>จัดการ</th></tr></thead><tbody id="itemTableBody"></tbody></table></div>
  </template>

  <template id="view-warehouse">
    <h2 class="text-2xl font-bold mb-4">คลังสินค้า (รายการที่แลกแล้ว)</h2>
    <div class="flex flex-col md:flex-row gap-4 mb-4">
      <input type="text" id="warehouseSearchInput" placeholder="ค้นหา (Line ID, ชื่อผู้รับ, ชื่อของ)" class="input input-bordered flex-grow" />
      <select id="warehouseStatusFilter" class="select select-bordered w-full md:w-auto"><option value="">-- ทุกสถานะ --</option><option value="pending_claim" selected>รอรับ/จัดส่ง</option><option value="claimed">รับแล้ว</option></select>
      <button id="warehouseSearchBtn" class="btn btn-primary">ค้นหา</button>
    </div>
    <div class="table-responsive rounded-lg bg-base-100 shadow-md"><table class="table w-full table-zebra"><thead class="bg-base-200"><tr><th>ID</th><th>ของรางวัล</th><th>ผู้ใช้ (Line ID)</th><th>ข้อมูลจัดส่ง</th><th>วันที่แลก</th><th>สถานะ</th><th>จัดการ</th></tr></thead><tbody id="warehouseTableBody"></tbody></table></div>
  </template>

  <template id="view-events">
    <h2 class="text-2xl font-bold mb-4">จัดการกิจกรรม</h2>
    <button id="addEventBtn" class="btn btn-secondary mb-4">เพิ่มกิจกรรมใหม่</button>
    <div class="table-responsive rounded-lg bg-base-100 shadow-md"><table class="table w-full table-zebra"><thead class="bg-base-200"><tr><th>ID</th><th>ชื่อกิจกรรม</th><th>พ้อยต์</th><th>ระดับที่เข้าร่วมได้</th><th>จัดการ</th></tr></thead><tbody id="eventTableBody"></tbody></table></div>
  </template>

  <template id="view-codes">
    <h2 class="text-2xl font-bold mb-4">จัดการโค้ด</h2>
    <button id="addCodeBtn" class="btn btn-secondary mb-4">เพิ่มโค้ดใหม่</button>
    <div class="table-responsive rounded-lg bg-base-100 shadow-md"><table class="table w-full table-zebra"><thead class="bg-base-200"><tr><th>ID (QR Code)</th><th>ชื่อโค้ด</th><th>พ้อยต์</th><th>จัดการ</th></tr></thead><tbody id="codeTableBody"></tbody></table></div>
  </template>
  
  <template id="view-history">
    <h2 class="text-2xl font-bold mb-4">ประวัติการทำรายการ</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4 items-end">
      <input type="text" id="historySearchLineId" placeholder="ค้นหาด้วย Line ID" class="input input-bordered w-full" />
      <select id="historyFilterType" class="select select-bordered w-full"><option value="">-- ประเภททั้งหมด --</option><option value="checkin">เช็คอิน</option><option value="event">กิจกรรม</option><option value="code">โค้ด</option><option value="redeem">แลกของ</option><option value="transfer_in">รับโอน</option><option value="transfer_out">โอนออก</option></select>
      <input type="date" id="historyStartDate" class="input input-bordered w-full" placeholder="จากวันที่">
      <input type="date" id="historyEndDate" class="input input-bordered w-full" placeholder="ถึงวันที่">
      <div class="flex gap-2"><button id="historyFilterBtn" class="btn btn-primary flex-grow">กรอง</button><button id="historyResetBtn" class="btn btn-ghost flex-grow">รีเซ็ต</button></div>
    </div>
    <div class="table-responsive rounded-lg bg-base-100 shadow-md"><table class="table w-full table-zebra"><thead class="bg-base-200"><tr><th>Line ID</th><th>ประเภท</th><th>รายละเอียด</th><th>จำนวน</th><th>วันที่</th><th>ID อ้างอิง</th></tr></thead><tbody id="historyTableBody"></tbody></table></div>
  </template>

  <template id="view-settings">
    <h2 class="text-2xl font-bold mb-4">ตั้งค่าระบบ</h2>
    <div class="card bg-base-100 shadow-xl max-w-lg mx-auto"><div class="card-body"><h3 class="card-title">การตั้งค่าระดับผู้ใช้</h3><p class="text-sm opacity-70 mb-4">กำหนดแต้มขั้นต่ำเพื่อเลื่อนระดับ</p><form id="levelSettingsForm" class="space-y-4">
      <div class="form-control"><label class="label"><span class="label-text">แต้มสำหรับระดับ VIP</span></label><input type="number" id="vipPoints" placeholder="0" class="input input-bordered w-full" required min="0" /></div>
      <div class="form-control"><label class="label"><span class="label-text">แต้มสำหรับระดับ SUPER</span></label><input type="number" id="superPoints" placeholder="0" class="input input-bordered w-full" required min="0" /></div>
      <div class="mt-6"><button type="submit" id="saveLevelSettingsBtn" class="btn btn-primary w-full">บันทึก</button></div>
    </form></div></div>
  </template>


<script>
    // --- Globals ---
    const mainApp = document.getElementById('main-app');
    const appContainer = document.getElementById('app-container');
    const drawerToggle = document.getElementById('my-drawer-2');

    let levelConfig = { VIP_points: 100, SUPER_points: 500 };

    // --- Helpers (Alert, Confirm, API) ---
    function showAlert(title, message, cb) {
        const dialog = document.getElementById('customAlertDialog');
        document.getElementById('customAlertTitle').textContent = title;
        document.getElementById('customAlertMessage').textContent = message;
        dialog.showModal();
        const btn = document.getElementById('customAlertButton');
        const handler = () => { dialog.close(); btn.removeEventListener('click', handler); cb && cb(); };
        btn.addEventListener('click', handler);
    }

    function showConfirm(title, message) {
        return new Promise(res => {
            const dialog = document.getElementById('customConfirmDialog');
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmMessage').textContent = message;
            dialog.showModal();
            const ok = document.getElementById('customConfirmConfirmButton'), no = document.getElementById('customConfirmCancelButton');
            const onOk = () => { cleanup(); res(true); };
            const onNo = () => { cleanup(); res(false); };
            function cleanup() { dialog.close(); ok.removeEventListener('click', onOk); no.removeEventListener('click', onNo); }
            ok.addEventListener('click', onOk);
            no.addEventListener('click', onNo);
        });
    }

    async function fetchData(action, params = {}) {
        const url = new URL(CONFIG.GAS_URL_ADMIN); // ใช้ URL จาก config
        url.searchParams.append('action', action);
        for (const k in params) {
            if (params[k]) url.searchParams.append(k, params[k]);
        }
        console.log(`Fetching data for action: ${action} with params:`, params);
        try {
            const r = await fetch(url);
            if (!r.ok) {
                const errorText = await r.text();
                console.error(`Fetch Error ${r.status}:`, errorText);
                throw new Error(`Server responded with ${r.status}`);
            }
            return await r.json();
        } catch (e) {
            showAlert('API GET Error', `Failed to fetch data for '${action}'. Check console for details.`);
            throw e;
        }
    }

    async function postData(action, data) {
        console.log(`Posting data for action: ${action}`, data);
        try {
            const r = await fetch(CONFIG.GAS_URL_ADMIN, { // ใช้ URL จาก config
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // GAS post expects plain text
                body: JSON.stringify({ action, ...data })
            });
            if (!r.ok) {
                const errorText = await r.text();
                console.error(`Post Error ${r.status}:`, errorText);
                throw new Error(`Server responded with ${r.status}`);
            }
            return await r.text();
        } catch (e) {
            showAlert('API POST Error', `Failed to post data for '${action}'. Check console for details.`);
            throw e;
        }
    }

    // --- Router ---
    const routes = {
        '': { tpl: 'view-dashboard', init: initDashboard },
        '#dashboard': { tpl: 'view-dashboard', init: initDashboard },
        '#users': { tpl: 'view-users', init: initUsers },
        '#items': { tpl: 'view-items', init: initItems },
        '#warehouse': { tpl: 'view-warehouse', init: initWarehouse },
        '#events': { tpl: 'view-events', init: initEvents },
        '#codes': { tpl: 'view-codes', init: initCodes },
        '#history': { tpl: 'view-history', init: initHistory },
        '#settings': { tpl: 'view-settings', init: initSettings },
    };

    function setActiveNavLink() {
        const hash = window.location.hash || '#dashboard';
        document.querySelectorAll('.nav-link').forEach(l => {
            l.classList.toggle('active', l.getAttribute('href') === hash);
        });
        if (drawerToggle && drawerToggle.checked) {
            drawerToggle.checked = false;
        }
    }

    async function router() {
        if (!sessionStorage.getItem('isLoggedIn')) {
            console.log("Not logged in, skipping router.");
            return;
        }
        console.log("Router starting...");
        
        try {
            const config = await fetchData('getLevelConfig');
            if (config) {
                levelConfig = { VIP_points: parseInt(config.VIP_points), SUPER_points: parseInt(config.SUPER_points) };
                console.log("Level config loaded:", levelConfig);
            }
        } catch (e) {
            console.warn("Could not load level config. Using defaults.", e);
        }

        setActiveNavLink();
        const hash = window.location.hash || '#dashboard';
        const route = routes[hash] || routes[''];
        
        appContainer.innerHTML = `<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p>Loading ${hash}...</p></div>`;
        const template = document.getElementById(route.tpl);
        
        if (template) {
            appContainer.innerHTML = '';
            appContainer.appendChild(template.content.cloneNode(true));
            try {
                console.log(`Initializing page: ${hash}`);
                await route.init();
                console.log(`Page ${hash} initialized successfully.`);
            } catch (e) {
                console.error(`Error initializing page ${hash}:`, e);
                appContainer.innerHTML = `<div class="text-error text-center p-4">Error loading page content: ${e.message}</div>`;
            }
        } else {
            appContainer.innerHTML = `<div class="text-error text-center p-4">Page template for "${hash}" not found.</div>`;
        }
    }

    // --- Authentication ---
    function handleLogin() {
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('loginBtn');
        const userInput = document.getElementById('username');
        const passInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');

        async function attemptLogin() {
            loginBtn.classList.add('loading');
            loginError.classList.add('hidden');
            try {
                // Login action doesn't really need a server call if it's hardcoded, but this matches the original code
                const res = await postData('login', { username: userInput.value, password: passInput.value });
                const data = JSON.parse(res); // assuming response is JSON string
                if (data.success) {
                    console.log("Login successful!");
                    sessionStorage.setItem('isLoggedIn', 'true');
                    loginOverlay.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    // Manually call router for the first time after login
                    await router(); 
                } else {
                    loginError.textContent = data.message || "Invalid credentials";
                    loginError.classList.remove('hidden');
                }
            } catch (e) {
                loginError.textContent = 'Login request failed. Check console.';
                loginError.classList.remove('hidden');
            } finally {
                loginBtn.classList.remove('loading');
            }
        }
        
        loginBtn.onclick = attemptLogin;
        passInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        document.getElementById('logoutBtn').onclick = () => {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        };

        // Check login status on page load
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            console.log("Already logged in. Initializing app.");
            loginOverlay.classList.add('hidden');
            mainApp.classList.remove('hidden');
            // Initial call to router
            router();
        } else {
             console.log("Not logged in. Showing login form.");
        }
    }

    // --- Page Initializers ---
    async function initDashboard() {
      const [sTotalUsers, sNewUsers, sTotalItems, sRedeemed, sTotalEvents, sTotalCodes] = ['statTotalUsers', 'statNewUsersToday', 'statTotalItems', 'statRedeemedItems', 'statTotalEvents', 'statTotalCodes'].map(id => document.getElementById(id));
      const userLevelChartCtx = document.getElementById('userLevelChart').getContext('2d');
      const pointStatsChartCtx = document.getElementById('pointStatsChart').getContext('2d');
      try {
        const data = await fetchData('getDashboardData');
        const userMap = new Map(data.users.map(u => [u.lineId, u.name || u.lineId]));
        sTotalUsers.textContent = data.users.length;
        const todayStr = new Date().toDateString();
        sNewUsers.textContent = `+${data.users.filter(u => u.signupDate && new Date(u.signupDate).toDateString() === todayStr).length} วันนี้`;
        sTotalItems.textContent = data.items.length;
        sRedeemed.textContent = `แลกแล้ว ${data.allHistory.filter(h => h.type === 'redeem').length} ครั้ง`;
        sTotalEvents.textContent = data.events.length;
        sTotalCodes.textContent = `${data.codes.length} โค้ด`;

        const levelCounts = data.users.reduce((acc, user) => { acc[user.level] = (acc[user.level] || 0) + 1; return acc; }, { MEMBER: 0, VIP: 0, SUPER: 0 });
        if (window.userLevelChartInstance) window.userLevelChartInstance.destroy();
        window.userLevelChartInstance = new Chart(userLevelChartCtx, { type: 'bar', data: { labels: ['MEMBER', 'VIP', 'SUPER'], datasets: [{ label: 'จำนวน', data: [levelCounts.MEMBER, levelCounts.VIP, levelCounts.SUPER], backgroundColor: ['#a7d3f2', '#61a6d9', '#1e75b9'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });

        const { earned, spent } = data.allHistory.reduce((acc, h) => { if (h.amount > 0) acc.earned += h.amount; else acc.spent += Math.abs(h.amount); return acc; }, { earned: 0, spent: 0 });
        if (window.pointStatsChartInstance) window.pointStatsChartInstance.destroy();
        window.pointStatsChartInstance = new Chart(pointStatsChartCtx, { type: 'doughnut', data: { labels: ['ได้รับ', 'ใช้ไป'], datasets: [{ data: [earned, spent], backgroundColor: ['#36d399', '#f87272'] }] }, options: { responsive: true, maintainAspectRatio: false } });
      } catch (e) { /* Error already handled by fetchData */ }
    }

    async function initUsers() {
      const tableBody = document.getElementById('userTableBody');
      const searchInput = document.getElementById('userSearchInput');
      const searchBtn = document.getElementById('userSearchBtn');
      document.getElementById('addUserBtn').onclick = () => showUserFormModal();
      searchBtn.onclick = () => loadUsers(searchInput.value);
      searchInput.addEventListener('keypress', e => e.key === 'Enter' && searchBtn.click());
      await loadUsers();
      async function loadUsers(query) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4"><div class="loading-spinner mx-auto"></div></td></tr>`; try { const users = await fetchData('getUsers', { query }); renderUserTable(users); } catch (e) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-error">Load failed</td></tr>`; } }
      function renderUserTable(users) {
        if (!users.length) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4">ไม่พบข้อมูล</td></tr>`; return; }
        tableBody.innerHTML = users.map(u => `<tr><td>${u.lineId}</td><td>${u.name}</td><td>${u.phone}</td><td>${u.point}</td><td><span class="badge ${u.level === 'SUPER' ? 'badge-primary' : u.level === 'VIP' ? 'badge-secondary' : 'badge-ghost'}">${u.level}</span></td><td>${(u.tags || []).map(t => `<span class="badge badge-outline">${t}</span>`).join(' ')}</td><td><button class="btn btn-xs btn-info edit-user-btn" data-id='${u.lineId}'>Edit</button> <button class="btn btn-xs btn-error delete-user-btn" data-id='${u.lineId}'>Del</button></td></tr>`).join('');
        tableBody.querySelectorAll('.edit-user-btn').forEach(b => b.onclick = async () => { try { const user = await fetchData('getUserInfo', { lineId: b.dataset.id }); showUserFormModal(user); } catch (e) { } });
        tableBody.querySelectorAll('.delete-user-btn').forEach(b => b.onclick = () => deleteUser(b.dataset.id));
      }
      function showUserFormModal(user) { const isEdit = !!user; document.getElementById('dataFormModalTitle').textContent = isEdit ? 'Edit User' : 'Add User'; const form = document.getElementById('formFields'); form.innerHTML = `<input type="text" id="formLineId" placeholder="Line ID" class="input input-bordered" ${isEdit ? 'readonly' : 'required'} value="${isEdit ? user.id : ''}" /><input type="text" id="formName" placeholder="Name" class="input input-bordered" required value="${isEdit ? user.name : ''}" /><input type="tel" id="formPhone" placeholder="Phone" class="input input-bordered" value="${isEdit ? user.phone : ''}" /><input type="number" id="formPoint" placeholder="Points" class="input input-bordered" required value="${isEdit ? user.point : 0}" /><input type="text" id="formTags" placeholder="Tags (comma separated)" class="input input-bordered" value="${isEdit ? (user.tags || []).join(', ') : ''}" />`; document.getElementById('dataFormModal').showModal(); document.getElementById('formSaveBtn').onclick = () => saveUser(isEdit, user); document.getElementById('formCancelBtn').onclick = () => document.getElementById('dataFormModal').close(); }
      async function saveUser(isEdit, originalUser) { const data = { lineId: document.getElementById('formLineId').value.trim(), name: document.getElementById('formName').value.trim(), phone: document.getElementById('formPhone').value.trim(), point: parseInt(document.getElementById('formPoint').value), tags: document.getElementById('formTags').value.split(',').map(t => t.trim()).filter(Boolean) }; if (!data.lineId || !data.name) return showAlert('Error', 'Line ID and Name are required.'); document.getElementById('formSaveBtn').classList.add('loading'); try { await postData(isEdit ? 'updateUserAdmin' : 'registerAdmin', data); showAlert('Success', `User ${isEdit ? 'updated' : 'added'}`, () => { document.getElementById('dataFormModal').close(); loadUsers(); }); } finally { document.getElementById('formSaveBtn').classList.remove('loading'); } }
      async function deleteUser(lineId) { if (await showConfirm('Confirm', `Delete user ${lineId}?`)) { try { await postData('deleteUser', { lineId }); showAlert('Success', 'User deleted', () => loadUsers()); } catch (e) { } } }
    }
    
    async function initItems() {
      const tableBody = document.getElementById('itemTableBody');
      document.getElementById('addItemBtn').onclick = () => showItemFormModal();
      await loadItems();
      async function loadItems() { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4"><div class="loading-spinner mx-auto"></div></td></tr>`; try { const items = await fetchData('getItems'); renderItemTable(items); } catch (e) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-error">Load failed</td></tr>`; } }
      function renderItemTable(items) {
        if (!items.length) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">ไม่พบข้อมูล</td></tr>`; return; }
        tableBody.innerHTML = items.map(i => `<tr><td>${i.id}</td><td>${i.name}</td><td>${i.point}</td><td><span class="badge badge-accent">${i.type}</span></td><td>${i.image ? `<img src="${i.image}" class="w-12 h-12 object-cover">` : '-'}</td><td><button class="btn btn-xs btn-info edit-item-btn" data-id='${i.id}'>Edit</button> <button class="btn btn-xs btn-error delete-item-btn" data-id='${i.id}'>Del</button></td></tr>`).join('');
        tableBody.querySelectorAll('.edit-item-btn').forEach(b => b.onclick = () => showItemFormModal(items.find(i => i.id === b.dataset.id)));
        tableBody.querySelectorAll('.delete-item-btn').forEach(b => b.onclick = () => deleteItem(b.dataset.id));
      }
      function showItemFormModal(item) { const isEdit = !!item; document.getElementById('dataFormModalTitle').textContent = isEdit ? 'Edit Item' : 'Add Item'; const form = document.getElementById('formFields'); form.innerHTML = `<input type="text" id="formId" placeholder="ID (auto)" class="input input-bordered" readonly value="${isEdit ? item.id : ''}" /><input type="text" id="formName" placeholder="Name" class="input input-bordered" required value="${isEdit ? item.name : ''}" /><input type="number" id="formPoint" placeholder="Points" class="input input-bordered" required value="${isEdit ? item.point : ''}" /><select id="formType" class="select select-bordered"><option value="digital" ${isEdit && item.type === 'digital' ? 'selected' : ''}>Digital</option><option value="physical" ${isEdit && item.type === 'physical' ? 'selected' : ''}>Physical</option></select><input type="url" id="formImage" placeholder="Image URL" class="input input-bordered" value="${isEdit ? item.image : ''}" />`; document.getElementById('dataFormModal').showModal(); document.getElementById('formSaveBtn').onclick = () => saveItem(isEdit, item); document.getElementById('formCancelBtn').onclick = () => document.getElementById('dataFormModal').close(); }
      async function saveItem(isEdit, originalItem) { const data = { id: originalItem?.id, name: document.getElementById('formName').value.trim(), point: parseInt(document.getElementById('formPoint').value), type: document.getElementById('formType').value, image: document.getElementById('formImage').value.trim() }; if (!data.name) return showAlert('Error', 'Name is required.'); document.getElementById('formSaveBtn').classList.add('loading'); try { await postData(isEdit ? 'updateItem' : 'addItem', data); showAlert('Success', `Item ${isEdit ? 'updated' : 'added'}`, () => { document.getElementById('dataFormModal').close(); loadItems(); }); } finally { document.getElementById('formSaveBtn').classList.remove('loading'); } }
      async function deleteItem(id) { if (await showConfirm('Confirm', `Delete item ${id}?`)) { try { await postData('deleteItem', { id }); showAlert('Success', 'Item deleted', () => loadItems()); } catch (e) { } } }
    }

    async function initWarehouse() {
      const tableBody = document.getElementById('warehouseTableBody'), searchInput = document.getElementById('warehouseSearchInput'), statusFilter = document.getElementById('warehouseStatusFilter'), searchBtn = document.getElementById('warehouseSearchBtn');
      searchBtn.onclick = () => loadWarehouseItems();
      searchInput.addEventListener('keypress', e => e.key === 'Enter' && searchBtn.click());
      statusFilter.onchange = () => loadWarehouseItems();
      await loadWarehouseItems();
      async function loadWarehouseItems() { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4"><div class="loading-spinner mx-auto"></div></td></tr>`; try { const items = await fetchData('getWarehouseItems', { query: searchInput.value, status: statusFilter.value }); renderWarehouseTable(items); } catch (e) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-error">Load failed</td></tr>`; } }
      function renderWarehouseTable(items) {
        if (!items.length) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4">ไม่พบข้อมูล</td></tr>`; return; }
        tableBody.innerHTML = items.map(i => {
          const shippingInfo = i.shippingName ? `<div class="text-xs"><strong>${i.shippingName}</strong><br>${i.shippingPhone}<br>${i.shippingAddress}</div>` : '-';
          const actionBtn = i.status === 'claimed' ? `<div class="text-xs text-success">ยืนยันแล้ว<br>${i.claimDate}</div>` : `<button class="btn btn-xs btn-success claim-item-btn" data-id="${i.warehouseId}">ยืนยัน</button>`;
          return `<tr><td>${i.warehouseId}</td><td>${i.itemName}</td><td class="font-mono text-xs">${i.lineId}</td><td>${shippingInfo}</td><td>${i.redeemDate}</td><td><span class="badge ${i.status === 'claimed' ? 'badge-success' : 'badge-warning'}">${i.status}</span></td><td>${actionBtn}</td></tr>`;
        }).join('');
        tableBody.querySelectorAll('.claim-item-btn').forEach(b => b.onclick = () => claimItem(b.dataset.id));
      }
      async function claimItem(id) { if (await showConfirm('Confirm', `ยืนยันการรับ/จัดส่งสำหรับรายการ ${id}?`)) { try { await postData('claimWarehouseItemAdmin', { warehouseId: id }); showAlert('Success', 'Item status updated', () => loadWarehouseItems()); } catch (e) { } } }
    }

  // --- Event Management ---
    async function initEvents() {
      const tableBody = document.getElementById('eventTableBody');
      const addEventBtn = document.getElementById('addEventBtn');

      addEventBtn.onclick = () => showEventFormModal();
      await loadEvents();

      async function loadEvents() {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="loading-spinner mx-auto"></div> กำลังโหลดข้อมูล...</td></tr>`;
        try {
          const events = await fetchData('getEvents');
          renderEventTable(events);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-error">ไม่สามารถโหลดข้อมูลกิจกรรมได้</td></tr>`;
        }
      }

      function renderEventTable(events) {
        if (events.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-base-content text-opacity-50">ไม่พบกิจกรรม</td></tr>`;
          return;
        }
        tableBody.innerHTML = events.map(event => `
          <tr>
            <td class="font-mono text-xs">${event.id}</td>
            <td>${event.title}</td>
            <td>${event.point}</td>
            <td>
              ${(event.allowedLevels && event.allowedLevels.length > 0) ? event.allowedLevels.map(level => `<span class="badge ${level === 'SUPER' ? 'badge-neutral' : level === 'VIP' ? 'badge-secondary' : 'badge-ghost'} badge-outline mr-1">${level}</span>`).join('') : '<span class="text-base-content text-opacity-50">ทุกคน</span>'}
            </td>
            <td class="max-w-xs  text-ellipsis whitespace-nowrap">${event.desc || '-'}</td>
            <td>
              ${event.image ? `<img src="${event.image}" alt="${event.title}" class="w-16 h-16 object-cover rounded-md border border-base-300">` : '-'}
            </td>
            <td class="whitespace-nowrap">
              <button class="btn btn-sm btn-info btn-square text-white mr-2 edit-event-btn" data-id="${event.id}" aria-label="แก้ไข">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                  <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                </svg>
              </button>
              <button class="btn btn-sm btn-error btn-square text-white delete-event-btn" data-id="${event.id}" aria-label="ลบ">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 01-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                </svg>
              </button>
            </td>
          </tr>
        `).join('');

        tableBody.querySelectorAll('.edit-event-btn').forEach(btn => {
          btn.onclick = () => showEventFormModal(events.find(e => e.id === btn.dataset.id));
        });
        tableBody.querySelectorAll('.delete-event-btn').forEach(btn => {
          btn.onclick = () => deleteEvent(btn.dataset.id);
        });
      }

      function showEventFormModal(event = null) {
        currentEditItem = event;
        dataFormModalTitle.textContent = event ? 'แก้ไขกิจกรรม' : 'เพิ่มกิจกรรมใหม่';

        const checkedLevelsHtml = USER_LEVELS.map(level => `
          <div class="form-control">
            <label class="label cursor-pointer justify-start gap-2">
              <input type="checkbox" id="level_${level}" name="allowedLevels" value="${level}" class="checkbox checkbox-neutral"
                ${event && event.allowedLevels && event.allowedLevels.includes(level) ? 'checked' : ''}>
              <span class="label-text">${level}</span>
            </label>
          </div>
        `).join('');

        formFieldsContainer.innerHTML = `
          <div class="form-control">
            <label class="label"><span class="label-text">ID (ไม่สามารถแก้ไขได้หากมีข้อมูลแล้ว, เว้นว่างเพื่อสร้างอัตโนมัติ)</span></label>
            <input type="text" id="formEventId" placeholder="Auto-generated if empty" class="input input-bordered w-full" ${event ? 'readonly' : ''} value="${event ? event.id : ''}" />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">ชื่อกิจกรรม</span></label>
            <input type="text" id="formEventTitle" placeholder="ชื่อกิจกรรม" class="input input-bordered w-full" value="${event ? event.title : ''}" required />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">พ้อยต์ที่จะได้รับ</span></label>
            <input type="number" id="formEventPoint" placeholder="0" class="input input-bordered w-full" value="${event ? event.point : 0}" required />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">ระดับที่เข้าร่วมได้</span></label>
            <div class="flex flex-wrap gap-x-4">
              ${checkedLevelsHtml}
            </div>
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">รายละเอียดกิจกรรม</span></label>
            <textarea id="formEventDesc" placeholder="รายละเอียด" class="textarea textarea-bordered h-24 w-full">${event ? event.desc : ''}</textarea>
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">URL รูปภาพ (Banner)</span></label>
            <input type="url" id="formEventImage" placeholder="https://example.com/event_banner.png" class="input input-bordered w-full" value="${event ? event.image : ''}" />
          </div>
        `;
        dataFormModal.showModal();

        formSaveBtn.onclick = () => saveEvent(event);
        formCancelBtn.onclick = () => dataFormModal.close();
      }

      async function saveEvent(originalEvent) {
        const id = document.getElementById('formEventId').value.trim();
        const title = document.getElementById('formEventTitle').value.trim();
        const point = parseInt(document.getElementById('formEventPoint').value, 10);
        const desc = document.getElementById('formEventDesc').value.trim();
        const image = document.getElementById('formEventImage').value.trim();

        const allowedLevels = Array.from(document.querySelectorAll('input[name="allowedLevels"]:checked'))
          .map(cb => cb.value);

        if (!title || isNaN(point) || point < 0) {
          showAlert('ข้อผิดพลาด', 'กรุณากรอกชื่อกิจกรรมและพ้อยต์ให้ถูกต้อง');
          return;
        }

        formSaveBtn.disabled = true;
        try {
          let message;
          if (originalEvent) {
            message = await postData('updateEvent', { id: originalEvent.id, title, point, desc, image, allowedLevels });
          } else {
            message = await postData('addEvent', { id: id || undefined, title, point, desc, image, allowedLevels });
          }
          showAlert('สำเร็จ', message, () => {
            dataFormModal.close();
            loadEvents();
          });
        } catch (error) {
          // Error handled by postData
        } finally {
          formSaveBtn.disabled = false;
        }
      }

      async function deleteEvent(id) {
        const confirmed = await showConfirm('ยืนยันการลบ', `คุณแน่ใจหรือไม่ที่จะลบกิจกรรม ID: ${id}?`);
        if (!confirmed) return;

        try {
          const message = await postData('deleteEvent', { id });
          showAlert('สำเร็จ', message, () => loadEvents());
        } catch (error) {
          // Error handled by postData
        }
      }
    }

    // --- Code Management ---
    async function initCodes() {
      const tableBody = document.getElementById('codeTableBody');
      const addCodeBtn = document.getElementById('addCodeBtn');

      addCodeBtn.onclick = () => showCodeFormModal();
      await loadCodes();

      async function loadCodes() {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="loading-spinner mx-auto"></div> กำลังโหลดข้อมูล...</td></tr>`;
        try {
          const codes = await fetchData('getCodes');
          renderCodeTable(codes);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-error">ไม่สามารถโหลดข้อมูลโค้ดได้</td></tr>`;
        }
      }

      function renderCodeTable(codes) {
        if (codes.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-base-content text-opacity-50">ไม่พบโค้ด</td></tr>`;
          return;
        }
        tableBody.innerHTML = codes.map(code => `
          <tr>
            <td class="font-mono text-xs">${code.id}</td>
            <td>${code.title}</td>
            <td>${code.point}</td>
            <td class="max-w-xs  text-ellipsis whitespace-nowrap">${code.desc || '-'}</td>
            <td class="whitespace-nowrap">
              <button class="btn btn-sm btn-info btn-square text-white mr-2 edit-code-btn" data-id="${code.id}" aria-label="แก้ไข">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                  <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                </svg>
              </button>
              <button class="btn btn-sm btn-error btn-square text-white delete-code-btn" data-id="${code.id}" aria-label="ลบ">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 01-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                </svg>
              </button>
            </td>
          </tr>
        `).join('');

        tableBody.querySelectorAll('.edit-code-btn').forEach(btn => {
          btn.onclick = () => showCodeFormModal(codes.find(c => c.id === btn.dataset.id));
        });
        tableBody.querySelectorAll('.delete-code-btn').forEach(btn => {
          btn.onclick = () => deleteCode(btn.dataset.id);
        });
      }

      function showCodeFormModal(code = null) {
        currentEditItem = code;
        dataFormModalTitle.textContent = code ? 'แก้ไขโค้ด' : 'เพิ่มโค้ดใหม่';
        formFieldsContainer.innerHTML = `
          <div class="form-control">
            <label class="label"><span class="label-text">ID (ค่า QR Code / รหัสโค้ด, ไม่สามารถแก้ไขได้)</span></label>
            <input type="text" id="formCodeId" placeholder="ID สำหรับ QR Code / รหัส" class="input input-bordered w-full" ${code ? 'readonly' : 'required'} value="${code ? code.id : ''}" />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">ชื่อโค้ด</span></label>
            <input type="text" id="formCodeTitle" placeholder="ชื่อโค้ด (เช่น โค้ดรับพ้อยต์จากงาน)" class="input input-bordered w-full" value="${code ? code.title : ''}" required />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">พ้อยต์ที่จะได้รับ</span></label>
            <input type="number" id="formCodePoint" placeholder="0" class="input input-bordered w-full" value="${code ? code.point : 0}" required />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">รายละเอียดโค้ด</span></label>
            <textarea id="formCodeDesc" placeholder="รายละเอียด" class="textarea textarea-bordered h-24 w-full">${code ? code.desc : ''}</textarea>
          </div>
        `;
        dataFormModal.showModal();

        formSaveBtn.onclick = () => saveCode(code);
        formCancelBtn.onclick = () => dataFormModal.close();
      }

      async function saveCode(originalCode) {
        const id = document.getElementById('formCodeId').value.trim();
        const title = document.getElementById('formCodeTitle').value.trim();
        const point = parseInt(document.getElementById('formCodePoint').value, 10);
        const desc = document.getElementById('formCodeDesc').value.trim();

        if (!id || !title || isNaN(point) || point < 0) {
          showAlert('ข้อผิดพลาด', 'กรุณากรอก ID, ชื่อโค้ด และพ้อยต์ให้ถูกต้อง');
          return;
        }

        formSaveBtn.disabled = true;
        try {
          let message;
          if (originalCode) {
            message = await postData('updateCode', { id: originalCode.id, title, point, desc });
          } else {
            message = await postData('addCode', { id, title, point, desc });
          }
          showAlert('สำเร็จ', message, () => {
            dataFormModal.close();
            loadCodes();
          });
        } catch (error) {
          // Error handled by postData
        } finally {
          formSaveBtn.disabled = false;
        }
      }

      async function deleteCode(id) {
        const confirmed = await showConfirm('ยืนยันการลบ', `คุณแน่ใจหรือไม่ที่จะลบโค้ด ID: ${id}?`);
        if (!confirmed) return;

        try {
          const message = await postData('deleteCode', { id });
          showAlert('สำเร็จ', message, () => loadCodes());
        } catch (error) {
          // Error handled by postData
        }
      }
    }

    // --- History View ---
    async function initHistory() {
      const tableBody = document.getElementById('historyTableBody');
      const filterLineIdInput = document.getElementById('historySearchLineId');
      const filterTypeSelect = document.getElementById('historyFilterType');
      const filterStartDateInput = document.getElementById('historyStartDate');
      const filterEndDateInput = document.getElementById('historyEndDate');
      const filterBtn = document.getElementById('historyFilterBtn');
      const resetBtn = document.getElementById('historyResetBtn');

      filterBtn.onclick = () => loadHistory();
      resetBtn.onclick = () => {
        filterLineIdInput.value = '';
        filterTypeSelect.value = '';
        filterStartDateInput.value = '';
        filterEndDateInput.value = '';
        loadHistory();
      };

      await loadHistory();

      async function loadHistory() {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto"></div> กำลังโหลดข้อมูล...</td></tr>`;
        try {
          const filters = {
            lineId: filterLineIdInput.value.trim(),
            type: filterTypeSelect.value,
            startDate: filterStartDateInput.value,
            endDate: filterEndDateInput.value
          };
          const history = await fetchData('getAllHistory', filters);
          renderHistoryTable(history);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-error">ไม่สามารถโหลดประวัติได้</td></tr>`;
        }
      }

      function renderHistoryTable(history) {
        if (history.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-base-content text-opacity-50">ไม่พบประวัติการทำรายการ</td></tr>`;
          return;
        }
        tableBody.innerHTML = history.map(record => `
          <tr>
            <td class="font-mono text-xs">${record.lineId}</td>
            <td>${record.type}</td>
            <td>${record.detail}</td>
            <td class="${record.amount < 0 ? 'text-error' : 'text-success'} font-bold">${record.amount > 0 ? '+' : ''}${record.amount}</td>
            <td>${record.date}</td>
            <td>${record.refId || '-'}</td>
          </tr>
        `).join('');
      }
    }

    // --- Settings View ---
    async function initSettings() {
      const vipPointsInput = document.getElementById('vipPoints');
      const superPointsInput = document.getElementById('superPoints');
      const saveLevelSettingsBtn = document.getElementById('saveLevelSettingsBtn');
      const levelSettingsForm = document.getElementById('levelSettingsForm');

      // Load current settings
      try {
        const config = await fetchData('getLevelConfig');
        if (config) {
          vipPointsInput.value = parseInt(config.VIP_points || 0, 10);
          superPointsInput.value = parseInt(config.SUPER_points || 0, 10);
          levelConfig = {
            VIP_points: parseInt(config.VIP_points || 0, 10),
            SUPER_points: parseInt(config.SUPER_points || 0, 10),
          };
        }
      } catch (error) {
        console.error("Error loading level settings:", error);
        showAlert('ข้อผิดพลาด', 'ไม่สามารถโหลดการตั้งค่าระดับได้');
      }

      // Save settings
      levelSettingsForm.onsubmit = async (e) => {
        e.preventDefault();
        saveLevelSettingsBtn.disabled = true;

        const vipPoints = parseInt(vipPointsInput.value, 10);
        const superPoints = parseInt(superPointsInput.value, 10);

        if (isNaN(vipPoints) || vipPoints < 0 || isNaN(superPoints) || superPoints < 0) {
          showAlert('ข้อผิดพลาด', 'กรุณากรอกจำนวนแต้มให้ถูกต้อง (ตัวเลขที่ไม่ติดลบ)');
          saveLevelSettingsBtn.disabled = false;
          return;
        }
        if (vipPoints >= superPoints && superPoints !== 0) { // Allow SUPER=0 if VIP=0
          showAlert('ข้อผิดพลาด', 'แต้มสำหรับระดับ SUPER ต้องมากกว่าแต้มสำหรับระดับ VIP');
          saveLevelSettingsBtn.disabled = false;
          return;
        }


        try {
          const message = await postData('setLevelConfig', { VIP_points: vipPoints, SUPER_points: superPoints });
          showAlert('สำเร็จ', message, () => {
            // Update global levelConfig after successful save
            levelConfig = { VIP_points: vipPoints, SUPER_points: superPoints };
          });
        } catch (error) {
          // Error handled by postData
        } finally {
          saveLevelSettingsBtn.disabled = false;
        }
      };
    }


    async function initWarehouse() {
      const tableBody = document.getElementById('warehouseTableBody');
      const searchInput = document.getElementById('warehouseSearchInput');
      const statusFilter = document.getElementById('warehouseStatusFilter');
      const searchBtn = document.getElementById('warehouseSearchBtn');

      searchBtn.onclick = () => loadWarehouseItems();
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchBtn.click();
      });
      statusFilter.onchange = () => loadWarehouseItems();

      await loadWarehouseItems();

      async function loadWarehouseItems() {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="loading-spinner mx-auto"></div></td></tr>`;
        try {
          const items = await fetchData('getWarehouseItems', { 
              query: searchInput.value.trim(), 
              status: statusFilter.value 
          });
          renderWarehouseTable(items);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-error">Failed to load warehouse items.</td></tr>`;
        }
      }

      function renderWarehouseTable(items) {
        if (!items || items.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4">No items found.</td></tr>`;
          return;
        }
        tableBody.innerHTML = items.map(item => {
          const shippingInfo = item.shippingName 
            ? `<div class="text-xs"><strong>${item.shippingName}</strong><br>${item.shippingPhone}<br><div class="whitespace-normal">${item.shippingAddress}</div></div>` 
            : '-';
          const actionBtn = item.status === 'claimed'
            ? `<div class="text-xs text-success font-semibold">ยืนยันแล้ว<br>${item.claimDate}</div>`
            : `<button class="btn btn-xs btn-success claim-item-btn" data-id="${item.warehouseId}">ยืนยัน</button>`;
          
          return `
            <tr>
              <td class="font-mono text-xs">${item.warehouseId}</td>
              <td>${item.itemName}</td>
              <td class="font-mono text-xs">${item.lineId}</td>
              <td>${shippingInfo}</td>
              <td>${item.redeemDate}</td>
              <td><span class="badge ${item.status === 'claimed' ? 'badge-success' : 'badge-warning'}">${item.status.replace('_', ' ')}</span></td>
              <td>${actionBtn}</td>
            </tr>`;
        }).join('');

        tableBody.querySelectorAll('.claim-item-btn').forEach(b => {
          b.onclick = () => claimItem(b.dataset.id);
        });
      }

      async function claimItem(id) {
        if (await showConfirm('Confirm Action', `ยืนยันการรับ/จัดส่งสำหรับรายการ ${id}?`)) {
          try {
            await postData('claimWarehouseItemAdmin', { warehouseId: id });
            showAlert('Success', 'Item status updated successfully!', () => loadWarehouseItems());
          } catch (e) { /* Error is already handled by postData */ }
        }
      }
    }


    // --- App Start ---
    document.addEventListener('DOMContentLoaded', () => {
      handleLogin();
      window.addEventListener('hashchange', router);
    });

</script>


</body>
</html>
