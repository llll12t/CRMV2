<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Admin</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind CSS Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'thm-primary': '#2563eb', // Blue 600
            'thm-primary-dark': '#1d4ed8', // Blue 700
            'thm-secondary': '#64748b', // Slate 500
            'thm-bg': '#f1f5f9',       // Slate 100 (Main Background)
            'thm-card-bg': '#ffffff', // White
            'thm-text': '#1e293b',     // Slate 800
            'thm-text-light': '#64748b',// Slate 500
            'thm-border': '#e2e8f0',  // Slate 200
            'thm-success': '#16a34a', // Green 600
            'thm-error': '#dc2626',   // Red 600
            'thm-warning': '#f59e0b' // Amber 500
          },
        },
      },
    };
  </script>
  
  <!-- Load config before main script -->
  <script src="config-admin.js"></script>
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    body { background-color: #f1f5f9; font-family: 'Inter', 'Kanit', sans-serif; color: #1e293b; }
    #qr-shaded-region{ border-width:0 !important ; }
    .hidden { display: none !important; }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #2563eb; /* thm-primary */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .page-loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      padding: 2rem;
      color: #64748b; /* thm-text-light */
    }
    /* Active Nav Link Style */
    .nav-link.active {
      background-color: #eff6ff; /* blue-50 */
      color: #1d4ed8; /* blue-700 */
      font-weight: 600;
    }
  </style>
</head>

<body>
  <!-- Login Overlay -->
  <div id="login-overlay" class="fixed inset-0 bg-thm-bg flex items-center justify-center z-50">
      <div class="w-full max-w-sm p-8 bg-thm-card-bg rounded-xl shadow-lg border border-thm-border">
          <h2 class="text-center text-2xl font-bold text-thm-text mb-6">Admin Login</h2>
          <div id="login-error" class="text-thm-error text-center text-sm mb-4 hidden"></div>
          <div class="space-y-4">
              <div>
                  <label for="username" class="block text-sm font-medium text-thm-text-light mb-1">Username</label>
                  <input type="text" id="username" placeholder="username" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none transition-shadow" />
              </div>
              <div>
                  <label for="password" class="block text-sm font-medium text-thm-text-light mb-1">Password</label>
                  <input type="password" id="password" placeholder="password" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none transition-shadow" />
              </div>
              <div class="pt-2">
                  <button id="loginBtn" class="w-full bg-thm-primary text-white font-bold py-2.5 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors disabled:bg-gray-400">Login</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Main App Content (hidden until logged in) -->
  <div id="main-app" class="flex h-screen bg-thm-bg hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-thm-card-bg border-r border-thm-border flex-shrink-0 lg:flex flex-col fixed lg:relative h-full z-40 -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <div class="p-4 border-b border-thm-border">
            <h2 class="text-2xl font-bold text-thm-primary">CRM Panel</h2>
        </div>
        <nav class="flex-grow p-4">
            <ul id="main-menu" class="space-y-1">
                <!-- Menu items will be generated here -->
            </ul>
        </nav>
    </aside>
    
    <!-- Backdrop for mobile -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/30 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="flex items-center justify-between bg-thm-card-bg shadow-sm p-4 sticky top-0 z-20 border-b border-thm-border">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="lg:hidden text-thm-text-light mr-4 p-2 rounded-md hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-xl font-bold text-thm-text" id="pageTitle">ภาพรวม</h1>
            </div>
            <button id="logoutBtn" class="bg-transparent text-thm-text-light font-semibold py-2 px-4 rounded-lg hover:bg-red-50 hover:text-red-600 transition-colors">Logout</button>
        </header>
        <main class="flex-grow p-4 sm:p-6 lg:p-8 overflow-y-auto">
            <div id="app-container" class="transition-opacity duration-300">
                <div class="page-loader">
                    <div class="loading-spinner"></div>
                    <p>กำลังโหลด...</p>
                </div>
            </div>
        </main>
    </div>
  </div>

  <!-- MODALS -->
  <dialog id="customAlertDialog" class="p-0 rounded-xl shadow-xl w-full max-w-sm backdrop:bg-black/50"><div class="p-6 bg-thm-card-bg rounded-xl"><h3 id="customAlertTitle" class="font-bold text-lg mb-3 text-center text-thm-text"></h3><p id="customAlertMessage" class="py-4 whitespace-pre-line text-center text-thm-text-light"></p><div class="mt-4"><button onclick="this.closest('dialog').close()" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors">ตกลง</button></div></div></dialog>
  <dialog id="customConfirmDialog" class="p-0 rounded-xl shadow-xl w-full max-w-sm backdrop:bg-black/50"><div class="p-6 bg-thm-card-bg rounded-xl"><h3 id="customConfirmTitle" class="font-bold text-lg mb-3 text-center text-thm-text"></h3><p id="customConfirmMessage" class="py-4 whitespace-pre-line text-center text-thm-text-light"></p><div class="mt-4 flex gap-4"><button id="customConfirmCancelButton" class="flex-1 border border-thm-border text-thm-text font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors">ยกเลิก</button><button id="customConfirmConfirmButton" class="flex-1 bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors">ยืนยัน</button></div></div></dialog>
  <dialog id="dataFormModal" class="p-0 rounded-xl shadow-xl w-full max-w-lg backdrop:bg-black/50"><div class="bg-thm-card-bg rounded-xl"><h3 id="dataFormModalTitle" class="font-bold text-lg p-6 border-b border-thm-border text-thm-text"></h3><form id="dataForm" onsubmit="event.preventDefault()"><div id="formFields" class="p-6 grid grid-cols-1 gap-4"></div><div class="p-6 flex justify-end gap-4 border-t border-thm-border"><button type="button" id="formCancelBtn" class="border border-thm-border text-thm-text font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors">ยกเลิก</button><button type="submit" id="formSaveBtn" class="bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors disabled:bg-gray-400">บันทึก</button></div></form></div></dialog>
  <dialog id="qrCodeModal" class="p-0 rounded-xl shadow-xl w-full max-w-sm backdrop:bg-black/50"><div class="p-6 bg-thm-card-bg rounded-xl text-center"><h3 id="qrCodeModalTitle" class="font-bold text-lg mb-3 text-thm-text">QR Code</h3><div id="qrCodeCanvas" class="flex justify-center p-4 bg-white rounded-lg my-4 border border-thm-border"></div><p class="text-sm text-thm-text-light">คลิกขวาที่รูปเพื่อบันทึก</p><div class="mt-4"><button onclick="this.closest('dialog').close()" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors">ปิด</button></div></div></dialog>


  <!-- TEMPLATES -->
  <template id="view-dashboard">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-thm-card-bg p-6 rounded-xl shadow-sm border border-thm-border"><p class="text-sm font-medium text-thm-text-light">ผู้ใช้ทั้งหมด</p><div id="statTotalUsers" class="text-3xl font-bold mt-1">0</div><p id="statNewUsersToday" class="text-sm text-thm-success mt-1"></p></div>
        <div class="bg-thm-card-bg p-6 rounded-xl shadow-sm border border-thm-border"><p class="text-sm font-medium text-thm-text-light">ของรางวัล</p><div id="statTotalItems" class="text-3xl font-bold mt-1">0</div><p id="statRedeemedItems" class="text-sm text-thm-text-light mt-1"></p></div>
        <div class="bg-thm-card-bg p-6 rounded-xl shadow-sm border border-thm-border"><p class="text-sm font-medium text-thm-text-light">กิจกรรม & โค้ด</p><div id="statTotalEvents" class="text-3xl font-bold mt-1">0</div><p id="statTotalCodes" class="text-sm text-thm-text-light mt-1"></p></div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-thm-card-bg p-6 rounded-xl shadow-sm border border-thm-border"><h3 class="font-bold text-thm-text mb-4">ผู้ใช้ตามระดับ (LV)</h3><div class="relative h-64"><canvas id="userLevelChart"></canvas></div></div>
        <div class="bg-thm-card-bg p-6 rounded-xl shadow-sm border border-thm-border"><h3 class="font-bold text-thm-text mb-4">สถิติพ้อยต์ (รับ/ใช้)</h3><div class="relative h-64"><canvas id="pointStatsChart"></canvas></div></div>
    </div>
  </template>
  
  <template id="view-users">
      <div class="flex flex-wrap items-center gap-4 mb-6">
          <input type="text" id="userSearchInput" placeholder="ค้นหา (LINE ID / ชื่อ / เบอร์โทร)" class="flex-grow w-full md:w-auto px-4 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none" />
          <button id="userSearchBtn" class="bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark">ค้นหา</button>
          <button id="addUserBtn" class="bg-thm-secondary text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">เพิ่มผู้ใช้ใหม่</button>
      </div>
      <div class="bg-thm-card-bg rounded-xl shadow-sm border border-thm-border overflow-x-auto">
          <table class="w-full text-sm text-left"><thead class="text-xs text-thm-text-light uppercase bg-gray-50"><tr><th class="px-6 py-3">LINE ID</th><th class="px-6 py-3">ชื่อ</th><th class="px-6 py-3">เบอร์โทร</th><th class="px-6 py-3">พ้อยต์</th><th class="px-6 py-3">ระดับ</th><th class="px-6 py-3">Tags</th><th class="px-6 py-3 text-right">จัดการ</th></tr></thead><tbody id="userTableBody"></tbody></table>
      </div>
  </template>

  <template id="view-add-points">
    <div class="bg-thm-card-bg shadow-sm max-w-2xl mx-auto rounded-xl border border-thm-border">
        <form id="addPointsForm" onsubmit="event.preventDefault()">
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-lg font-semibold text-thm-text mb-2">1. ระบุลูกค้า</label>
                    <input type="text" id="addPointsIdentifier" placeholder="กรอก Line ID, เบอร์โทร หรือสแกน QR ลูกค้า" class="w-full px-4 py-3 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none text-lg" required />
                </div>
                <div>
                    <label class="block text-lg font-semibold text-thm-text mb-2">2. เลือกวิธีให้แต้ม</label>
                    <div class="flex border border-thm-border rounded-lg p-1 bg-gray-100">
                        <button type="button" class="flex-1 py-2 rounded-md text-sm font-semibold transition-colors tab-button active" data-mode="product">จากรายการสินค้า</button>
                        <button type="button" class="flex-1 py-2 rounded-md text-sm font-semibold transition-colors tab-button" data-mode="manual">กรอกแต้มเอง</button>
                    </div>
                </div>
                <div id="productModeSection" class="space-y-4">
                    <h4 class="font-semibold text-thm-text border-b border-thm-border pb-2">รายการสินค้าในบิล</h4>
                    <div id="billItemsContainer" class="space-y-2 max-h-60 overflow-y-auto pr-2"><p class="text-center text-thm-text-light">ยังไม่มีรายการ</p></div>
                    <div class="text-right text-xl font-bold">แต้มที่จะได้รับรวม: <span id="totalPointsDisplay" class="text-thm-primary">0</span> แต้ม</div>
                    <div class="flex items-end gap-2 p-4 bg-gray-50 rounded-lg border border-thm-border">
                        <div class="flex-grow"><label class="text-xs font-medium text-thm-text-light">เลือกสินค้า</label><select id="productList" class="w-full mt-1 px-3 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none"><option disabled selected>กำลังโหลด...</option></select></div>
                        <div><label class="text-xs font-medium text-thm-text-light">จำนวน</label><input type="number" id="productQuantity" value="1" min="1" class="w-20 mt-1 px-3 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none" /></div>
                        <button type="button" id="addItemToBillBtn" class="bg-thm-secondary text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">เพิ่ม</button>
                    </div>
                </div>
                <div id="manualModeSection" class="space-y-4 hidden">
                    <div><label class="block font-medium text-thm-text mb-1">จำนวนแต้ม</label><input type="number" id="addPointsAmount" placeholder="เช่น 50" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" min="1" /></div>
                    <div><label class="block font-medium text-thm-text mb-1">เหตุผล</label><input type="text" id="addPointsReason" placeholder="เช่น ของขวัญพิเศษ" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" /></div>
                </div>
            </div>
            <div class="p-6 bg-gray-50 border-t border-thm-border rounded-b-xl"><button type="submit" id="addPointsSubmitBtn" class="w-full bg-thm-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-thm-primary-dark text-lg">ยืนยันและให้แต้ม</button></div>
        </form>
    </div>
  </template>

  <!-- Table View Template -->
  <template id="view-table-generic">
    <div class="text-right mb-6"><button id="addNewBtn" class="bg-thm-secondary text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">เพิ่มรายการใหม่</button></div>
    <div class="bg-thm-card-bg rounded-xl shadow-sm border border-thm-border overflow-x-auto">
        <table class="w-full text-sm text-left"><thead class="text-xs text-thm-text-light uppercase bg-gray-50"><tr id="tableHeaderRow"></tr></thead><tbody id="tableBody"></tbody></table>
    </div>
  </template>

  <template id="view-warehouse">
      <div class="flex flex-wrap gap-4 mb-6"><input type="text" id="warehouseSearchInput" placeholder="ค้นหา..." class="flex-grow w-full md:w-auto px-4 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none" /><select id="warehouseStatusFilter" class="w-full md:w-auto px-3 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none"><option value="">-- ทุกสถานะ --</option><option value="pending_claim" selected>รอรับ/จัดส่ง</option><option value="claimed">รับแล้ว</option></select><button id="warehouseSearchBtn" class="bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark">ค้นหา</button></div>
      <div class="bg-thm-card-bg rounded-xl shadow-sm border border-thm-border overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-thm-text-light uppercase bg-gray-50"><tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">ของรางวัล</th><th class="px-6 py-3">ผู้ใช้</th><th class="px-6 py-3">ข้อมูลจัดส่ง</th><th class="px-6 py-3">วันที่แลก</th><th class="px-6 py-3">สถานะ</th><th class="px-6 py-3 text-right">จัดการ</th></tr></thead><tbody id="warehouseTableBody"></tbody></table></div>
  </template>
  
  <template id="view-scan-claim">
      <div class="bg-thm-card-bg shadow-sm max-w-lg mx-auto rounded-xl border border-thm-border">
          <div class="p-6 items-center text-center">
              <div id="qr-reader" class="w-full h-64 bg-gray-100 rounded-lg mb-4 border-2 border-dashed border-gray-300 overflow-hidden"></div>
              <div class="space-y-2">
                  <button id="startScanBtn" class="w-full bg-thm-primary text-white font-bold py-2.5 px-4 rounded-lg hover:bg-thm-primary-dark">เริ่มสแกน</button>
                  <button id="stopScanBtn" class="w-full bg-transparent text-thm-text-light font-semibold py-2.5 px-4 rounded-lg hover:bg-gray-100 hidden">หยุดสแกน</button>
              </div>
              <div id="scan-result" class="mt-4 text-lg font-semibold text-thm-text"></div>
          </div>
      </div>
  </template>

  <template id="view-history">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 items-end">
        <input type="text" id="historySearchLineId" placeholder="ค้นหาด้วย Line ID" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none" />
        <select id="historyFilterType" class="w-full px-3 py-2 bg-white border border-thm-border rounded-lg focus:ring-2 focus:ring-thm-primary focus:outline-none"><option value="">-- ประเภททั้งหมด --</option><option value="purchase">การซื้อสินค้า</option><option value="admin_add">Admin เพิ่มแต้ม</option><option value="checkin">เช็คอิน</option><option value="event">กิจกรรม</option><option value="code">โค้ด</option><option value="redeem">แลกของ</option><option value="transfer_in">รับโอน</option><option value="transfer_out">โอนออก</option></select>
        <input type="date" id="historyStartDate" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" placeholder="จากวันที่">
        <input type="date" id="historyEndDate" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" placeholder="ถึงวันที่">
        <div class="flex gap-2"><button id="historyFilterBtn" class="flex-grow bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark">กรอง</button><button id="historyResetBtn" class="flex-grow border border-thm-border text-thm-text font-semibold py-2 px-4 rounded-lg hover:bg-gray-100">รีเซ็ต</button></div>
      </div>
      <div class="bg-thm-card-bg rounded-xl shadow-sm border border-thm-border overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-thm-text-light uppercase bg-gray-50"><tr><th class="px-6 py-3">Line ID</th><th class="px-6 py-3">ประเภท</th><th class="px-6 py-3">รายละเอียด</th><th class="px-6 py-3">จำนวน</th><th class="px-6 py-3">วันที่</th><th class="px-6 py-3">ID อ้างอิง</th></tr></thead><tbody id="historyTableBody"></tbody></table></div>
  </template>
  
  <template id="view-settings">
      <div class="bg-thm-card-bg shadow-sm max-w-lg mx-auto rounded-xl border border-thm-border">
          <div class="p-6">
              <h3 class="font-bold text-lg text-thm-text">การตั้งค่าระดับผู้ใช้</h3>
              <p class="text-sm text-thm-text-light mb-4">กำหนดแต้มขั้นต่ำเพื่อเลื่อนระดับ</p>
              <form id="levelSettingsForm" onsubmit="event.preventDefault()" class="space-y-4">
                  <div>
                      <label for="vipPoints" class="block text-sm font-medium text-thm-text mb-1">แต้มสำหรับระดับ VIP</label>
                      <input type="number" id="vipPoints" placeholder="0" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required min="0" />
                  </div>
                  <div>
                      <label for="superPoints" class="block text-sm font-medium text-thm-text mb-1">แต้มสำหรับระดับ SUPER</label>
                      <input type="number" id="superPoints" placeholder="0" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required min="0" />
                  </div>
                  <div class="pt-2">
                      <button type="submit" id="saveLevelSettingsBtn" class="w-full bg-thm-primary text-white font-bold py-2.5 px-4 rounded-lg hover:bg-thm-primary-dark">บันทึกการตั้งค่า</button>
                  </div>
              </form>
          </div>
      </div>
  </template>

<script>
    // ==========================================================
    // ===                 GLOBAL VARIABLES                   ===
    // ==========================================================
    const mainApp = document.getElementById('main-app');
    const appContainer = document.getElementById('app-container');
    const pageTitle = document.getElementById('pageTitle');

    const dataFormModal = document.getElementById('dataFormModal');
    const dataFormModalTitle = document.getElementById('dataFormModalTitle');
    const formFieldsContainer = document.getElementById('formFields');
    const formSaveBtn = document.getElementById('formSaveBtn');
    const formCancelBtn = document.getElementById('formCancelBtn');
    
    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');
    
    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        sidebarBackdrop.classList.toggle('hidden');
    }

    const USER_LEVELS = ['MEMBER', 'VIP', 'SUPER'];
    let levelConfig = { VIP_points: 100, SUPER_points: 500 };
    
    const MENU_STRUCTURE = [
        { title: 'เมนูหลัก' },
        { name: 'ภาพรวม', href: '#dashboard' },
        { name: 'จัดการผู้ใช้', href: '#users' },
        { name: 'เพิ่มแต้ม (POS)', href: '#add-points' },
        { title: 'จัดการข้อมูล' },
        { name: 'จัดการสินค้า', href: '#products' },
        { name: 'จัดการของรางวัล', href: '#items' },
        { name: 'จัดการกิจกรรม', href: '#events' },
        { name: 'จัดการโค้ด', href: '#codes' },
        { title: 'การดำเนินงาน' },
        { name: 'คลังสินค้า', href: '#warehouse' },
        { name: 'สแกนรับของ', href: '#scan-claim' },
        { name: 'ประวัติฯ', href: '#history' },
        { title: 'ตั้งค่า' },
        { name: 'ตั้งค่าระบบ', href: '#settings' },
    ];

    // ==========================================================
    // ===                 HELPER FUNCTIONS                   ===
    // ==========================================================
    function showAlert(title, message, cb) { 
        const dialog = document.getElementById('customAlertDialog');
        dialog.querySelector('#customAlertTitle').textContent = title;
        dialog.querySelector('#customAlertMessage').textContent = message;
        dialog.showModal();
        dialog.addEventListener('close', () => { if (cb) cb(); }, { once: true });
    }
    
    function showConfirm(title, message) { 
        return new Promise(res => { 
            const dialog = document.getElementById('customConfirmDialog'); 
            dialog.querySelector('#customConfirmTitle').textContent = title; 
            dialog.querySelector('#customConfirmMessage').textContent = message; 
            const okBtn = dialog.querySelector('#customConfirmConfirmButton');
            const cancelBtn = dialog.querySelector('#customConfirmCancelButton');
            
            const onOk = () => { cleanup(); res(true); };
            const onCancel = () => { cleanup(); res(false); };
            
            function cleanup() {
                dialog.close();
                okBtn.removeEventListener('click', onOk);
                cancelBtn.removeEventListener('click', onCancel);
            }
            
            okBtn.addEventListener('click', onOk, { once: true });
            cancelBtn.addEventListener('click', onCancel, { once: true });
            
            dialog.showModal();
        }); 
    }
    
    async function fetchData(action, params = {}) { 
        const url = new URL(CONFIG.GAS_URL_ADMIN); url.searchParams.append('action', action); 
        for (const k in params) { if (params[k]) url.searchParams.append(k, params[k]); } 
        try { 
            const r = await fetch(url); 
            if (!r.ok) throw new Error(`Server responded with status: ${r.status}`);
            const data = await r.json();
            if(data.error) throw new Error(data.error);
            return data;
        } catch (e) { showAlert('Error', `Fetch failed: ${e.message}`); throw e; } 
    }
    
    async function postData(action, data) { 
        const btn = document.querySelector('button:focus, button.loading');
        if (btn) { btn.disabled = true; }
        try { 
            const r = await fetch(CONFIG.GAS_URL_ADMIN, { method: 'POST', body: JSON.stringify({ action, ...data }) }); 
            if (!r.ok) throw new Error(`Server responded with status: ${r.status}`);
            const responseText = await r.text();
            try {
                const jsonData = JSON.parse(responseText);
                if(jsonData.success === false) throw new Error(jsonData.error || 'Unknown error from server');
                return jsonData.message || responseText;
            } catch (jsonError) { return responseText; }
        } catch (e) { showAlert('Error', `Request failed: ${e.message}`); throw e; } 
        finally { if (btn) { btn.disabled = false; }}
    }

    // ==========================================================
    // ===               ROUTER & AUTHENTICATION              ===
    // ==========================================================
    const routes = {
        '': { init: initDashboard, title: "ภาพรวม" },
        '#dashboard': { init: initDashboard, title: "ภาพรวม" },
        '#users': { init: initUsers, title: "จัดการผู้ใช้" },
        '#add-points': { init: initAddPoints, title: "เพิ่มแต้ม (POS)" },
        '#items': { init: initGenericTableView, title: "จัดการของรางวัล", config: 'items' },
        '#products': { init: initGenericTableView, title: "จัดการสินค้า", config: 'products' },
        '#warehouse': { init: initWarehouse, title: "คลังสินค้า" },
        '#scan-claim': { init: initScanClaim, title: "สแกนรับของ" },
        '#events': { init: initGenericTableView, title: "จัดการกิจกรรม", config: 'events' },
        '#codes': { init: initGenericTableView, title: "จัดการโค้ด", config: 'codes' },
        '#history': { init: initHistory, title: "ประวัติการทำรายการ" },
        '#settings': { init: initSettings, title: "ตั้งค่าระบบ" },
    };

    function setActiveNavLink(hash) { 
        document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.getAttribute('href') === hash)); 
        if (sidebar.classList.contains('-translate-x-full') === false) {
            toggleSidebar();
        }
    }
    
    async function router() {
        if (!sessionStorage.getItem('isLoggedIn')) return;
        const hash = window.location.hash || '#dashboard';
        const route = routes[hash] || routes[''];

        pageTitle.textContent = route.title || "Loading...";
        appContainer.classList.add('opacity-50');
        appContainer.innerHTML = `<div class="page-loader"><div class="loading-spinner"></div><p>กำลังเปลี่ยนไปที่เมนู ${route.title}...</p></div>`;
        setActiveNavLink(hash);

        fetchData('getLevelConfig').then(config => {
            if (config) levelConfig = { VIP_points: parseInt(config.VIP_points, 10), SUPER_points: parseInt(config.SUPER_points, 10) };
        }).catch(e => console.warn("Using default level config."));

        // Use a generic template if a specific one isn't found
        let template;
        if (route.config) {
          template = document.getElementById('view-table-generic');
        } else {
          template = document.getElementById(`view-${hash.replace('#', '')}`) || document.getElementById('view-dashboard');
        }

        if (template) { 
            appContainer.innerHTML = ''; 
            appContainer.appendChild(template.content.cloneNode(true)); 
            try { 
                if (route.config) {
                    await route.init(TABLE_CONFIGS[route.config]);
                } else {
                    await route.init(); 
                }
            } catch (e) { 
                appContainer.innerHTML = `<p class="text-thm-error text-center">Error loading page: ${e.message}</p>`; 
            }
        } else { 
            appContainer.innerHTML = `<p class="text-thm-error text-center">Page not found</p>`; 
        }
        appContainer.classList.remove('opacity-50');
    }
    
    function handleLogin() {
        const loginOverlay = document.getElementById('login-overlay'), loginBtn = document.getElementById('loginBtn'), userInput = document.getElementById('username'), passInput = document.getElementById('password'), loginError = document.getElementById('login-error');
        async function attemptLogin() { 
            loginBtn.disabled = true; loginError.classList.add('hidden'); 
            try { 
                const res = await fetch(CONFIG.GAS_URL_ADMIN, { method: 'POST', body: JSON.stringify({ action: 'login', username: userInput.value, password: passInput.value }) });
                const data = await res.json();
                if (data.success) { sessionStorage.setItem('isLoggedIn', 'true'); loginOverlay.classList.add('hidden'); mainApp.classList.remove('hidden'); await router(); } 
                else { loginError.textContent = data.message || "Invalid credentials"; loginError.classList.remove('hidden'); } 
            } catch (e) { loginError.textContent = 'Login request failed.'; loginError.classList.remove('hidden'); } 
            finally { loginBtn.disabled = false; } 
        }
        loginBtn.onclick = attemptLogin; passInput.addEventListener('keypress', (e) => e.key === 'Enter' && attemptLogin());
        document.getElementById('logoutBtn').onclick = () => { sessionStorage.removeItem('isLoggedIn'); location.reload(); };
        if (sessionStorage.getItem('isLoggedIn')) { loginOverlay.classList.add('hidden'); mainApp.classList.remove('hidden'); router(); }
    }

    // ==========================================================
    // ===                 PAGE INITIALIZERS                  ===
    // ==========================================================
    
    async function initDashboard() {
        const [sTotalUsers, sNewUsers, sTotalItems, sRedeemed, sTotalEvents, sTotalCodes] = ['statTotalUsers', 'statNewUsersToday', 'statTotalItems', 'statRedeemedItems', 'statTotalEvents', 'statTotalCodes'].map(id => document.getElementById(id));
        const userLevelChartCtx = document.getElementById('userLevelChart').getContext('2d'); const pointStatsChartCtx = document.getElementById('pointStatsChart').getContext('2d');
        try { 
            const data = await fetchData('getDashboardData'); 
            sTotalUsers.textContent = data.users.length; 
            const todayStr = new Date().toDateString(); 
            sNewUsers.textContent = `+${data.users.filter(u => u.signupDate && new Date(u.signupDate).toDateString() === todayStr).length} วันนี้`; 
            sTotalItems.textContent = data.items.length; 
            sRedeemed.textContent = `แลกแล้ว ${data.allHistory.filter(h => h.type === 'redeem').length} ครั้ง`; 
            sTotalEvents.textContent = `${data.events.length} กิจกรรม`; sTotalCodes.textContent = `และ ${data.codes.length} โค้ด`; 
            const levelCounts = data.users.reduce((acc, user) => { const level = user.level || 'MEMBER'; acc[level.toUpperCase()] = (acc[level.toUpperCase()] || 0) + 1; return acc; }, { MEMBER: 0, VIP: 0, SUPER: 0 }); 
            if (window.userLevelChartInstance) window.userLevelChartInstance.destroy(); 
            window.userLevelChartInstance = new Chart(userLevelChartCtx, { type: 'bar', data: { labels: ['MEMBER', 'VIP', 'SUPER'], datasets: [{ label: 'จำนวน', data: [levelCounts.MEMBER, levelCounts.VIP, levelCounts.SUPER], backgroundColor: ['#93c5fd', '#3b82f6', '#1d4ed8'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } } }); 
            const { earned, spent } = data.allHistory.reduce((acc, h) => { if (h.amount > 0) acc.earned += h.amount; else acc.spent += Math.abs(h.amount); return acc; }, { earned: 0, spent: 0 }); 
            if (window.pointStatsChartInstance) window.pointStatsChartInstance.destroy(); 
            window.pointStatsChartInstance = new Chart(pointStatsChartCtx, { type: 'doughnut', data: { labels: ['ได้รับ', 'ใช้ไป'], datasets: [{ data: [earned, spent], backgroundColor: ['#22c55e', '#ef4444'], borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false } }); 
        } catch (e) { /* Error handled */ }
    }

    async function initUsers() {
        const tableBody = document.getElementById('userTableBody'); const searchInput = document.getElementById('userSearchInput'); const searchBtn = document.getElementById('userSearchBtn'); 
        document.getElementById('addUserBtn').onclick = () => showUserFormModal(); 
        searchBtn.onclick = () => loadUsers(searchInput.value); 
        searchInput.addEventListener('keypress', e => e.key === 'Enter' && searchBtn.click()); 
        await loadUsers();
        async function loadUsers(query) { tableBody.innerHTML = `<tr><td colspan="7" class="py-12 text-center"><div class="loading-spinner mx-auto"></div></td></tr>`; try { const users = await fetchData('getUsers', { query }); renderUserTable(users); } catch (e) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-thm-error">Load failed</td></tr>`; } }
        function renderUserTable(users) { 
            if (!users.length) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-thm-text-light">ไม่พบข้อมูล</td></tr>`; return; } 
            tableBody.innerHTML = users.map(u => `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-mono text-xs">${u.lineId}</td><td class="px-6 py-4 font-medium">${u.name}</td><td class="px-6 py-4">${u.phone || '-'}</td><td class="px-6 py-4 font-semibold">${u.point.toLocaleString()}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${u.level.toUpperCase() === 'SUPER' ? 'bg-blue-100 text-blue-800' : u.level.toUpperCase() === 'VIP' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${u.level}</span></td><td class="px-6 py-4">${(u.tags || []).map(t => `<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">${t}</span>`).join(' ')}</td><td class="px-6 py-4 text-right space-x-2"><button class="font-medium text-thm-primary hover:underline edit-user-btn">แก้ไข</button><button class="font-medium text-thm-error hover:underline delete-user-btn">ลบ</button></td></tr>`).join(''); 
            tableBody.querySelectorAll('.edit-user-btn').forEach((b, i) => b.onclick = async () => { try { const user = await fetchData('getUserInfo', { lineId: users[i].lineId }); showUserFormModal(user); } catch (e) { /* handled */ } }); 
            tableBody.querySelectorAll('.delete-user-btn').forEach((b, i) => b.onclick = () => deleteUser(users[i].lineId)); 
        }
        function showUserFormModal(user) { 
            const isEdit = !!user; dataFormModalTitle.textContent = isEdit ? 'แก้ไขผู้ใช้' : 'เพิ่มผู้ใช้'; 
            formFieldsContainer.innerHTML = `<input type="text" name="lineId" placeholder="Line ID" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" ${isEdit ? 'readonly' : 'required'} value="${isEdit ? user.id : ''}" /><input type="text" name="name" placeholder="Name" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${isEdit ? user.name : ''}" /><input type="tel" name="phone" placeholder="Phone" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" value="${isEdit ? (user.phone || '') : ''}" /><input type="number" name="point" placeholder="Points" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${isEdit ? user.point : 0}" /><input type="text" name="tags" placeholder="Tags (คั่นด้วย ,)" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" value="${isEdit ? (user.tags || []).join(', ') : ''}" />`; 
            dataFormModal.showModal(); formSaveBtn.onclick = () => saveUser(isEdit); formCancelBtn.onclick = () => dataFormModal.close(); 
        }
        async function saveUser(isEdit) { 
            const data = { lineId: formFieldsContainer.querySelector('[name=lineId]').value.trim(), name: formFieldsContainer.querySelector('[name=name]').value.trim(), phone: formFieldsContainer.querySelector('[name=phone]').value.trim(), point: parseInt(formFieldsContainer.querySelector('[name=point]').value), tags: formFieldsContainer.querySelector('[name=tags]').value.split(',').map(t => t.trim()).filter(Boolean) }; 
            if (!data.lineId || !data.name) return showAlert('Error', 'Line ID และชื่อห้ามว่าง'); 
            formSaveBtn.disabled = true; try { await postData(isEdit ? 'updateUserAdmin' : 'registerAdmin', data); showAlert('Success', `User ${isEdit ? 'updated' : 'added'}`, () => { dataFormModal.close(); loadUsers(); }); } catch(e) {/* handled */ } finally { formSaveBtn.disabled = false; } 
        }
        async function deleteUser(lineId) { if (await showConfirm('Confirm', `ต้องการลบผู้ใช้ ${lineId}?`)) { try { await postData('deleteUser', { lineId }); showAlert('Success', 'User deleted', () => loadUsers()); } catch (e) { /* handled */ } } }
    }

    async function initAddPoints() {
        const form = document.getElementById('addPointsForm'), submitBtn = document.getElementById('addPointsSubmitBtn'), productModeSection = document.getElementById('productModeSection'), manualModeSection = document.getElementById('manualModeSection'), productListSelect = document.getElementById('productList'), quantityInput = document.getElementById('productQuantity'), addItemBtn = document.getElementById('addItemToBillBtn'), billContainer = document.getElementById('billItemsContainer'), totalPointsDisplay = document.getElementById('totalPointsDisplay'), modeTabs = document.querySelectorAll('.tab-button');
        let allProducts = [], billItems = [], currentMode = 'product';

        modeTabs.forEach(tab => {
            tab.onclick = () => {
                currentMode = tab.dataset.mode;
                modeTabs.forEach(t => t.classList.remove('active', 'bg-thm-primary', 'text-white'));
                tab.classList.add('active', 'bg-thm-primary', 'text-white');
                productModeSection.classList.toggle('hidden', currentMode !== 'product');
                manualModeSection.classList.toggle('hidden', currentMode !== 'manual');
            };
        });
        modeTabs[0].click(); // Activate first tab

        try { allProducts = await fetchData('getProducts'); updateProductDropdown(); } catch (e) { productListSelect.innerHTML = `<option disabled selected>โหลดสินค้าล้มเหลว</option>`; }
        
        function updateProductDropdown() {
            const productIdsInBill = billItems.map(item => item.id);
            const availableProducts = allProducts.filter(p => !productIdsInBill.includes(p.id));
            productListSelect.innerHTML = '';
            if (availableProducts.length > 0) {
                availableProducts.forEach(p => { const option = document.createElement('option'); option.value = p.id; option.textContent = `${p.name} (${p.points} แต้ม)`; productListSelect.appendChild(option); });
            } else { productListSelect.innerHTML = '<option disabled selected>เพิ่มสินค้าครบแล้ว</option>'; }
        }

        function renderBill() {
            billContainer.innerHTML = ''; let totalPoints = 0;
            if (billItems.length === 0) { billContainer.innerHTML = '<p class="text-center text-thm-text-light">ยังไม่มีรายการ</p>'; totalPointsDisplay.textContent = '0'; return; }
            billItems.forEach(item => {
                const itemPoints = item.points * item.quantity; totalPoints += itemPoints;
                const itemDiv = document.createElement('div'); itemDiv.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                itemDiv.innerHTML = `<div><span class="font-semibold">${item.name}</span> <span class="text-sm text-thm-text-light">x ${item.quantity}</span></div><div><span class="font-bold text-thm-primary">${itemPoints} แต้ม</span><button type="button" class="ml-2 text-red-500 hover:text-red-700 remove-item-btn" data-id="${item.id}">×</button></div>`;
                billContainer.appendChild(itemDiv);
            });
            totalPointsDisplay.textContent = totalPoints.toLocaleString();
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.onclick = (e) => { billItems = billItems.filter(item => item.id !== e.currentTarget.dataset.id); renderBill(); updateProductDropdown(); };
            });
        }

        addItemBtn.onclick = () => {
            const selectedId = productListSelect.value; if (!selectedId) return;
            const product = allProducts.find(p => p.id === selectedId);
            const quantity = parseInt(quantityInput.value, 10);
            if (product && quantity > 0) { billItems.push({ ...product, quantity }); renderBill(); updateProductDropdown(); quantityInput.value = 1; }
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('addPointsIdentifier').value.trim();
            if (!identifier) return showAlert('ข้อมูลไม่ครบ', 'กรุณาระบุลูกค้า');
            let payload = { identifier }, confirmMessage = '', totalPoints = 0;

            if (currentMode === 'product') {
                if (billItems.length === 0) return showAlert('ข้อมูลไม่ครบ', 'กรุณาเพิ่มสินค้าลงในบิล');
                payload.itemsPurchased = billItems.map(item => ({ productId: item.id, quantity: item.quantity }));
                totalPoints = billItems.reduce((sum, item) => sum + (item.points * item.quantity), 0);
                const itemSummary = billItems.map(item => `${item.name} x${item.quantity}`).join(',\n');
                confirmMessage = `ยืนยันให้ ${totalPoints} แต้ม\nจาก:\n${itemSummary}\n\nสำหรับผู้ใช้: "${identifier}"?`;
            } else {
                const points = document.getElementById('addPointsAmount').value;
                const reason = document.getElementById('addPointsReason').value.trim();
                if (!points || parseInt(points) < 1 || !reason) return showAlert('ข้อมูลไม่ครบ', 'กรุณากรอกแต้มและเหตุผล');
                payload.points = parseInt(points, 10); payload.reason = reason;
                totalPoints = payload.points;
                confirmMessage = `ยืนยันให้ ${totalPoints} แต้ม\nเหตุผล: ${payload.reason}\n\nสำหรับผู้ใช้: "${identifier}"?`;
            }

            if (await showConfirm('ยืนยันการให้แต้ม', confirmMessage)) {
                submitBtn.disabled = true;
                try {
                    const message = await postData('addPointsToUser', payload);
                    showAlert('สำเร็จ', message || 'เพิ่มแต้มเรียบร้อยแล้ว');
                    form.reset(); billItems = []; renderBill(); updateProductDropdown();
                } catch(e) { /* handled */ } finally {
                    submitBtn.disabled = false;
                }
            }
        };
        renderBill();
    }
    
    async function initWarehouse() {
        const tableBody = document.getElementById('warehouseTableBody'), searchInput = document.getElementById('warehouseSearchInput'), statusFilter = document.getElementById('warehouseStatusFilter'), searchBtn = document.getElementById('warehouseSearchBtn');
        searchBtn.onclick = () => loadWarehouseItems(); searchInput.addEventListener('keypress', e => e.key === 'Enter' && searchBtn.click()); statusFilter.onchange = () => loadWarehouseItems(); await loadWarehouseItems();
        async function loadWarehouseItems() { tableBody.innerHTML = `<tr><td colspan="7" class="py-12 text-center"><div class="loading-spinner mx-auto"></div></td></tr>`; try { const items = await fetchData('getWarehouseItems', { query: searchInput.value, status: statusFilter.value }); renderWarehouseTable(items); } catch (e) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-thm-error">Load failed</td></tr>`; } }
        function renderWarehouseTable(items) { 
            if (!items.length) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-thm-text-light">ไม่พบข้อมูล</td></tr>`; return; } 
            tableBody.innerHTML = items.map(i => { const shippingInfo = i.shippingName ? `<div class="text-xs"><strong>${i.shippingName}</strong><br>${i.shippingPhone}<br><div class="whitespace-normal">${i.shippingAddress}</div></div>` : '-'; const actionBtn = i.status === 'claimed' ? `<div class="text-xs text-thm-success font-semibold">ยืนยันแล้ว<br>${i.claimDate}</div>` : `<button class="bg-thm-success text-white font-bold py-1 px-3 text-xs rounded-full hover:bg-green-700 claim-item-btn">ยืนยัน</button>`; return `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${i.warehouseId}</td><td class="px-6 py-4">${i.itemName}</td><td class="px-6 py-4 font-mono text-xs">${i.lineId}</td><td class="px-6 py-4">${shippingInfo}</td><td class="px-6 py-4">${i.redeemDate}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${i.status === 'claimed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${i.status.replace('_', ' ')}</span></td><td class="px-6 py-4 text-right">${actionBtn}</td></tr>`; }).join(''); tableBody.querySelectorAll('.claim-item-btn').forEach((b,i) => b.onclick = () => claimItem(items[i].warehouseId)); 
        }
        async function claimItem(id) { if (await showConfirm('Confirm', `ยืนยันการรับ/จัดส่งสำหรับ ${id}?`)) { try { await postData('claimWarehouseItemAdmin', { warehouseId: id }); showAlert('Success', 'อัปเดตสถานะสำเร็จ', () => loadWarehouseItems()); } catch (e) { /* handled */ } } }
    }

    async function initScanClaim() {
        const readerElement = document.getElementById('qr-reader'), startBtn = document.getElementById('startScanBtn'), stopBtn = document.getElementById('stopScanBtn'), resultElement = document.getElementById('scan-result');
        let html5QrCode = null;
        const onScanSuccess = async (decodedText) => { await stopScanning(); resultElement.innerHTML = `<div class="loading-spinner mx-auto"></div>`; try { const responseText = await postData('claimItemByUniqueId', { uniqueId: decodedText }); showAlert('ผลการยืนยัน', responseText); resultElement.innerHTML = responseText.includes('สำเร็จ') ? `✅ ${responseText}` : `⚠️ ${responseText}`; } catch (error) { resultElement.innerHTML = `❌ ${error.message}`; } };
        const startScanning = () => { if (!html5QrCode) { html5QrCode = new Html5Qrcode("qr-reader"); } html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, ()=>{}) .then(() => { startBtn.classList.add('hidden'); stopBtn.classList.remove('hidden'); resultElement.textContent = 'กรุณาหันกล้องไปที่ QR Code'; }).catch(err => showAlert("ข้อผิดพลาด", "ไม่สามารถเปิดกล้องได้")); };
        const stopScanning = async () => { if (html5QrCode && html5QrCode.isScanning) { try { await html5QrCode.stop(); startBtn.classList.remove('hidden'); stopBtn.classList.add('hidden'); } catch (err) { console.error("Failed to stop scanning.", err); } } };
        startBtn.onclick = startScanning; stopBtn.onclick = stopScanning;
        window.addEventListener('hashchange', stopScanning, { once: true });
    }

    async function initHistory() {
        const tableBody = document.getElementById('historyTableBody'); const [lineIdInput, typeSelect, startDateInput, endDateInput, filterBtn, resetBtn] = ['historySearchLineId', 'historyFilterType', 'historyStartDate', 'historyEndDate', 'historyFilterBtn', 'historyResetBtn'].map(id => document.getElementById(id)); filterBtn.onclick = loadHistory; resetBtn.onclick = () => { lineIdInput.value = ''; typeSelect.value = ''; startDateInput.value = ''; endDateInput.value = ''; loadHistory(); }; await loadHistory();
        async function loadHistory() { tableBody.innerHTML = `<tr><td colspan="6" class="py-12 text-center"><div class="loading-spinner mx-auto"></div></td></tr>`; try { const history = await fetchData('getAllHistory', { lineId: lineIdInput.value, type: typeSelect.value, startDate: startDateInput.value, endDate: endDateInput.value }); renderHistoryTable(history); } catch (e) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-thm-error">Load failed</td></tr>`; } }
        function renderHistoryTable(history) { if (!history.length) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-thm-text-light">ไม่พบข้อมูล</td></tr>`; return; } tableBody.innerHTML = history.map(h => `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-mono text-xs">${h.lineId}</td><td class="px-6 py-4">${h.type}</td><td class="px-6 py-4">${h.detail}</td><td class="px-6 py-4 ${h.amount < 0 ? 'text-thm-error' : 'text-thm-success'} font-bold">${h.amount > 0 ? '+' : ''}${h.amount}</td><td class="px-6 py-4">${h.date}</td><td class="px-6 py-4">${h.refId || '-'}</td></tr>`).join(''); }
    }
    
    async function initSettings() {
        const form = document.getElementById('levelSettingsForm'); const vipInput = document.getElementById('vipPoints'); const superInput = document.getElementById('superPoints');
        try { const config = await fetchData('getLevelConfig'); vipInput.value = config.VIP_points; superInput.value = config.SUPER_points; } catch (e) { /* handled */ }
        form.onsubmit = async (e) => { e.preventDefault(); const vip = parseInt(vipInput.value), superP = parseInt(superInput.value); if (isNaN(vip) || isNaN(superP)) return showAlert('Error', 'กรุณากรอกตัวเลข'); if (vip > 0 && superP > 0 && vip >= superP) return showAlert('Error', 'แต้ม SUPER ต้องมากกว่า VIP'); const btn = document.getElementById('saveLevelSettingsBtn'); btn.disabled = true; try { await postData('setLevelConfig', { VIP_points: vip, SUPER_points: superP }); showAlert('Success', 'บันทึกการตั้งค่าแล้ว'); } catch(e) {/* handled */ } finally { btn.disabled = false; } };
    }

    // ==========================================================
    // ===          GENERIC TABLE VIEW & CONFIGS            ===
    // ==========================================================

    const TABLE_CONFIGS = {
        items: {
            title: "ของรางวัล",
            getAction: "getItems",
            deleteAction: "deleteItem",
            saveAction: { add: "addItem", update: "updateItem" },
            headers: ["ID", "ชื่อ", "พ้อยต์", "ประเภท", "รูปภาพ", "จัดการ"],
            renderRow: (item) => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${item.id}</td>
                    <td class="px-6 py-4 font-medium">${item.name}</td>
                    <td class="px-6 py-4">${item.point.toLocaleString()}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">${item.type}</span></td>
                    <td class="px-6 py-4">${item.image ? `<img src="${item.image}" class="w-12 h-12 object-cover rounded-md">` : '-'}</td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button class="font-medium text-thm-primary hover:underline edit-btn">แก้ไข</button>
                        <button class="font-medium text-thm-error hover:underline delete-btn">ลบ</button>
                    </td>
                </tr>`,
            formFields: (item) => `
                <input type="text" name="id" placeholder="ID (auto)" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" ${item ? 'readonly' : ''} value="${item ? item.id : ''}" />
                <input type="text" name="name" placeholder="Name" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${item ? item.name : ''}" />
                <input type="number" name="point" placeholder="Points" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${item ? item.point : ''}" />
                <select name="type" class="w-full px-3 py-2 bg-white border border-thm-border rounded-lg">
                    <option value="digital" ${item && item.type === 'digital' ? 'selected' : ''}>Digital</option>
                    <option value="physical" ${item && item.type === 'physical' ? 'selected' : ''}>Physical</option>
                </select>
                <input type="url" name="image" placeholder="Image URL" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" value="${item ? item.image : ''}" />`,
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim() || undefined, name: form.querySelector('[name=name]').value.trim(), point: parseInt(form.querySelector('[name=point]').value), type: form.querySelector('[name=type]').value, image: form.querySelector('[name=image]').value.trim() })
        },
        products: {
            title: "สินค้า",
            getAction: "getProducts",
            deleteAction: "deleteProduct",
            saveAction: { add: "addProduct", update: "updateProduct" },
            headers: ["ID", "ชื่อสินค้า", "หมวดหมู่", "ราคา", "แต้ม/หน่วย", "จัดการ"],
            renderRow: (p) => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-mono text-xs">${p.id}</td>
                    <td class="px-6 py-4 font-medium">${p.name}<div class="text-xs text-thm-text-light">${p.description || ''}</div></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${p.category || '-'}</span></td>
                    <td class="px-6 py-4">${p.price.toLocaleString()}</td>
                    <td class="px-6 py-4 font-bold text-thm-success">${p.points}</td>
                    <td class="px-6 py-4 text-right space-x-2"><button class="font-medium text-thm-primary hover:underline edit-btn">แก้ไข</button><button class="font-medium text-thm-error hover:underline delete-btn">ลบ</button></td>
                </tr>`,
            formFields: (p) => `
                <input type="text" name="id" placeholder="ID (auto)" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" ${p ? 'readonly' : ''} value="${p ? p.id : ''}" />
                <input type="text" name="name" placeholder="ชื่อสินค้า" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${p ? p.name : ''}" />
                <textarea name="description" placeholder="รายละเอียด (ไม่บังคับ)" class="w-full h-20 px-4 py-2 bg-white border border-thm-border rounded-lg">${p ? (p.description || '') : ''}</textarea>
                <input type="text" name="category" placeholder="หมวดหมู่" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" value="${p ? (p.category || '') : ''}" />
                <div class="grid grid-cols-2 gap-4">
                  <input type="number" name="price" placeholder="ราคา" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${p ? p.price : 0}" />
                  <input type="number" name="points" placeholder="แต้ม" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${p ? p.points : 0}" />
                </div>`,
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim() || undefined, name: form.querySelector('[name=name]').value.trim(), description: form.querySelector('[name=description]').value.trim(), category: form.querySelector('[name=category]').value.trim(), price: parseFloat(form.querySelector('[name=price]').value), points: parseInt(form.querySelector('[name=points]').value, 10) })
        },
        events: {
            title: "กิจกรรม",
            getAction: "getEvents",
            deleteAction: "deleteEvent",
            saveAction: { add: "addEvent", update: "updateEvent" },
            headers: ["ID", "ชื่อกิจกรรม", "พ้อยต์", "ระดับ", "รูปภาพ", "จัดการ"],
            renderRow: (e) => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${e.id}</td>
                    <td class="px-6 py-4 font-medium">${e.title}</td>
                    <td class="px-6 py-4">${e.point}</td>
                    <td class="px-6 py-4">${(e.allowedLevels || []).map(l => `<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">${l}</span>`).join(' ') || 'ทุกคน'}</td>
                    <td class="px-6 py-4">${e.image ? `<img src="${e.image}" class="w-12 h-12 object-cover rounded-md">` : '-'}</td>
                    <td class="px-6 py-4 text-right space-x-2"><button class="font-medium text-thm-primary hover:underline edit-btn">แก้ไข</button><button class="font-medium text-thm-error hover:underline delete-btn">ลบ</button></td>
                </tr>`,
            formFields: (e) => {
                const levelsHtml = USER_LEVELS.map(l => `<label class="flex items-center gap-2"><input type="checkbox" name="allowedLevels" value="${l}" class="rounded border-gray-300 text-thm-primary shadow-sm focus:border-thm-primary focus:ring focus:ring-offset-0 focus:ring-thm-primary focus:ring-opacity-50" ${e?.allowedLevels?.includes(l) ? 'checked' : ''}><span class="text-sm">${l}</span></label>`).join('');
                return `<input type="text" name="id" placeholder="ID (auto)" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" ${e ? 'readonly' : ''} value="${e ? e.id : ''}" />
                        <input type="text" name="title" placeholder="Title" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${e ? e.title : ''}" />
                        <input type="number" name="point" placeholder="Points" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${e ? e.point : 0}" />
                        <div><label class="block text-sm font-medium mb-2">ระดับที่เข้าร่วมได้</label><div class="flex flex-wrap gap-4">${levelsHtml}</div></div>
                        <textarea name="desc" placeholder="Description" class="w-full h-24 px-4 py-2 bg-white border border-thm-border rounded-lg">${e ? (e.desc || '') : ''}</textarea>
                        <input type="url" name="image" placeholder="Image URL" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" value="${e ? (e.image || '') : ''}" />`;
            },
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim() || undefined, title: form.querySelector('[name=title]').value.trim(), point: parseInt(form.querySelector('[name=point]').value, 10), desc: form.querySelector('[name=desc]').value.trim(), image: form.querySelector('[name=image]').value.trim(), allowedLevels: Array.from(form.querySelectorAll('input[name="allowedLevels"]:checked')).map(cb => cb.value) })
        },
        codes: {
            title: "โค้ด",
            getAction: "getCodes",
            deleteAction: "deleteCode",
            saveAction: { add: "addCode", update: "updateCode" },
            headers: ["ID (QR Value)", "ชื่อโค้ด", "พ้อยต์", "รายละเอียด", "จัดการ"],
            renderRow: (c) => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-mono text-xs">${c.id}</td>
                    <td class="px-6 py-4 font-medium">${c.title}</td>
                    <td class="px-6 py-4">${c.point}</td>
                    <td class="px-6 py-4 max-w-xs truncate">${c.desc || '-'}</td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button class="font-medium text-purple-600 hover:underline qr-gen-btn">QR</button>
                        <button class="font-medium text-thm-primary hover:underline edit-btn">แก้ไข</button>
                        <button class="font-medium text-thm-error hover:underline delete-btn">ลบ</button>
                    </td>
                </tr>`,
            formFields: (c) => `
                <input type="text" name="id" placeholder="ID (QR Value)" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" ${c ? 'readonly' : 'required'} value="${c ? c.id : ''}" />
                <input type="text" name="title" placeholder="Title" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${c ? c.title : ''}" />
                <input type="number" name="point" placeholder="Points" class="w-full px-4 py-2 bg-white border border-thm-border rounded-lg" required value="${c ? c.point : 0}" />
                <textarea name="desc" placeholder="Description" class="w-full h-24 px-4 py-2 bg-white border border-thm-border rounded-lg">${c ? (c.desc || '') : ''}</textarea>`,
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim(), title: form.querySelector('[name=title]').value.trim(), point: parseInt(form.querySelector('[name=point]').value, 10), desc: form.querySelector('[name=desc]').value.trim() }),
            afterRender: () => {
                document.querySelectorAll('.qr-gen-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const row = e.target.closest('tr');
                        const id = row.cells[0].textContent;
                        const title = row.cells[1].textContent;
                        const qrModal = document.getElementById('qrCodeModal');
                        const canvas = document.getElementById('qrCodeCanvas');
                        qrModal.querySelector('#qrCodeModalTitle').textContent = `QR Code: ${title}`;
                        canvas.innerHTML = '';
                        new QRCode(canvas, { text: id, width: 256, height: 256 });
                        qrModal.showModal();
                    };
                });
            }
        }
    };
    
    async function initGenericTableView(config) {
        const tableHeader = document.getElementById('tableHeaderRow');
        const tableBody = document.getElementById('tableBody');
        const addNewBtn = document.getElementById('addNewBtn');

        addNewBtn.textContent = `เพิ่ม${config.title}ใหม่`;
        addNewBtn.onclick = () => showFormModal(config);
        tableHeader.innerHTML = config.headers.map(h => `<th class="px-6 py-3">${h}</th>`).join('');

        async function loadData() {
            tableBody.innerHTML = `<tr><td colspan="${config.headers.length}" class="py-12 text-center"><div class="loading-spinner mx-auto"></div></td></tr>`;
            try {
                const data = await fetchData(config.getAction);
                renderTable(data, config);
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="${config.headers.length}" class="text-center p-4 text-thm-error">Load failed</td></tr>`;
            }
        }

        function renderTable(data, config) {
            if (!data.length) {
                tableBody.innerHTML = `<tr><td colspan="${config.headers.length}" class="text-center p-4 text-thm-text-light">ไม่พบข้อมูล</td></tr>`;
                return;
            }
            tableBody.innerHTML = data.map(item => config.renderRow(item)).join('');
            tableBody.querySelectorAll('.edit-btn').forEach((b, i) => b.onclick = () => showFormModal(config, data[i]));
            tableBody.querySelectorAll('.delete-btn').forEach((b, i) => b.onclick = () => deleteItem(config, data[i].id));
            if (config.afterRender) config.afterRender();
        }

        function showFormModal(config, item = null) {
            const isEdit = !!item;
            dataFormModalTitle.textContent = `${isEdit ? 'แก้ไข' : 'เพิ่ม'}${config.title}`;
            formFieldsContainer.innerHTML = config.formFields(item);
            dataFormModal.showModal();
            formSaveBtn.onclick = () => saveItem(config, isEdit);
            formCancelBtn.onclick = () => dataFormModal.close();
        }

        async function saveItem(config, isEdit) {
            const data = config.getFormData(formFieldsContainer);
            if (!data.name && !data.title) return showAlert('Error', 'Name/Title is required.');
            
            formSaveBtn.disabled = true;
            try {
                const action = isEdit ? config.saveAction.update : config.saveAction.add;
                await postData(action, data);
                showAlert('Success', `${config.title} ${isEdit ? 'updated' : 'added'}`, () => {
                    dataFormModal.close();
                    loadData();
                });
            } catch (e) {
                // error handled in postData
            } finally {
                formSaveBtn.disabled = false;
            }
        }

        async function deleteItem(config, id) {
            if (await showConfirm('Confirm', `ต้องการลบ ${config.title} ID: ${id}?`)) {
                try {
                    await postData(config.deleteAction, { id });
                    showAlert('Success', `${config.title} deleted`, loadData);
                } catch (e) { /* handled */ }
            }
        }

        await loadData();
    }


    // --- App Start ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof CONFIG === 'undefined' || !CONFIG.GAS_URL_ADMIN) {
             const gasUrl = prompt("Please enter your Google Apps Script URL for Admin:");
            if (gasUrl) { window.CONFIG = { GAS_URL_ADMIN: gasUrl }; } 
            else { document.body.innerHTML = '<div class="p-8 text-center text-thm-error">Configuration not found. Please create config-admin.js or enter the URL.</div>'; return; }
        }
        
        // Generate Menu
        const menuContainer = document.getElementById('main-menu');
        menuContainer.innerHTML = MENU_STRUCTURE.map(item => {
            if (item.title) {
                return `<li class="px-4 pt-4 pb-2 text-xs font-semibold text-thm-text-light uppercase tracking-wider">${item.title}</li>`;
            }
            return `<li><a href="${item.href}" class="nav-link flex items-center p-2 rounded-lg text-thm-text-light hover:bg-gray-100 hover:text-thm-text">${item.name}</a></li>`;
        }).join('');
        
        handleLogin();
        window.addEventListener('hashchange', router);
    });
</script>

</body>
</html>
