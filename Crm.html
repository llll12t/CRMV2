<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CRM-3RN</title>
  <!-- Load config before main script -->
  <script src="Config.js"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- DaisyUI CDN (includes Tailwind CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- QR Code Generator Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

  <style>
    .hidden { display: none !important; }
    .neon-text {
      color: #fff;
      text-shadow: 0 0 5px #ff005e, 0 0 10px #ff005e, 0 0 20px #ff005e, 0 0 40px #ff005e, 0 0 80px #ff005e;
      animation: glow 1.5s infinite alternate;
    }
    @keyframes glow {
      from { text-shadow: 0 0 5px #ff005e, 0 0 10px #ff005e, 0 0 20px #ff005e; }
      to { text-shadow: 0 0 10px #00d4ff, 0 0 20px #00d4ff, 0 0 40px #00d4ff; }
    }
    @keyframes pulse-opacity {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .loading-card-animation { animation: pulse-opacity 1.5s infinite ease-in-out; }
    .glass-white {
      background: rgba(255, 255, 255, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8.1px); -webkit-backdrop-filter: blur(8.1px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body class="bg-gradient-to-b from-neutral via-white to-white min-h-screen relative bg-fixed p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 id="pageTitle" class="text-xl font-bold text-white">กำลังโหลด...</h2>
    <div class="glass-white rounded-full flex items-center p-1 space-x-2">
      <div id="pointVal" class="font-bold neon-text text-lg px-2">0</div>
      <img id="lineDisplayPicture" class="mask mask-circle w-10 h-10 rounded-full object-cover border border-black" src="https://img.daisyui.com/images/stock/photo-1567653418876-5bb0e566e1c2.webp" />
    </div>
  </div>
  
  <!-- Main App Container -->
  <div id="app">
    <div class="text-center text-gray-100 py-8">กำลังโหลดเนื้อหา...</div>
  </div>
  
  <!-- Dialogs -->
  <dialog id="customAlertDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="customAlertTitle" class="font-bold text-lg mb-3"></h3>
      <p id="customAlertMessage" class="py-4 whitespace-pre-line"></p>
      <div class="modal-action justify-center">
        <button id="customAlertButton" class="btn btn-neutral w-full">ตกลง</button>
      </div>
    </div>
  </dialog>
  
  <dialog id="customConfirmDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="customConfirmTitle" class="font-bold text-lg mb-3"></h3>
      <p id="customConfirmMessage" class="py-4"></p>
      <div class="modal-action justify-around">
        <button id="customConfirmCancelButton" class="btn btn-outline btn-neutral">ยกเลิก</button>
        <button id="customConfirmConfirmButton" class="btn btn-neutral">ยืนยัน</button>
      </div>
    </div>
  </dialog>

  <!-- QR Code Dialog (for Warehouse) -->
  <dialog id="qrDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="qrDialogTitle" class="font-bold text-lg mb-2">สแกนเพื่อรับของ</h3>
      <p id="qrDialogItemName" class="mb-4 text-sm text-gray-600"></p>
      <div id="qrcode" class="flex justify-center mb-4 p-4 bg-white rounded-lg"></div> 
      <p class="text-xs text-gray-500 mb-4">ให้พนักงานสแกน QR Code นี้เพื่อตรวจสอบและยืนยันการรับสินค้า</p>
      <div class="modal-action justify-around">
        <button id="qrDialogCloseBtn" class="btn btn-outline">ปิด</button>
        <button id="qrDialogConfirmBtn" class="btn btn-neutral">ยืนยันการรับของ</button>
      </div>
    </div>
  </dialog>

  <!-- Template: Dashboard (Main Menu) -->
  <template id="view-dashboard">
    <div class="glass-white rounded p-4 grid grid-cols-3 gap-3 text-center text-sm font-medium mb-6">
      <a href="#event" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
        <span>กิจกรรม</span>
      </a>
      <a href="#warehouse" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
        <span>คลัง</span>
      </a>
      <a href="#addpoint" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="none"><path d="M2.5 8.18677C2.60406 6.08705 2.91537 4.77792 3.84664 3.84664C4.77792 2.91537 6.08705 2.60406 8.18677 2.5M21.5 8.18677C21.3959 6.08705 21.0846 4.77792 20.1534 3.84664C19.2221 2.91537 17.9129 2.60406 15.8132 2.5M15.8132 21.5C17.9129 21.3959 19.2221 21.0846 20.1534 20.1534C21.0846 19.2221 21.3959 17.9129 21.5 15.8132M8.18676 21.5C6.08705 21.3959 4.77792 21.0846 3.84664 20.1534C2.91537 19.2221 2.60406 17.9129 2.5 15.8132" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path><path d="M2.49986 12H21.4999" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path><path d="M6 12C6 8.68629 8.68629 6 12 6C12 7.65685 13.3431 9 15 9C15.6755 9 16.2989 8.77672 16.8004 8.39993C17.5536 9.40273 18 10.6492 18 12M17.1973 15C16.1599 16.7934 14.2208 18 12 18C9.77915 18 7.84012 16.7934 6.80269 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        <span>สแกนรับ</span>
      </a>
      <a href="#transfer" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
        <span>โอนพ้อย</span>
      </a>
      <a href="#redeem" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
        <span>แลกพ้อย</span>
      </a>
      <a href="#profile" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        <span>บัญชี</span>
      </a>
    </div>

    <div id="checkinBox" class="flex items-center justify-between mb-8 hidden">
      <div class="bg-gray-100 rounded-full px-4 py-2 flex items-center space-x-2 text-gray-700">
        <span class="text-sm">วันที่</span><span id="todayDate" class="font-bold text-md">00</span>
      </div>
      <div class="bg-yellow-400 rounded-full w-10 h-10 flex items-center justify-center text-white font-bold text-sm">+1</div>
      <button id="checkinBtn" class="btn btn-neutral btn-sm">เช็คอิน</button>
    </div>

    <div>
      <div class="flex justify-between items-center mb-4">
        <div class="font-bold text-lg">รายการล่าสุด</div>
        <div class="text-xs text-gray-400 font-medium">POINT</div>
      </div>
      <ul id="historyList" class="space-y-4"></ul>
    </div>
  </template>

  <!-- Template: Event List -->
  <template id="view-event">
    <div id="eventList" class="space-y-3"></div>
  </template>

  <!-- Template: Event Detail -->
  <template id="view-event-detail">
    <div id="cardWrapper">
      <div id="cardSkeleton" class="bg-white p-6 rounded shadow-md mb-6 animate-pulse"><div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div><div class="h-4 bg-gray-200 rounded w-1/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-full mb-6"></div><div class="h-12 bg-gray-200 rounded-full w-full"></div></div>
      <div id="card" class="bg-white p-6 rounded shadow-md text-gray-800 mb-6 hidden">
        <div class="flex justify-between items-start mb-3"><div class="font-bold text-lg" id="eventDetailTitle">–</div><div class="bg-yellow-400 text-black font-bold text-md px-3 py-1 rounded-full" id="eventPoint">0+</div></div>
        <div class="text-sm text-gray-700 mb-6 leading-relaxed" id="eventDetailDesc">...</div>
        <button id="joinBtn" class="btn btn-neutral w-full">เข้าร่วม</button>
      </div>
    </div>
  </template>

  <!-- Template: Profile -->
  <template id="view-profile">
    <div class="space-y-4">
      <div class="glass-white p-6 rounded-lg text-center shadow-md">
        <div class="relative w-24 h-24 mx-auto mb-4">
          <img id="profileDisplayPicture" class="mask mask-circle w-24 h-24 rounded-full object-cover border-4 border-black" src="https://img.daisyui.com/images/stock/photo-1567653418876-5bb0e566e1c2.webp" alt="รูปโปรไฟล์" />
          <button id="editProfileBtn" class="absolute bottom-0 right-0 bg-white rounded-full p-1.5 shadow-md hover:scale-110 transition-transform"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.389-2.828-2.828z" /></svg></button>
        </div>
        <div class="text-2xl font-bold mb-2" id="profileDisplayName">กำลังโหลด...</div>
        <div class="flex items-center justify-center space-x-2 mb-2"><span id="profileLevelBadge" class="badge badge-lg"></span><span id="profileCustomTagBadge" class="badge badge-lg"></span></div>
        <progress id="profileProgressBar" class="progress progress-warning w-full" value="0" max="100"></progress>
        <div id="profilePointsToNextLevel" class="text-sm text-gray-700 mt-1"></div>
        <div class="font-bold text-xl mt-4">รวมพ้อยต์: <span id="profileTotalPoints">0</span></div>
      </div>
      <div id="profileFormContainer" class="bg-white p-6 rounded-lg shadow-md space-y-4 hidden">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">LINE ID</label><input id="profileLineId" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label><input id="profileName" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label><input id="profilePhone" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label><input id="profileEmail" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่</label><input id="profileAddress" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label><input id="profileNote" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div id="profileEditButtons" class="flex space-x-2 hidden"><button id="saveProfileBtn" class="btn btn-neutral flex-1">บันทึกข้อมูล</button><button id="cancelEditBtn" class="btn btn-outline btn-neutral flex-1">ยกเลิก</button></div>
      </div>
    </div>
  </template>

  <!-- Template: Redeem -->
  <template id="view-redeem">
    <div class="p-0"><ul id="redeemList" class="grid grid-cols-2 gap-4"></ul></div>
  </template>

  <!-- Template: Transfer -->
  <template id="view-transfer">
    <div class="space-y-4 mb-6">
      <input id="transferTo" placeholder="LINE ID เพื่อน / เบอร์โทรปลายทาง" type="text" class="input input-bordered input-neutral w-full">
      <input id="transferAmount" placeholder="จำนวนพ้อยที่ต้องการโอน" type="number" class="input input-bordered input-neutral w-full">
      <button id="transferBtn" class="btn btn-neutral w-full">โอนพ้อย</button>
    </div>
  </template>

  <!-- Template: Warehouse -->
  <template id="view-warehouse">
    <ul id="warehouseList" class="space-y-3"></ul>
  </template>

  <!-- Template: Add Points (Scan/Manual Code) -->
  <template id="view-addpoint">
    <div id="scanContainer" class="space-y-4 mb-6">
      <button id="scanBtn" class="btn btn-neutral w-full">สแกน QR Code</button>
      <div class="flex space-x-2">
        <input id="manualCode" type="text" placeholder="กรอกโค้ดที่นี่" class="input input-bordered input-neutral flex-1">
        <button id="enterBtn" class="btn btn-neutral">รับโค้ด</button>
      </div>
    </div>
  </template>

<!-- Shipping Form Dialog (for Physical Items) -->
<dialog id="shippingFormDialog" class="modal">
  <div class="modal-box">
    <h3 id="shippingFormTitle" class="font-bold text-lg mb-4">ข้อมูลสำหรับจัดส่ง</h3>
    <div class="space-y-4">
      <div>
        <label class="label"><span class="label-text">ชื่อ-นามสกุล ผู้รับ</span></label>
        <input id="shippingName" type="text" placeholder="กรอกชื่อ-นามสกุล" class="input input-bordered w-full" />
      </div>
      <div>
        <label class="label"><span class="label-text">เบอร์โทรศัพท์ติดต่อ</span></label>
        <input id="shippingPhone" type="tel" placeholder="กรอกเบอร์โทรศัพท์" class="input input-bordered w-full" />
      </div>
      <div>
        <label class="label"><span class="label-text">ที่อยู่สำหรับจัดส่ง</span></label>
        <textarea id="shippingAddress" class="textarea textarea-bordered w-full" rows="4" placeholder="บ้านเลขที่, ถนน, ตำบล, อำเภอ, จังหวัด, รหัสไปรษณีย์"></textarea>
      </div>
    </div>
    <div class="modal-action justify-between mt-6">
      <button id="shippingFormCancelBtn" class="btn btn-outline">ยกเลิก</button>
      <button id="shippingFormConfirmBtn" class="btn btn-neutral">ยืนยันและแลกของ</button>
    </div>
  </div>
</dialog>
  <script>
    // --- GLOBAL STATE & CACHE ---
    let liffInitialized = false;
    const userState = { profile: null, lineId: "", points: 0, pointsChanged: false, level: "Member", customTag: "" };
    const dataCache = { events: null, redeemItems: null, eventDetails: {}, userProfileFull: null, history: null, levelSettings: null };

    // --- DIALOGS & UI ELEMENTS ---
    const alertDialog = document.getElementById('customAlertDialog'), alertT = document.getElementById('customAlertTitle'), alertM = document.getElementById('customAlertMessage'), alertBtn = document.getElementById('customAlertButton');
    const confirmDialog = document.getElementById('customConfirmDialog'), confT = document.getElementById('customConfirmTitle'), confM = document.getElementById('customConfirmMessage'), okBtn = document.getElementById('customConfirmConfirmButton'), noBtn = document.getElementById('customConfirmCancelButton');
    const pageTitleEl = document.getElementById('pageTitle'), pointValEl = document.getElementById('pointVal'), dpEl = document.getElementById('lineDisplayPicture');

    // --- STYLES ---
    const LEVEL_STYLES = { 'Member': { text: 'Member', class: 'badge-info badge-outline' }, 'VIP': { text: 'VIP', class: 'badge-primary badge-outline' }, 'Super': { text: 'Super', class: 'badge-success badge-outline' } };
    const CUSTOM_TAG_STYLES = { 'newuser': { class: 'badge-warning', text: 'สมาชิกใหม่' }, 'ceo': { class: 'badge-accent', text: 'CEO' }, 'admin': { class: 'badge-error', text: 'ผู้ดูแล' }, 'tester': { class: 'badge-secondary', text: 'ผู้ทดสอบ' }, 'default': { class: 'badge-neutral', text: '' } };

    // --- COMMON UI FUNCTIONS ---
    function showAlert(title, message, cb) {
      alertT.textContent = title; alertM.textContent = message; alertDialog.showModal();
      const hide = () => { alertDialog.close(); alertBtn.removeEventListener('click', hide); cb && cb(); };
      alertBtn.addEventListener('click', hide);
    }
    function showConfirm(title, message) {
      return new Promise(res => {
        confT.textContent = title; confM.textContent = message; confirmDialog.showModal();
        const onOk = () => { cleanup(); res(true); }; const onNo = () => { cleanup(); res(false); };
        function cleanup() { confirmDialog.close(); okBtn.removeEventListener('click', onOk); noBtn.removeEventListener('click', onNo); }
        okBtn.addEventListener('click', onOk); noBtn.addEventListener('click', onNo);
      });
    }

    // --- DATA & STATE MANAGEMENT ---
    function calculateLevelAndProgress(currentPoints) {
      const vipPoints = dataCache.levelSettings?.VIP_points || 5000;
      const superPoints = dataCache.levelSettings?.SUPER_points || 10000;
      let level = 'Member', currentLevelMin = 0, nextLevelMin = vipPoints, nextLevelName = 'VIP';
      if (currentPoints >= superPoints) { level = 'Super'; currentLevelMin = superPoints; nextLevelMin = currentPoints; nextLevelName = ''; }
      else if (currentPoints >= vipPoints) { level = 'VIP'; currentLevelMin = vipPoints; nextLevelMin = superPoints; nextLevelName = 'Super'; }
      const pointsInCurrentTier = currentPoints - currentLevelMin; const pointsToNextTier = nextLevelMin - currentLevelMin;
      let progressValue = 0, pointsNeeded = 0;
      if (nextLevelName) { progressValue = (pointsInCurrentTier / pointsToNextTier) * 100; pointsNeeded = nextLevelMin - currentPoints; }
      else { progressValue = 100; pointsNeeded = 0; }
      return { level, progressValue: Math.min(100, Math.max(0, progressValue)), pointsToNext: pointsNeeded, nextLevelName };
    }
    function setBadgeContent(badgeElement, text, className) {
      if (!badgeElement) return; badgeElement.textContent = text; badgeElement.className = className;
      if (text) badgeElement.classList.remove('hidden'); else badgeElement.classList.add('hidden');
    }
    async function fetchAndUpdateUserState() {
      try {
        const userRes = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`);
        const userData = await userRes.json();
        if (userData && !userData.error) {
          userState.points = parseInt(userData.point || 0, 10);
          userState.level = userData.level || 'Member';
          userState.customTag = userData.customTag || '';
          dataCache.userProfileFull = userData;
          pointValEl.textContent = userState.points;
          userState.pointsChanged = true;
          console.log(`User state updated: Points=${userState.points}, Level=${userState.level}, Tag=${userState.customTag}`);
        } else { console.error("Failed to fetch user data after action:", userData?.error || "Unknown error"); }
      } catch (e) { console.error("Error fetching user info after action:", e); }
    }

    // --- LIFF & APP INITIALIZATION ---
    async function ensureLIFFAndFetchInitialData() {
      if (!liffInitialized) {
        try { await liff.init({ liffId: CONFIG.LIFF_ID }); liffInitialized = true; }
        catch (e) { console.error("LIFF initialization failed", e); showAlert("ข้อผิดพลาด", "ไม่สามารถเริ่มต้น LIFF ได้ กรุณาลองใหม่ภายหลัง"); return false; }
      }
      if (!liff.isLoggedIn()) { liff.login(); return false; }
      if (!userState.profile) {
        userState.profile = await liff.getProfile(); userState.lineId = userState.profile.userId;
        dpEl.src = userState.profile.pictureUrl || 'https://via.placeholder.com/40';
        dpEl.alt = `รูปโปรไฟล์ของ ${userState.profile.displayName}`;
      }
      pointValEl.textContent = '...';
      try {
        const [userRes, histRes, eventsRes, redeemRes, settingsRes] = await Promise.all([
          fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`),
          fetch(`${CONFIG.GAS_URL}?action=getHistory&lineId=${userState.lineId}`),
          fetch(`${CONFIG.GAS_URL}?action=getEvents`),
          fetch(`${CONFIG.GAS_URL}?action=getItems`),
          fetch(`${CONFIG.GAS_URL}?action=getLevelConfig`)
        ]);
        const userData = await userRes.json(); const historyData = await histRes.json();
        dataCache.events = await eventsRes.json(); dataCache.redeemItems = await redeemRes.json();
        const settingsData = await settingsRes.json();
        if (settingsData && !settingsData.error) { dataCache.levelSettings = { VIP_points: parseInt(settingsData.VIP_points || 0), SUPER_points: parseInt(settingsData.SUPER_points || 0) }; }
        else { console.warn("Failed to load level settings, using defaults."); dataCache.levelSettings = { VIP_points: 5000, SUPER_points: 10000 }; }
        if (!userData || !userData.isRegistered) { window.location.href = 'register.html'; return false; }
        userState.points = parseInt(userData.point || 0, 10);
        userState.level = userData.level || 'Member'; userState.customTag = userData.customTag || '';
        dataCache.userProfileFull = userData; pointValEl.textContent = userState.points;
        dataCache.history = historyData; userState.pointsChanged = false;
      } catch (error) { console.error("Failed to fetch initial data:", error); pointValEl.textContent = 'N/A'; showAlert("ข้อผิดพลาด", "ไม่สามารถโหลดข้อมูลผู้ใช้ได้ กรุณาลองใหม่"); return false; }
      return true;
    }

    // --- ROUTER ---
    const routes = {
      '#dashboard': { title: 'CRM-3RN', tpl: 'view-dashboard', init: initDashboard },
      '#event': { title: 'กิจกรรม', tpl: 'view-event', init: initEvent },
      '#event-detail': { title: 'รายละเอียดกิจกรรม', tpl: 'view-event-detail', init: initEventDetail },
      '#profile': { title: 'โปรไฟล์ของคุณ', tpl: 'view-profile', init: initProfile },
      '#redeem': { title: 'ร้านค้าแลกของรางวัล', tpl: 'view-redeem', init: initRedeem },
      '#transfer': { title: 'โอนพ้อยให้เพื่อน', tpl: 'view-transfer', init: initTransfer },
      '#warehouse': { title: 'คลังของรางวัล', tpl: 'view-warehouse', init: initWarehouse },
      '#addpoint': { title: 'โค้ดเพื่อรับรางวัล', tpl: 'view-addpoint', init: initAddpoint },
      '': { title: 'CRM-3RN', tpl: 'view-dashboard', init: initDashboard }
    };
    async function router() {
      const hash = window.location.hash.split('?')[0] || '';
      const route = routes[hash] || routes[''];
      pageTitleEl.textContent = route.title;
      const appDiv = document.getElementById('app'); appDiv.innerHTML = '';
      const template = document.getElementById(route.tpl);
      if (template) { appDiv.appendChild(template.content.cloneNode(true)); }
      else { appDiv.innerHTML = `<p class="text-center text-red-500 py-8">เกิดข้อผิดพลาด: ไม่พบเทมเพลตสำหรับ ${hash}</p>`; return; }
      try { await route.init(); }
      catch (error) { console.error(`Error initializing view ${route.tpl}:`, error); showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลหน้านี้ได้'); }
    }

    // --- SKELETONS & HELPERS ---
    function generateListSkeleton(count) { return Array.from({ length: count }).map(_ => `<li class="flex justify-between items-center animate-pulse py-3"><div class="space-y-2 flex-1"><div class="h-4 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-1/3 mt-1"></div></div><div class="h-6 w-12 bg-gray-200 rounded-full"></div></li>`).join(""); }
    function generateCardSkeleton(count) { return Array.from({ length: count }).map(_ => `<li class="bg-white p-4 rounded shadow-sm loading-card-animation"><div class="h-24 bg-gray-200 rounded-md mb-3"></div><div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div><div class="h-8 bg-gray-200 rounded-full w-full"></div></li>`).join(''); }
    function renderHistoryList(historyData) {
      const el = document.getElementById('historyList'); if (!el) return;
      const latest = historyData.slice().reverse().slice(0, 10);
      if (latest.length === 0) { el.innerHTML = `<li class="text-center text-gray-400 py-4">ไม่มีประวัติการทำรายการ</li>`; return; }
      el.innerHTML = latest.map(item => {
        const isDebit = ['redeem', 'transfer_out'].includes(item.type);
        return `<li class="flex justify-between items-center"><div><div class="font-medium text-gray-800 text-sm">${item.detail}</div><div class="text-xs text-gray-400 mt-1">${item.date}</div></div><div class="text-sm font-bold px-4 py-1.5 rounded-full ${isDebit ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${isDebit ? '-' : '+'} ${item.amount}</div></li>`;
      }).join("");
    }
    async function getFreshOrCachedHistory() {
      if (userState.pointsChanged || !dataCache.history) {
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?action=getHistory&lineId=${userState.lineId}`);
          dataCache.history = await res.json(); userState.pointsChanged = false;
        } catch (e) { console.error("Error fetching history:", e); dataCache.history = []; userState.pointsChanged = false; }
      } return dataCache.history;
    }

    // --- VIEW INITIALIZATION FUNCTIONS ---

    async function initDashboard() {
      const historyListEl = document.getElementById('historyList'), checkinBox = document.getElementById('checkinBox'), todayDateEl = document.getElementById('todayDate'), checkinBtn = document.getElementById('checkinBtn');
      if (dataCache.history && !userState.pointsChanged) renderHistoryList(dataCache.history);
      else if (historyListEl) historyListEl.innerHTML = generateListSkeleton(5);
      try {
        const [checkData, history] = await Promise.all([fetch(`${CONFIG.GAS_URL}?action=checkinStatus&lineId=${userState.lineId}`).then(r => r.json()), getFreshOrCachedHistory()]);
        renderHistoryList(history);
        if (checkinBox && !checkData.checkedInToday) {
          checkinBox.classList.remove('hidden'); todayDateEl.textContent = new Date().getDate().toString().padStart(2, "0");
          checkinBtn.onclick = async () => {
            checkinBtn.disabled = true;
            try {
              const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify({ action: "dailyCheckin", lineId: userState.lineId }) });
              const text = await res.text();
              showAlert('เช็คอินสำเร็จ', text, async () => { if (text.includes("สำเร็จ")) { await fetchAndUpdateUserState(); checkinBox.classList.add('hidden'); initDashboard(); } });
            } catch (e) { console.error("Check-in failed:", e); showAlert('ข้อผิดพลาด', 'ไม่สามารถเช็คอินได้'); } finally { checkinBtn.disabled = false; }
          };
        } else if (checkinBox) { checkinBox.classList.add('hidden'); }
      } catch (e) { console.error("Error in initDashboard:", e); if (historyListEl) historyListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาด</li>`; }
    }

    async function initEvent() {
      const eventListEl = document.getElementById('eventList');
      if (eventListEl) eventListEl.innerHTML = generateListSkeleton(5);
      let events = dataCache.events || [];
      if (!dataCache.events) {
        try {
            const res = await fetch(`${CONFIG.GAS_URL}?action=getEvents`);
            events = await res.json(); dataCache.events = events;
        } catch (e) { console.error("Error fetching events:", e); if (eventListEl) eventListEl.innerHTML = `<div class="text-center text-red-500 py-8">เกิดข้อผิดพลาดในการโหลดกิจกรรม</div>`; return; }
      }
      if (!events || events.length === 0) { eventListEl.innerHTML = `<div class="text-center text-gray-400 py-8">ไม่มีกิจกรรมในขณะนี้</div>`; return; }
      const filteredEvents = events.filter(e => !e.allowedLevels || e.allowedLevels.length === 0 || e.allowedLevels.includes(userState.level));
      if (filteredEvents.length === 0) { eventListEl.innerHTML = `<div class="text-center text-gray-400 py-8">ไม่มีกิจกรรมสำหรับระดับของคุณ</div>`; return; }
      eventListEl.innerHTML = filteredEvents.map(e => `<div class="bg-white rounded p-4 flex justify-between items-center shadow-sm"><div><div class="font-semibold text-gray-800 text-sm">${e.title}</div><div class="text-xs text-gray-500">${e.detail || 'ดูรายละเอียดกิจกรรม'}</div></div><a href="#event-detail?id=${e.id}" class="btn btn-neutral">ดูรายละเอียด</a></div>`).join('');
    }

    async function initEventDetail() {
      const params = new URLSearchParams(window.location.hash.split('?')[1]);
      const eventId = params.get("id");
      const cardSkeleton = document.getElementById('cardSkeleton'), card = document.getElementById('card'), titleEl = document.getElementById('eventDetailTitle'), descEl = document.getElementById('eventDetailDesc'), pointEl = document.getElementById('eventPoint'), joinBtn = document.getElementById('joinBtn');
      cardSkeleton.classList.remove('hidden'); card.classList.add('hidden');
      
      let eventData = dataCache.eventDetails[eventId];
      if (!eventData) {
        try { const res = await fetch(`${CONFIG.GAS_URL}?action=getEventById&id=${eventId}`); eventData = await res.json(); if (!eventData.error) dataCache.eventDetails[eventId] = eventData; }
        catch (e) { console.error("Error fetching event detail:", e); eventData = { error: "ไม่สามารถโหลดรายละเอียดได้" }; }
      }
      
      const history = await getFreshOrCachedHistory();
      if (eventData.error) { titleEl.textContent = "ไม่พบกิจกรรม"; descEl.textContent = eventData.error; joinBtn.disabled = true; }
      else {
        titleEl.textContent = eventData.title; pointEl.textContent = `${eventData.point}+`; descEl.textContent = eventData.desc;
        const hasJoined = history.some(item => item.type === 'event' && item.eventId === eventId);
        const isLevelAllowed = !eventData.allowedLevels || eventData.allowedLevels.length === 0 || eventData.allowedLevels.includes(userState.level);
        if (hasJoined) { joinBtn.textContent = "รับพ้อยต์แล้ว"; joinBtn.disabled = true; }
        else if (!isLevelAllowed) { joinBtn.textContent = `สำหรับระดับ ${eventData.allowedLevels.join(', ')}`; joinBtn.disabled = true; }
        else {
          joinBtn.onclick = async () => {
            if (!(await showConfirm('ยืนยัน', `เข้าร่วม "${eventData.title}" และรับ ${eventData.point} พ้อยต์?`))) return;
            joinBtn.disabled = true;
            try {
              const res = await fetch(CONFIG.GAS_URL, { method: "POST", body: JSON.stringify({ action: "joinEvent", lineId: userState.lineId, eventId, title: eventData.title, point: eventData.point }) });
              const text = await res.text();
              showAlert("สถานะ", text, async () => { if (text.includes("สำเร็จ")) { await fetchAndUpdateUserState(); joinBtn.textContent = "รับพ้อยต์แล้ว"; } });
            } catch (e) { console.error("Join event failed:", e); showAlert('ข้อผิดพลาด', 'ไม่สามารถเข้าร่วมได้'); }
            finally { if (joinBtn.textContent !== "รับพ้อยต์แล้ว") joinBtn.disabled = false; }
          };
        }
      }
      cardSkeleton.classList.add("hidden"); card.classList.remove("hidden");
    }

    async function initProfile() {
      const dpEl = document.getElementById('profileDisplayPicture'), dnEl = document.getElementById('profileDisplayName'), lineIdEl = document.getElementById('profileLineId'), levelBadgeEl = document.getElementById('profileLevelBadge'), tagBadgeEl = document.getElementById('profileCustomTagBadge'), progressEl = document.getElementById('profileProgressBar'), progressTextEl = document.getElementById('profilePointsToNextLevel'), totalPointsEl = document.getElementById('profileTotalPoints'), nameEl = document.getElementById('profileName'), phoneEl = document.getElementById('profilePhone'), emailEl = document.getElementById('profileEmail'), addressEl = document.getElementById('profileAddress'), noteEl = document.getElementById('profileNote'), editBtn = document.getElementById('editProfileBtn'), formContainer = document.getElementById('profileFormContainer'), editButtonsDiv = document.getElementById('profileEditButtons'), saveBtn = document.getElementById('saveProfileBtn'), cancelBtn = document.getElementById('cancelEditBtn');
      const editableInputs = [nameEl, phoneEl, emailEl, addressEl, noteEl]; let initialData = {};
      
      dpEl.src = userState.profile.pictureUrl || 'https://via.placeholder.com/96'; dnEl.textContent = userState.profile.displayName || 'ผู้ใช้ LINE';
      totalPointsEl.textContent = userState.points.toLocaleString();
      const { level, progressValue, pointsToNext, nextLevelName } = calculateLevelAndProgress(userState.points);
      setBadgeContent(levelBadgeEl, LEVEL_STYLES[userState.level]?.text || userState.level, `badge badge-lg ${LEVEL_STYLES[userState.level]?.class || ''}`);
      const primaryTag = (userState.customTag.split(',')[0] || '').trim().toLowerCase();
      const tagInfo = CUSTOM_TAG_STYLES[primaryTag] || CUSTOM_TAG_STYLES['default'];
      const tagText = tagInfo.text || (primaryTag ? primaryTag.charAt(0).toUpperCase() + primaryTag.slice(1) : '');
      if (!tagText) tagBadgeEl.classList.add('hidden'); else setBadgeContent(tagBadgeEl, tagText, `badge badge-lg ${tagInfo.class}`);
      progressEl.value = progressValue;
      progressTextEl.textContent = nextLevelName ? `อีก ${pointsToNext.toLocaleString()} พ้อยต์สู่ ${nextLevelName}` : `คุณอยู่ระดับสูงสุดแล้ว!`;
      
      let uData = dataCache.userProfileFull;
      if (!uData) { try { uData = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`).then(r => r.json()); if (!uData.error) dataCache.userProfileFull = uData; } catch (e) { uData = { error: 'โหลดข้อมูลล้มเหลว' }; } }
      
      if (uData.error) { showAlert('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลโปรไฟล์ได้'); return; }
      
      initialData = { name: uData.name || '', phone: uData.phone || '', email: uData.email || '', address: uData.address || '', note: uData.note || '' };
      lineIdEl.value = userState.lineId; nameEl.value = initialData.name; phoneEl.value = initialData.phone; emailEl.value = initialData.email; addressEl.value = initialData.address; noteEl.value = initialData.note;

      const toggleEditMode = (enable) => {
        editableInputs.forEach(input => { input.readOnly = !enable; input.classList.toggle('input-neutral', enable); input.classList.toggle('cursor-not-allowed', !enable); input.classList.toggle('text-gray-500', !enable); });
        formContainer.classList.toggle('hidden', !enable); editBtn.classList.toggle('hidden', enable); editButtonsDiv.classList.toggle('hidden', !enable);
      };
      
      editBtn.onclick = () => toggleEditMode(true);
      cancelBtn.onclick = () => { Object.keys(initialData).forEach(k => document.getElementById(`profile${k.charAt(0).toUpperCase() + k.slice(1)}`).value = initialData[k]); toggleEditMode(false); };
      saveBtn.onclick = async () => {
        saveBtn.disabled = true; cancelBtn.disabled = true;
        try {
          const body = { action: 'updateProfile', lineId: userState.lineId, name: nameEl.value, phone: phoneEl.value, email: emailEl.value, address: addressEl.value, note: noteEl.value };
          const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify(body) });
          const text = await res.text();
          showAlert("สถานะ", text, async () => { if (text.includes("สำเร็จ")) { await fetchAndUpdateUserState(); toggleEditMode(false); } });
        } catch (e) { console.error("Update profile failed:", e); showAlert('ข้อผิดพลาด', 'ไม่สามารถอัปเดตได้'); } finally { saveBtn.disabled = false; cancelBtn.disabled = false; }
      };
      toggleEditMode(false);
    }
    
  // ในไฟล์ index.html (แทนที่ฟังก์ชัน initRedeem เดิมทั้งหมด)
async function initRedeem() {
    const redeemListEl = document.getElementById('redeemList');
    if (redeemListEl) redeemListEl.innerHTML = generateCardSkeleton(4);
    
    let items = dataCache.redeemItems || [];
    if (!dataCache.redeemItems || dataCache.redeemItems.length === 0) {
        try {
            const res = await fetch(`${CONFIG.GAS_URL}?action=getItems`);
            items = await res.json();
            if (items.error) throw new Error(items.error);
            dataCache.redeemItems = items;
        } catch (e) {
            console.error("Error fetching items:", e);
            if (redeemListEl) redeemListEl.innerHTML = `<li class="col-span-2 text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดของรางวัล</li>`;
            return;
        }
    }
    
    if (!items || items.length === 0) {
        redeemListEl.innerHTML = `<li class="col-span-2 text-center text-gray-400 py-4">ไม่มีของรางวัลให้แลก</li>`;
        return;
    }

    redeemListEl.innerHTML = items.map(item => `
        <li class="bg-white p-4 rounded shadow-sm text-center flex flex-col justify-between">
            <div>
              <img src="${item.image}" alt="${item.name}" class="h-24 w-full object-cover mx-auto mb-2 rounded-md">
              <div class="font-bold mb-1">${item.name}</div>
              <div class="text-sm text-gray-600 mb-2">${item.point} พ้อยต์</div>
            </div>
            <button 
                data-item-id="${item.id}" 
                data-item-name="${item.name}" 
                data-item-point="${item.point}"
                data-item-type="${item.type}"  // <-- เพิ่มประเภทของสินค้า
                class="redeem-btn btn btn-neutral btn-sm mt-2">
                แลกเลย
            </button>
        </li>
    `).join('');

    // === เพิ่ม Event Listener ที่จะจัดการทั้งสองกรณี ===
    document.querySelectorAll('.redeem-btn').forEach(btn => {
        btn.addEventListener('click', handleRedeemClick);
    });
}

// === สร้างฟังก์ชันใหม่สำหรับจัดการการคลิกปุ่มแลกของ ===
async function handleRedeemClick(event) {
    const btn = event.currentTarget;
    const { itemId, itemName, itemPoint, itemType } = btn.dataset;
    const point = parseInt(itemPoint, 10);

    if (userState.points < point) {
        showAlert("ไม่เพียงพอ", `แต้มของคุณ (${userState.points}) ไม่พอสำหรับแลก "${itemName}" ซึ่งใช้ ${point} พ้อยต์`);
        return;
    }

    // ตรวจสอบประเภทของสินค้า
    if (itemType === 'physical') {
        // ถ้าเป็นสินค้าที่ต้องจัดส่ง ให้แสดงฟอร์ม
        showShippingForm({ itemId, itemName, point });
    } else {
        // ถ้าเป็น digital ให้ใช้ขั้นตอนยืนยันแบบเดิม
        const confirmed = await showConfirm(`ยืนยันการแลก`, `แลก "${itemName}" ด้วย ${point} พ้อยต์ ใช่หรือไม่?`);
        if (!confirmed) return;

        // เรียกฟังก์ชันที่ใช้แลกของ (ไม่มีข้อมูลที่อยู่)
        await executeRedemption(btn, { itemId, point });
    }
}

// === สร้างฟังก์ชันใหม่สำหรับแสดงฟอร์มที่อยู่ ===
function showShippingForm(item) {
    const dialog = document.getElementById('shippingFormDialog');
    const titleEl = document.getElementById('shippingFormTitle');
    const nameInput = document.getElementById('shippingName');
    const phoneInput = document.getElementById('shippingPhone');
    const addressInput = document.getElementById('shippingAddress');
    const confirmBtn = document.getElementById('shippingFormConfirmBtn');
    const cancelBtn = document.getElementById('shippingFormCancelBtn');

    titleEl.textContent = `ข้อมูลจัดส่งสำหรับ: ${item.itemName}`;

    // พยายามดึงข้อมูลโปรไฟล์ผู้ใช้มาใส่ในฟอร์มอัตโนมัติ
    const profile = dataCache.userProfileFull || {};
    nameInput.value = profile.name || '';
    phoneInput.value = profile.phone || '';
    addressInput.value = profile.address || '';

    dialog.showModal();

    const handleConfirm = async () => {
        const shippingName = nameInput.value.trim();
        const shippingPhone = phoneInput.value.trim();
        const shippingAddress = addressInput.value.trim();

        // ตรวจสอบข้อมูลเบื้องต้น
        if (!shippingName || !shippingPhone || !shippingAddress) {
            showAlert("ข้อมูลไม่ครบ", "กรุณากรอกชื่อ, เบอร์โทร, และที่อยู่ให้ครบถ้วน");
            return;
        }

        dialog.close(); // ปิดฟอร์มก่อน

        // ค้นหาปุ่มที่ถูกคลิกเพื่อส่งไป disable
        const originalButton = document.querySelector(`.redeem-btn[data-item-id="${item.itemId}"]`);

        // เรียกฟังก์ชันแลกของ โดยส่งข้อมูลที่อยู่ไปด้วย
        await executeRedemption(originalButton, {
            itemId: item.itemId,
            point: item.point,
            shippingInfo: {
                name: shippingName,
                phone: shippingPhone,
                address: shippingAddress
            }
        });
    };

    confirmBtn.onclick = handleConfirm;
    cancelBtn.onclick = () => dialog.close();
}

// === สร้างฟังก์ชันกลางสำหรับส่งข้อมูลการแลกไปที่ Backend ===
async function executeRedemption(buttonElement, payload) {
    buttonElement.disabled = true;
    buttonElement.textContent = "กำลังแลก...";

    try {
        const body = {
            action: 'redeemItem',
            lineId: userState.lineId,
            itemId: payload.itemId,
            point: payload.point,
            // เพิ่ม shippingInfo ถ้ามี
            ...(payload.shippingInfo && { shippingInfo: payload.shippingInfo })
        };

        const res = await fetch(CONFIG.GAS_URL, {
            method: 'POST',
            body: JSON.stringify(body)
        });
        const text = await res.text();

        showAlert("สถานะการแลก", text, async () => {
            if (text.includes("สำเร็จ")) {
                await fetchAndUpdateUserState(); // อัปเดตคะแนน
                buttonElement.textContent = "แลกแล้ว";
                // ไม่ต้อง enable ปุ่มอีกถ้าสำเร็จ
            } else {
                buttonElement.disabled = false; // เปิดปุ่มถ้าไม่สำเร็จ
                buttonElement.textContent = "แลกเลย";
            }
        });
    } catch (e) {
        console.error("Redemption failed:", e);
        showAlert('ข้อผิดพลาด', 'ไม่สามารถทำรายการแลกของได้ กรุณาลองใหม่');
        buttonElement.disabled = false;
        buttonElement.textContent = "แลกเลย";
    }
}

    async function initTransfer() {
      const toEl = document.getElementById('transferTo'), amountEl = document.getElementById('transferAmount'), transferBtn = document.getElementById('transferBtn');
      transferBtn.onclick = async () => {
          const to = toEl.value.trim(), amount = parseInt(amountEl.value, 10);
          if (!to) { showAlert("ข้อผิดพลาด", "กรุณากรอก LINE ID / เบอร์โทรปลายทาง"); return; }
          if (isNaN(amount) || amount <= 0) { showAlert("ข้อผิดพลาด", "กรุณากรอกจำนวนพ้อยต์ให้ถูกต้อง"); return; }
          if (to === userState.lineId) { showAlert("ข้อผิดพลาด", "ไม่สามารถโอนให้ตัวเอง"); return; }
          if (userState.points < amount) { showAlert("ไม่เพียงพอ", `แต้มของคุณ (${userState.points}) ไม่พอสำหรับโอน`); return; }
          if (!(await showConfirm("ยืนยัน", `โอน ${amount} พ้อยต์ให้ ${to}?`))) return;
          transferBtn.disabled = true;
          try {
              const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'transferPoints', from: userState.lineId, to, amount }) });
              const txt = await res.text();
              showAlert("สถานะ", txt, async () => { if (/สำเร็จ|เรียบร้อย/.test(txt)) { await fetchAndUpdateUserState(); toEl.value = ''; amountEl.value = ''; } });
          } catch (e) { showAlert("ข้อผิดพลาด", "ไม่สามารถโอนได้"); }
          finally { transferBtn.disabled = false; }
      };
    }

    async function initAddpoint() {
      const scanContainer = document.getElementById('scanContainer'), scanBtn = document.getElementById('scanBtn'), enterBtn = document.getElementById('enterBtn'), manualInput = document.getElementById('manualCode');
      let scannedCode = "", codeTitle = "", codePoint = 0;
      async function processCode(code) {
          if (!code) return;
          if ((await getFreshOrCachedHistory()).some(item => item.type === 'code' && item.eventId === code)) { showAlert('รับแล้ว', 'คุณรับโค้ดนี้ไปแล้ว'); return; }
          try {
              const res = await fetch(`${CONFIG.GAS_URL}?action=getCodeById&id=${code}`);
              const data = await res.json();
              if (data.error) { showAlert('ไม่พบโค้ด', data.error); return; }
              scannedCode = code; codeTitle = data.title; codePoint = data.point;
              scanContainer.innerHTML = `<div class="bg-white p-6 rounded shadow mb-4"><div class="font-bold text-lg mb-2">${codeTitle}</div><div class="text-sm text-gray-700 mb-4">${data.desc}</div><div class="font-bold text-yellow-600 mb-4">พ้อยต์: ${codePoint}</div><button id="acceptBtn" class="btn btn-neutral">รับพ้อยต์</button></div>`;
              document.getElementById('acceptBtn').addEventListener('click', joinCode);
          } catch (e) { showAlert('ข้อผิดพลาด', 'ไม่สามารถประมวลผลโค้ดได้'); }
      }
      async function joinCode() {
          if (!(await showConfirm('ยืนยัน', `รับ "${codeTitle}" (${codePoint} พ้อยต์)?`))) return;
          const btn = document.getElementById("acceptBtn"); btn.disabled = true;
          try {
              const res = await fetch(CONFIG.GAS_URL, { method: "POST", body: JSON.stringify({ action: "joinCode", lineId: userState.lineId, id: scannedCode, title: codeTitle, point: codePoint }) });
              const text = await res.text();
              showAlert("สถานะ", text, async () => { if (text.includes("สำเร็จ")) { await fetchAndUpdateUserState(); btn.textContent = "รับแล้ว"; } });
          } catch (e) { showAlert('ข้อผิดพลาด', 'ไม่สามารถรับพ้อยต์ได้'); } finally { if (btn.textContent !== "รับแล้ว") btn.disabled = false; }
      }
      scanBtn.onclick = async () => { try { const { value } = await liff.scanCodeV2(); await processCode(value); } catch (e) { showAlert('ข้อผิดพลาด', `สแกนไม่สำเร็จ: ${e.message || 'กรุณาลองใหม่'}`); } };
      enterBtn.onclick = () => processCode(manualInput.value.trim());
    }

    // --- WAREHOUSE ---
    async function initWarehouse() {
      const warehouseListEl = document.getElementById('warehouseList');
      if (warehouseListEl) warehouseListEl.innerHTML = generateListSkeleton(3);

      try {
        const res = await fetch(`${CONFIG.GAS_URL}?action=getWarehouseItems&lineId=${userState.lineId}`);
        const ownedItems = await res.json();
        if (!ownedItems || ownedItems.error) throw new Error(ownedItems.error || 'Failed to load data');
        
        if (ownedItems.length === 0) {
          warehouseListEl.innerHTML = '<li class="text-center text-gray-400 py-4">ยังไม่มีของรางวัลในคลังของคุณ</li>';
          return;
        }
        
        warehouseListEl.innerHTML = ownedItems.map(item => {
          const isClaimed = item.status === 'claimed';
          const statusBadge = `<span class="badge ${isClaimed ? 'badge-success' : 'badge-warning'}">${isClaimed ? 'รับแล้ว' : 'รอรับ'}</span>`;
          const actionArea = isClaimed
            ? `<div class="text-xs text-gray-500 mt-1">วันที่รับ: ${item.claimDate}</div>`
            : `<button class="btn btn-neutral btn-sm claim-btn" data-warehouse-id="${item.warehouseId}" data-item-name="${item.itemName}" data-unique-id="${item.uniqueId}">รับของ</button>`;

          return `<li class="bg-white rounded p-4 shadow-sm flex justify-between items-center">
                    <div><div class="font-semibold text-gray-800 text-sm">${item.itemName}</div><div class="text-xs text-gray-500 mt-1">วันที่แลก: ${item.redeemDate}</div>${statusBadge}</div>
                    <div class="text-right">${actionArea}</div></li>`;
        }).join('');

        document.querySelectorAll('.claim-btn').forEach(button => button.addEventListener('click', handleClaimButtonClick));

      } catch (e) {
        console.error("Error in initWarehouse:", e);
        showAlert("เกิดข้อผิดพลาด", "ไม่สามารถโหลดคลังของรางวัลได้");
        if (warehouseListEl) warehouseListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดคลัง</li>`;
      }
    }

    function handleClaimButtonClick(event) {
        const btn = event.currentTarget;
        const warehouseId = btn.dataset.warehouseId, itemName = btn.dataset.itemName, uniqueId = btn.dataset.uniqueId;
        
        const qrDialog = document.getElementById('qrDialog'), qrDialogTitle = document.getElementById('qrDialogTitle'), qrDialogItemName = document.getElementById('qrDialogItemName'), qrcodeContainer = document.getElementById('qrcode'), qrConfirmBtn = document.getElementById('qrDialogConfirmBtn'), qrCloseBtn = document.getElementById('qrDialogCloseBtn');
        
        qrDialogTitle.textContent = `รับ: ${itemName}`;
        qrDialogItemName.textContent = `ID: ${warehouseId}`;
        qrcodeContainer.innerHTML = '';
        
        try {
            const qr = qrcode(4, 'L');
            qr.addData(uniqueId);
            qr.make();
            qrcodeContainer.innerHTML = qr.createImgTag(6, 4);
        } catch(e) {
            qrcodeContainer.innerHTML = `<p class="text-red-500">ไม่สามารถสร้าง QR Code</p>`;
            console.error(e);
        }

        qrDialog.showModal();

        const confirmHandler = async () => {
            const confirmed = await showConfirm('ยืนยัน', 'คุณต้องการยืนยันว่าได้รับสินค้านี้แล้วใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้');
            if (!confirmed) return;
            
            qrConfirmBtn.disabled = true; qrConfirmBtn.textContent = 'กำลังดำเนินการ...';
            try {
                const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'claimWarehouseItem', lineId: userState.lineId, warehouseId }) });
                const text = await res.text();
                showAlert("สถานะ", text, () => { qrDialog.close(); initWarehouse(); });
            } catch (e) { showAlert('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการยืนยัน'); } 
            finally {
                qrConfirmBtn.disabled = false; qrConfirmBtn.textContent = 'ยืนยันการรับของ';
            }
        };

        const handlerWrapper = () => confirmHandler();
        
        // Remove previous listener if exists and add new one
        qrConfirmBtn.removeEventListener('click', handlerWrapper);
        qrConfirmBtn.addEventListener('click', handlerWrapper, { once: true });
        
        qrCloseBtn.onclick = () => {
            qrConfirmBtn.removeEventListener('click', handlerWrapper);
            qrDialog.close();
        };
    }

    // --- APP START ---
    async function initializeApp() {
      const liffReady = await ensureLIFFAndFetchInitialData();
      if (!liffReady) return;
      window.addEventListener('hashchange', router);
      router();
    }

    initializeApp();
  </script>
</body>
</html>
