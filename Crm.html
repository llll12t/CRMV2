<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CRM-3RN</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind CSS Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'thm-bg': '#b9b9b9', // Main background color
            'thm-primary': '#000000', // Primary action/accent color
            'thm-secondary': '#CCCCCC', // A lighter shade of primary for secondary actions
            'thm-accent': '#EEEEEE', // A light accent color
            'thm-primary-dark': '#333333', // Darker shade for hover
            'thm-secondary-dark': '#adacac', // Darker shade for hover
          },
        },
      },
    };
  </script>

  <!-- Load config before main script -->
  <script src="Config.js"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- QR Code Generator Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

  <style>
    .hidden {
      display: none !important;
    }
    .glass-effect {
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>

<body class="bg-gradient-to-b from-thm-bg via-white to-white min-h-screen relative bg-fixed p-6 text-gray-800 bg-fixed">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 id="pageTitle" class="text-xl font-bold text-primary">สะสมแต้ม</h2>
    <div class="glass-effect rounded-full flex items-center p-1 space-x-2">
      <div id="pointVal" class="font-bold text-primary text-lg px-2"> </div>
      <img id="lineDisplayPicture" class="w-10 h-10 rounded-full object-cover border-2 border-thm-primary-dark"/>
    </div>
  </div>
  <!-- Main App Container -->
  <div id="app">
    <div class="animate-pulse">
      <!-- Skeleton for Menu Grid -->
      <div class="w-full bg-white/15 backdrop-blur-lg rounded-2xl border border-white/20 p-4 grid grid-cols-3 gap-3 text-center text-sm font-medium mb-6">
        <div class="bg-gray-200/80 h-20 rounded-2xl"></div>
        <div class="bg-gray-200/80 h-20 rounded-2xl"></div>
        <div class="bg-gray-200/80 h-20 rounded-2xl"></div>
        <div class="bg-gray-200/80 h-20 rounded-2xl"></div>
        <div class="bg-gray-200/80 h-20 rounded-2xl"></div>
        <div class="bg-gray-200/80 h-20 rounded-2xl"></div>
      </div>
      <!-- Skeleton for History List -->
      <div>
        <div class="flex justify-between items-center mb-4">
          <div class="h-6 bg-gray-300/80 rounded w-1/3"></div>
          <div class="h-4 bg-gray-300/80 rounded w-1/6"></div>
        </div>
        <ul class="space-y-4">
          <li class="flex justify-between items-center bg-gray-200/70 p-3 rounded-lg h-14">
            <div class="flex-1 space-y-2">
              <div class="h-4 bg-gray-300/80 rounded w-3/4"></div>
              <div class="h-3 bg-gray-300/80 rounded w-1/2"></div>
            </div>
            <div class="h-8 w-16 bg-gray-300/80 rounded-full ml-4"></div>
          </li>
          <li class="flex justify-between items-center bg-gray-200/70 p-3 rounded-lg h-14">
            <div class="flex-1 space-y-2">
              <div class="h-4 bg-gray-300/80 rounded w-2/3"></div>
              <div class="h-3 bg-gray-300/80 rounded w-1/3"></div>
            </div>
            <div class="h-8 w-16 bg-gray-300/80 rounded-full ml-4"></div>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Dialogs (Tailwind Styled) -->
  <dialog id="customAlertDialog" class="p-0 rounded-lg shadow-xl backdrop:bg-black/50">
    <div class="bg-thm-bg rounded-lg p-6 w-full max-w-sm mx-auto text-center">
      <h3 id="customAlertTitle" class="font-bold text-lg mb-3 text-thm-primary-dark"></h3>
      <p id="customAlertMessage" class="py-4 whitespace-pre-line text-gray-700"></p>
      <div class="mt-6 flex justify-center">
        <button id="customAlertButton" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded hover:bg-thm-primary-dark transition-colors">ตกลง</button>
      </div>
    </div>
  </dialog>

  <dialog id="customConfirmDialog" class="p-0 rounded-lg shadow-xl backdrop:bg-black/50">
    <div class="bg-thm-bg rounded-lg p-6 w-full max-w-sm mx-auto text-center">
      <h3 id="customConfirmTitle" class="font-bold text-lg mb-3 text-thm-primary-dark"></h3>
      <p id="customConfirmMessage" class="py-4 text-gray-700"></p>
      <div class="mt-6 flex justify-around space-x-4">
        <button id="customConfirmCancelButton" class="flex-1 border border-thm-primary text-thm-primary font-bold py-2 px-4 rounded hover:bg-thm-accent transition-colors">ยกเลิก</button>
        <button id="customConfirmConfirmButton" class="flex-1 bg-thm-primary text-white font-bold py-2 px-4 rounded hover:bg-thm-primary-dark transition-colors">ยืนยัน</button>
      </div>
    </div>
  </dialog>

  <!-- QR Code Dialog (for Warehouse) -->
  <dialog id="qrDialog" class="p-0 rounded-lg shadow-xl backdrop:bg-black/50">
    <div class="bg-thm-bg rounded-lg p-6 w-full max-w-sm mx-auto text-center">
      <h3 id="qrDialogTitle" class="font-bold text-lg mb-2 text-thm-primary-dark">สแกนเพื่อรับของ</h3>
      <p id="qrDialogItemName" class="mb-4 text-sm text-gray-600"></p>
      <div id="qrcode" class="flex justify-center mb-4 p-4 bg-white rounded-lg"></div>
      <p class="text-xs text-gray-500 mb-4">ให้พนักงานสแกน QR Code นี้เพื่อตรวจสอบและยืนยันการรับสินค้า</p>
      <div class="mt-6 flex flex-wrap justify-around gap-2">
        <button id="qrDialogCloseBtn" class="flex-1 border border-thm-primary text-thm-primary font-bold py-2 px-4 rounded hover:bg-thm-accent transition-colors">ปิด</button>
        <button id="sendMessageToOABtn" class="flex-1 bg-thm-secondary text-white font-bold py-2 px-4 rounded hover:bg-thm-secondary-dark transition-colors">แจ้งพนักงาน</button>
        <button id="qrDialogConfirmBtn" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded hover:bg-thm-primary-dark transition-colors hidden mt-2">ยืนยันการรับของ</button>
      </div>
    </div>
  </dialog>


  <!-- Template: Dashboard (Main Menu) -->
  <template id="view-dashboard">
    <div class="glass-effect rounded-2xl p-4 grid grid-cols-3 gap-3 text-center text-sm font-medium mb-6">
      <a href="#event" class="bg-white/80 text-thm-primary-dark p-3 rounded-2xl flex flex-col items-center justify-center space-y-1 hover:bg-white transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
        </svg>
        <span>กิจกรรม</span>
      </a>
      <a href="#warehouse" class="bg-white/80 text-thm-primary-dark p-3 rounded-2xl flex flex-col items-center justify-center space-y-1 hover:bg-white transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
        </svg>
        <span>คลัง</span>
      </a>
      <a href="#addpoint" class="bg-white/80 text-thm-primary-dark p-3 rounded-2xl flex flex-col items-center justify-center space-y-1 hover:bg-white transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="none">
          <path
            d="M2.5 8.18677C2.60406 6.08705 2.91537 4.77792 3.84664 3.84664C4.77792 2.91537 6.08705 2.60406 8.18677 2.5M21.5 8.18677C21.3959 6.08705 21.0846 4.77792 20.1534 3.84664C19.2221 2.91537 17.9129 2.60406 15.8132 2.5M15.8132 21.5C17.9129 21.3959 19.2221 21.0846 20.1534 20.1534C21.0846 19.2221 21.3959 17.9129 21.5 15.8132M8.18676 21.5C6.08705 21.3959 4.77792 21.0846 3.84664 20.1534C2.91537 19.2221 2.60406 17.9129 2.5 15.8132"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
          <path d="M2.49986 12H21.4999" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
          <path
            d="M6 12C6 8.68629 8.68629 6 12 6C12 7.65685 13.3431 9 15 9C15.6755 9 16.2989 8.77672 16.8004 8.39993C17.5536 9.40273 18 10.6492 18 12M17.1973 15C16.1599 16.7934 14.2208 18 12 18C9.77915 18 7.84012 16.7934 6.80269 15"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
        <span>สแกนรับ</span>
      </a>
      <a href="#transfer" class="bg-white/80 text-thm-primary-dark p-3 rounded-2xl flex flex-col items-center justify-center space-y-1 hover:bg-white transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
        </svg>
        <span>โอนพ้อย</span>
      </a>
      <a href="#redeem" class="bg-white/80 text-thm-primary-dark p-3 rounded-2xl flex flex-col items-center justify-center space-y-1 hover:bg-white transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
        </svg>
        <span>แลกพ้อย</span>
      </a>
      <a href="#profile" class="bg-white/80 text-thm-primary-dark p-3 rounded-2xl flex flex-col items-center justify-center space-y-1 hover:bg-white transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span>บัญชี</span>
      </a>
    </div>

    <div id="checkinBox" class="flex items-center justify-between mb-8 hidden">
      <div class="glass-effect rounded-full px-4 py-2 flex items-center space-x-2 text-thm-primary-dark">
        <span class="text-sm">วันที่</span><span id="todayDate" class="font-bold text-sm">00</span>
      </div>
      <div class="bg-yellow-400 rounded-full w-10 h-10 flex items-center justify-center text-white font-bold text-sm">+1
      </div>
      <button id="checkinBtn" class="bg-thm-primary text-white font-bold py-2 px-6 text-sm rounded-full hover:bg-thm-primary-dark transition-colors">เช็คอิน</button>
    </div>
    <div>
      <div class="flex justify-between items-center mb-4">
        <div class="font-bold text-lg  text-thm-primary-dark">รายการล่าสุด</div>
        <div class="text-xs text-gray-500 text-center font-medium">POINT</div>
      </div>
      <ul id="historyList" class="space-y-4"></ul>
    </div>
  </template>

  <!-- Template: Event List -->
  <template id="view-event">
    <div id="eventList" class="space-y-3"></div>
  </template>

  <!-- Template: Event Detail -->
  <template id="view-event-detail">
    <div id="cardWrapper">
      <!-- [MODIFIED] Using Tailwind's animate-pulse -->
      <div id="cardSkeleton" class="bg-white p-6 rounded-lg shadow-md mb-6 animate-pulse">
        <div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div>
        <div class="h-4 bg-gray-200 rounded w-1/4 mb-2"></div>
        <div class="h-3 bg-gray-200 rounded w-full mb-6"></div>
        <div class="h-12 bg-gray-200 rounded-lg w-full"></div>
      </div>
      <div id="card" class="bg-thm-bg/80 p-6 rounded-lg shadow-md text-gray-800 mb-6 hidden">
        <div class="flex justify-between items-start mb-3">
          <div class="font-bold text-lg text-thm-primary-dark" id="eventDetailTitle">–</div>
          <div class="bg-yellow-400 text-black font-bold text-md px-3 py-1 rounded-full" id="eventPoint">0+</div>
        </div>
        <div class="text-sm text-gray-700 mb-6 leading-relaxed" id="eventDetailDesc">...</div>
        <button id="joinBtn" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors disabled:bg-gray-400">เข้าร่วม</button>
      </div>
    </div>
  </template>

  <!-- Template: Profile -->
  <template id="view-profile">
    <!-- [NEW] Skeleton for Profile Page -->
    <div id="profileSkeleton" class="space-y-4 animate-pulse">
        <div class="glass-effect p-6 rounded-lg text-center shadow-md">
            <div class="w-24 h-24 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <div class="h-7 bg-gray-300 rounded w-1/2 mx-auto mb-3"></div>
            <div class="flex items-center justify-center space-x-2 mb-4">
                <div class="h-5 w-20 bg-gray-300 rounded-full"></div>
                <div class="h-5 w-24 bg-gray-300 rounded-full"></div>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-2.5 my-2"></div>
            <div class="h-3 bg-gray-300 rounded w-1/3 mx-auto mt-2"></div>
            <div class="h-6 bg-gray-300 rounded w-2/5 mx-auto mt-4"></div>
            <div class="h-4 bg-gray-300 rounded w-1/4 mx-auto mt-2"></div>
        </div>
    </div>

    <!-- Original Profile Content (hidden by default) -->
    <div id="profileContent" class="space-y-4 hidden">
      <div class="glass-effect p-6 rounded-lg text-center shadow-md text-white">
        <div class="relative w-24 h-24 mx-auto mb-4">
          <img id="profileDisplayPicture"
            class="w-24 h-24 rounded-full object-cover border-4 border-thm-primary-dark shadow-lg"
            src="https://img.daisyui.com/images/stock/photo-1567653418876-5bb0e566e1c2.webp" alt="รูปโปรไฟล์" />
          <button id="editProfileBtn"
            class="absolute bottom-0 right-0 bg-white rounded-full p-1.5 shadow-md hover:scale-110 transition-transform"><svg
              xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
              <path
                d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.389-2.828-2.828z" />
            </svg></button>
        </div>
        <div class="text-2xl text-thm-primary-dark font-bold mb-2" id="profileDisplayName">กำลังโหลด...</div>
        <div class="flex items-center justify-center space-x-2 mb-2"><span id="profileLevelBadge"></span><span id="profileCustomTagBadge"></span></div>
        <!-- Progress Bar -->
        <div class="w-full bg-thm-accent rounded-full h-2.5 my-2">
            <div id="profileProgressBar" class="bg-thm-primary h-2.5 rounded-full" style="width: 0%;"></div>
        </div>
        <div id="profilePointsToNextLevel" class="text-thm-primary-dark text-sm  mt-1"></div>
        <div class="text-thm-primary-dark text-xl font-bold mt-2">พ้อยคงเหลือ: <span id="profileCurrentPoints">0</span></div>
        <div class=" text-sm mt-1 text-gray-400">แต้มสะสมทั้งหมด: <span id="profileTotalPoints">0</span></div>
      </div>
      <div id="profileFormContainer" class="bg-white p-6 rounded-lg shadow-md space-y-4 hidden">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">LINE ID</label><input id="profileLineId" readonly class="w-full bg-gray-100 border border-thm-accent rounded-md px-3 py-2 text-gray-500 cursor-not-allowed" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label><input id="profileName" readonly class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent cursor-not-allowed" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label><input id="profilePhone" readonly class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent cursor-not-allowed" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label><input id="profileEmail" readonly class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent cursor-not-allowed" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่</label><input id="profileAddress" readonly class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent cursor-not-allowed" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label><input id="profileNote" readonly class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent cursor-not-allowed" /></div>
        <div id="profileEditButtons" class="flex space-x-2 hidden"><button id="saveProfileBtn" class="flex-1 bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark">บันทึกข้อมูล</button><button id="cancelEditBtn" class="flex-1 border border-thm-primary text-thm-primary font-bold py-2 px-4 rounded-lg hover:bg-thm-accent">ยกเลิก</button></div>
      </div>
    </div>
  </template>

  <!-- Template: Redeem -->
  <template id="view-redeem">
    <div class="p-0">
      <ul id="redeemList" class="grid grid-cols-2 gap-4"></ul>
    </div>
  </template>

  <!-- Template: Transfer -->
  <template id="view-transfer">
    <div class="bg-white/80 p-6 rounded-lg shadow-md space-y-4 mb-6">
      <input id="transferTo" placeholder="LINE ID เพื่อน / เบอร์โทรปลายทาง" type="text" class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent">
      <input id="transferAmount" placeholder="จำนวนพ้อยที่ต้องการโอน" type="number" class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent">
      <button id="transferBtn" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors">โอนพ้อย</button>
    </div>
  </template>

  <!-- Template: Warehouse -->
  <template id="view-warehouse">
    <ul id="warehouseList" class="space-y-3"></ul>
  </template>

  <!-- Template: Add Points (Scan/Manual Code) -->
  <template id="view-addpoint">
    <div id="scanContainer" class="bg-white/80 p-6 rounded-lg shadow-md space-y-4 mb-6">
      <button id="scanBtn" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors">สแกน QR Code</button>
      <div class="flex space-x-2">
        <input id="manualCode" type="text" placeholder="กรอกโค้ดที่นี่" class="flex-1 w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent">
        <button id="enterBtn" class="bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark transition-colors">รับโค้ด</button>
      </div>
    </div>
  </template>

  <!-- Shipping Form Dialog (for Physical Items) -->
  <dialog id="shippingFormDialog" class="p-0 rounded-lg shadow-xl backdrop:bg-black/50">
    <div class="bg-thm-bg rounded-lg p-6 w-full max-w-md mx-auto">
      <h3 id="shippingFormTitle" class="font-bold text-lg mb-4 text-thm-primary-dark">ข้อมูลสำหรับจัดส่ง</h3>
      <div class="space-y-4">
        <div>
          <label for="shippingName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล ผู้รับ</label>
          <input id="shippingName" type="text" placeholder="กรอกชื่อ-นามสกุล" class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent" />
        </div>
        <div>
          <label for="shippingPhone" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์ติดต่อ</label>
          <input id="shippingPhone" type="tel" placeholder="กรอกเบอร์โทรศัพท์" class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent" />
        </div>
        <div>
          <label for="shippingAddress" class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่สำหรับจัดส่ง</label>
          <textarea id="shippingAddress" class="w-full bg-white border border-thm-accent rounded-md px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-thm-primary focus:border-transparent" rows="4" placeholder="บ้านเลขที่, ถนน, ตำบล, อำเภอ, จังหวัด, รหัสไปรษณีย์"></textarea>
        </div>
      </div>
      <div class="mt-6 flex justify-between space-x-4">
        <button id="shippingFormCancelBtn" class="flex-1 border border-thm-primary text-thm-primary font-bold py-2 px-4 rounded-lg hover:bg-thm-accent">ยกเลิก</button>
        <button id="shippingFormConfirmBtn" class="flex-1 bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark">ยืนยันและแลกของ</button>
      </div>
    </div>
  </dialog>


  <script>
    // --- GLOBAL STATE & CACHE ---
    let liffInitialized = false;
    const userState = { profile: null, lineId: "", points: 0, totalPoints: 0, pointsChanged: false, level: "Member", customTag: "" };
    const dataCache = { events: null, redeemItems: null, eventDetails: {}, userProfileFull: null, history: null, levelSettings: null };
    let warehousePollingInterval = null;

    // --- DIALOGS & UI ELEMENTS ---
    const alertDialog = document.getElementById('customAlertDialog'), alertT = document.getElementById('customAlertTitle'), alertM = document.getElementById('customAlertMessage'), alertBtn = document.getElementById('customAlertButton');
    const confirmDialog = document.getElementById('customConfirmDialog'), confT = document.getElementById('customConfirmTitle'), confM = document.getElementById('customConfirmMessage'), okBtn = document.getElementById('customConfirmConfirmButton'), noBtn = document.getElementById('customConfirmCancelButton');
    const pageTitleEl = document.getElementById('pageTitle'), pointValEl = document.getElementById('pointVal'), dpEl = document.getElementById('lineDisplayPicture');
    const qrDialog = document.getElementById('qrDialog'),
    qrDialogTitle = document.getElementById('qrDialogTitle'),
    qrDialogItemName = document.getElementById('qrDialogItemName'),
    qrcodeContainer = document.getElementById('qrcode'),
    qrConfirmBtn = document.getElementById('qrDialogConfirmBtn'),
    qrCloseBtn = document.getElementById('qrDialogCloseBtn');

    // --- STYLES (TAILWIND REPLACEMENT) ---
    const LEVEL_STYLES = {
        'Member': { text: 'Member', class: 'bg-transparent border border-[#949494] text-[#949494]' },
        'VIP': { text: 'VIP', class: 'bg-transparent border border-[#FFB700] text-[#FFB700]' },
        'Super': { text: 'Super', class: 'bg-transparent border border-[#FE2B91] text-[#FE2B91]' }
    };
    const CUSTOM_TAG_STYLES = {
        'newuser': { class: 'bg-yellow-200 text-yellow-800', text: 'สมาชิกใหม่' },
        'ceo': { class: 'bg-thm-accent text-thm-primary-dark font-semibold', text: 'CEO' },
        'admin': { class: 'bg-red-200 text-red-800', text: 'ผู้ดูแล' },
        'tester': { class: 'bg-thm-secondary text-white', text: 'ผู้ทดสอบ' },
        'default': { class: 'bg-gray-200 text-gray-700', text: '' }
    };

    // --- COMMON UI FUNCTIONS ---
    function showAlert(title, message, cb) {
      alertT.textContent = title; alertM.textContent = message; alertDialog.showModal();
      const hide = () => { alertDialog.close(); alertBtn.removeEventListener('click', hide); cb && cb(); };
      alertBtn.addEventListener('click', hide, { once: true });
    }
    function showConfirm(title, message) {
      return new Promise(res => {
        confT.textContent = title; confM.textContent = message; confirmDialog.showModal();
        const onOk = () => { cleanup(); res(true); }; const onNo = () => { cleanup(); res(false); };
        function cleanup() { confirmDialog.close(); okBtn.removeEventListener('click', onOk); noBtn.removeEventListener('click', onNo); }
        okBtn.addEventListener('click', onOk, { once: true }); noBtn.addEventListener('click', onNo, { once: true });
      });
    }

    // --- DATA & STATE MANAGEMENT ---
    function calculateLevelAndProgress(totalAccumulatedPoints) {
      const vipPoints = dataCache.levelSettings?.VIP_points || 5000;
      const superPoints = dataCache.levelSettings?.SUPER_points || 10000;
      let level = 'Member', currentLevelMin = 0, nextLevelMin = vipPoints, nextLevelName = 'VIP';

      if (totalAccumulatedPoints >= superPoints) {
        level = 'Super';
        currentLevelMin = superPoints;
        nextLevelMin = totalAccumulatedPoints;
        nextLevelName = '';
      } else if (totalAccumulatedPoints >= vipPoints) {
        level = 'VIP';
        currentLevelMin = vipPoints;
        nextLevelMin = superPoints;
        nextLevelName = 'Super';
      }

      const pointsInCurrentTier = totalAccumulatedPoints - currentLevelMin;
      const pointsToNextTier = nextLevelMin - currentLevelMin;
      let progressValue = 0;
      let pointsNeeded = 0;

      if (nextLevelName) {
        progressValue = (pointsToNextTier > 0) ? (pointsInCurrentTier / pointsToNextTier) * 100 : 100;
        pointsNeeded = nextLevelMin - totalAccumulatedPoints;
      } else {
        progressValue = 100;
        pointsNeeded = 0;
      }

      return { level, progressValue: Math.min(100, Math.max(0, progressValue)), pointsToNext: pointsNeeded, nextLevelName };
    }

    function setBadgeContent(badgeElement, text, className) {
        if (!badgeElement) return;
        badgeElement.textContent = text;
        badgeElement.className = `inline-block px-3 py-1 text-xs font-semibold rounded-full ${className}`;
        if (text) badgeElement.classList.remove('hidden'); else badgeElement.classList.add('hidden');
    }

    async function fetchAndUpdateUserState() {
      try {
        const userRes = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`);
        const userData = await userRes.json();
        if (userData && !userData.error) {
          userState.points = parseInt(userData.point || 0, 10);
          userState.totalPoints = parseInt(userData.totalPoints || 0, 10);
          userState.level = userData.level || 'Member';
          userState.customTag = userData.customTag || '';
          dataCache.userProfileFull = userData;
          pointValEl.textContent = userState.points;
          userState.pointsChanged = true;
          console.log(`User state updated: Points=${userState.points}, TotalPoints=${userState.totalPoints}, Level=${userState.level}`);
        } else { console.error("Failed to fetch user data after action:", userData?.error || "Unknown error"); }
      } catch (e) { console.error("Error fetching user info after action:", e); }
    }

    // --- LIFF & APP INITIALIZATION ---
    async function ensureLIFFAndFetchInitialData() {
      if (!liffInitialized) {
        try { await liff.init({ liffId: CONFIG.LIFF_ID }); liffInitialized = true; }
        catch (e) { console.error("LIFF initialization failed", e); showAlert("ข้อผิดพลาด", "ไม่สามารถเริ่มต้น LIFF ได้ กรุณาลองใหม่ภายหลัง"); return false; }
      }
      if (!liff.isLoggedIn()) { liff.login(); return false; }
      if (!userState.profile) {
        userState.profile = await liff.getProfile(); userState.lineId = userState.profile.userId;
        dpEl.src = userState.profile.pictureUrl || 'https://via.placeholder.com/40';
        dpEl.alt = `รูปโปรไฟล์ของ ${userState.profile.displayName}`;
      }
      pointValEl.textContent = '...';
      try {
        const [userRes, histRes, eventsRes, redeemRes, settingsRes] = await Promise.all([
          fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`),
          fetch(`${CONFIG.GAS_URL}?action=getHistory&lineId=${userState.lineId}`),
          fetch(`${CONFIG.GAS_URL}?action=getEvents`),
          fetch(`${CONFIG.GAS_URL}?action=getItems`),
          fetch(`${CONFIG.GAS_URL}?action=getLevelConfig`)
        ]);
        const userData = await userRes.json();
        if (!userData || !userData.isRegistered) { window.location.href = 'Register.html'; return false; }

        dataCache.history = await histRes.json();
        dataCache.events = await eventsRes.json();
        dataCache.redeemItems = await redeemRes.json();
        const settingsData = await settingsRes.json();
        if (settingsData && !settingsData.error) { dataCache.levelSettings = { VIP_points: parseInt(settingsData.VIP_points || 0), SUPER_points: parseInt(settingsData.SUPER_points || 0) }; }
        else { dataCache.levelSettings = { VIP_points: 5000, SUPER_points: 10000 }; }

        userState.points = parseInt(userData.point || 0, 10);
        userState.totalPoints = parseInt(userData.totalPoints || 0, 10);
        userState.level = userData.level || 'Member';
        userState.customTag = userData.customTag || '';
        dataCache.userProfileFull = userData;
        pointValEl.textContent = userState.points;
        userState.pointsChanged = false;

      } catch (error) { console.error("Failed to fetch initial data:", error); pointValEl.textContent = 'N/A'; showAlert("ข้อผิดพลาด", "ไม่สามารถโหลดข้อมูลผู้ใช้ได้ กรุณาลองใหม่"); return false; }
      return true;
    }

    const routes = {
      '#dashboard': { title: 'หน้าหลัก', tpl: 'view-dashboard', init: initDashboard },
      '#event': { title: 'กิจกรรม', tpl: 'view-event', init: initEvent },
      '#event-detail': { title: 'รายละเอียดกิจกรรม', tpl: 'view-event-detail', init: initEventDetail },
      '#profile': { title: 'โปรไฟล์ของคุณ', tpl: 'view-profile', init: initProfile },
      '#redeem': { title: 'ร้านค้าแลกของรางวัล', tpl: 'view-redeem', init: initRedeem },
      '#transfer': { title: 'โอนพ้อยให้เพื่อน', tpl: 'view-transfer', init: initTransfer },
      '#warehouse': { title: 'คลังของรางวัล', tpl: 'view-warehouse', init: initWarehouse },
      '#addpoint': { title: 'โค้ดเพื่อรับรางวัล', tpl: 'view-addpoint', init: initAddpoint },
      '': { title: 'หน้าหลัก', tpl: 'view-dashboard', init: initDashboard }
    };
    async function router() {
      if (warehousePollingInterval) {
        clearInterval(warehousePollingInterval);
        warehousePollingInterval = null;
        if (qrDialog && qrDialog.open) {
          qrDialog.close();
        }
        console.log("Polling stopped due to route change.");
      }

      const hash = window.location.hash.split('?')[0] || '';
      const route = routes[hash] || routes[''];
      pageTitleEl.textContent = route.title;
      const appDiv = document.getElementById('app'); appDiv.innerHTML = '';
      const template = document.getElementById(route.tpl);
      if (template) { appDiv.appendChild(template.content.cloneNode(true)); }
      else { appDiv.innerHTML = `<p class="text-center text-red-500 py-8">เกิดข้อผิดพลาด: ไม่พบเทมเพลตสำหรับ ${hash}</p>`; return; }
      try { await route.init(); }
      catch (error) { console.error(`Error initializing view ${route.tpl}:`, error); showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลหน้านี้ได้'); }
    }

    // [MODIFIED] Skeleton functions now use animate-pulse for consistency
    function generateListSkeleton(count) { return Array.from({ length: count }).map(_ => `<li class="flex justify-between items-center animate-pulse py-3 bg-white/70 p-3 rounded-lg"><div class="space-y-2 flex-1"><div class="h-4 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-1/3 mt-1"></div></div><div class="h-8 w-16 bg-gray-200 rounded-full"></div></li>`).join(""); }
    function generateCardSkeleton(count) { return Array.from({ length: count }).map(_ => `<li class="bg-white p-4 rounded-lg shadow-sm animate-pulse"><div class="h-24 bg-gray-200 rounded-md mb-3"></div><div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div><div class="h-8 bg-gray-200 rounded-lg w-full"></div></li>`).join(''); }
    
    function renderHistoryList(historyData) {
      const el = document.getElementById('historyList'); if (!el) return;
      const latest = historyData.slice().reverse().slice(0, 10);
      if (latest.length === 0) { el.innerHTML = `<li class="text-center text-gray-500 py-4">ไม่มีประวัติการทำรายการ</li>`; return; }
      el.innerHTML = latest.map(item => {
        const isDebit = ['redeem', 'transfer_out'].includes(item.type);
        return `<li class="flex justify-between items-center bg-white/70 p-3 rounded-lg"><div><div class="font-medium text-thm-primary-dark text-sm">${item.detail}</div><div class="text-xs text-gray-500 mt-1">${item.date}</div></div><div class="text-sm font-bold px-4 py-1.5 rounded-full ${isDebit ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${isDebit ? '-' : '+'} ${item.amount}</div></li>`;
      }).join("");
    }
    async function getFreshOrCachedHistory() {
      if (userState.pointsChanged || !dataCache.history) {
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?action=getHistory&lineId=${userState.lineId}`);
          dataCache.history = await res.json(); userState.pointsChanged = false;
        } catch (e) { console.error("Error fetching history:", e); dataCache.history = []; userState.pointsChanged = false; }
      } return dataCache.history;
    }

    // --- VIEW INITIALIZATION FUNCTIONS ---
    async function initDashboard() {
      const historyListEl = document.getElementById('historyList'), checkinBox = document.getElementById('checkinBox'), todayDateEl = document.getElementById('todayDate'), checkinBtn = document.getElementById('checkinBtn');
      if (dataCache.history && !userState.pointsChanged) renderHistoryList(dataCache.history);
      else if (historyListEl) historyListEl.innerHTML = generateListSkeleton(5);
      try {
        const [checkData, history] = await Promise.all([fetch(`${CONFIG.GAS_URL}?action=checkinStatus&lineId=${userState.lineId}`).then(r => r.json()), getFreshOrCachedHistory()]);
        renderHistoryList(history);
        if (checkinBox && !checkData.checkedInToday) {
          checkinBox.classList.remove('hidden'); todayDateEl.textContent = new Date().getDate().toString().padStart(2, "0");
          checkinBtn.onclick = async () => {
            checkinBtn.disabled = true;
            try {
              const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify({ action: "dailyCheckin", lineId: userState.lineId }) });
              const text = await res.text();
              showAlert('เช็คอินสำเร็จ', text, async () => { if (text.includes("สำเร็จ")) { await fetchAndUpdateUserState(); checkinBox.classList.add('hidden'); initDashboard(); } });
            } catch (e) { console.error("Check-in failed:", e); showAlert('ข้อผิดพลาด', 'ไม่สามารถเช็คอินได้'); } finally { checkinBtn.disabled = false; }
          };
        } else if (checkinBox) { checkinBox.classList.add('hidden'); }
      } catch (e) { console.error("Error in initDashboard:", e); if (historyListEl) historyListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาด</li>`; }
    }

    async function initEvent() {
      const eventListEl = document.getElementById('eventList');
      if (eventListEl) eventListEl.innerHTML = generateListSkeleton(5);
      let events = dataCache.events || [];
      if (!dataCache.events) {
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?action=getEvents`);
          events = await res.json();
          if (events.error) throw new Error(events.error);
          dataCache.events = events;
        } catch (e) {
          console.error("Error fetching events:", e);
          if (eventListEl) eventListEl.innerHTML = `<div class="text-center text-red-500 py-8">เกิดข้อผิดพลาดในการโหลดกิจกรรม</div>`;
          return;
        }
      }

      if (!events || events.length === 0) {
        eventListEl.innerHTML = `<div class="text-center text-gray-400 py-8">ไม่มีกิจกรรมในขณะนี้</div>`;
        return;
      }
      eventListEl.innerHTML = events.map(e => {
        let isUserAllowed = false;
        let levelTagHTML = '';
        const hasLevelRestriction = typeof e.allowedLevels === 'string' && e.allowedLevels.trim() !== '';

        if (hasLevelRestriction) {
          const allowed = e.allowedLevels.split(',').map(level => level.trim().toUpperCase());
          if (allowed.includes(userState.level.toUpperCase())) {
            isUserAllowed = true;
          }
          levelTagHTML = `<div class="inline-block text-xs px-2 py-0.5 rounded-full mt-2 bg-transparent border border-thm-accent text-thm-primary-dark">สำหรับ: ${e.allowedLevels}</div>`;
        } else {
          isUserAllowed = true;
        }

        const buttonHTML = isUserAllowed
          ? `<a href="#event-detail?id=${e.id}" class="bg-thm-primary text-white font-bold py-1 px-3 text-sm rounded-lg hover:bg-thm-primary-dark transition-colors">ดูรายละเอียด</a>`
          : `<button class="bg-gray-300 text-gray-500 cursor-not-allowed font-bold py-1 px-3 text-sm rounded-lg">ระดับไม่ถึง</button>`;

        return `
                <div class="bg-thm-accent p-4 rounded-lg flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-semibold text-thm-primary-dark text-sm">${e.title}</div>
                        <div class="text-xs text-gray-500">${e.detail || 'ดูรายละเอียดกิจกรรม'}</div>
                        ${levelTagHTML}
                    </div>
                    <div class="text-right">
                        ${buttonHTML}
                    </div>
                </div>
            `;
      }).join('');
    }

    async function initEventDetail() {
      const params = new URLSearchParams(window.location.hash.split('?')[1]);
      const eventId = params.get("id");
      const cardSkeleton = document.getElementById('cardSkeleton'), card = document.getElementById('card'), titleEl = document.getElementById('eventDetailTitle'), descEl = document.getElementById('eventDetailDesc'), pointEl = document.getElementById('eventPoint'), joinBtn = document.getElementById('joinBtn');
      cardSkeleton.classList.remove('hidden'); card.classList.add('hidden');

      let eventData = dataCache.eventDetails[eventId];
      if (!eventData) {
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?action=getEventById&id=${eventId}`);
          eventData = await res.json();
          if (!eventData.error) dataCache.eventDetails[eventId] = eventData;
        }
        catch (e) {
          console.error("Error fetching event detail:", e);
          eventData = { error: "ไม่สามารถโหลดรายละเอียดได้" };
        }
      }

      const history = await getFreshOrCachedHistory();
      if (eventData.error) {
        titleEl.textContent = "ไม่พบกิจกรรม"; descEl.textContent = eventData.error; joinBtn.disabled = true;
      } else {
        titleEl.textContent = eventData.title; pointEl.textContent = `${eventData.point}+`; descEl.textContent = eventData.desc;
        const hasJoined = history.some(item => item.type === 'event' && item.eventId === eventId);
        let isLevelAllowed = false;
        const hasLevelRestriction = typeof eventData.allowedLevels === 'string' && eventData.allowedLevels.trim() !== '';

        if (hasLevelRestriction) {
          const allowed = eventData.allowedLevels.split(',').map(level => level.trim().toUpperCase());
          if (allowed.includes(userState.level.toUpperCase())) {
            isLevelAllowed = true;
          }
        } else {
          isLevelAllowed = true;
        }

        if (hasJoined) {
          joinBtn.textContent = "รับพ้อยต์แล้ว";
          joinBtn.disabled = true;
        } else if (!isLevelAllowed) {
          joinBtn.textContent = `สำหรับระดับ ${eventData.allowedLevels}`;
          joinBtn.disabled = true;
        } else {
          joinBtn.onclick = async () => {
            if (!(await showConfirm('ยืนยัน', `เข้าร่วม "${eventData.title}" และรับ ${eventData.point} พ้อยต์?`))) return;
            joinBtn.disabled = true;
            joinBtn.textContent = "กำลังดำเนินการ...";
            try {
              const res = await fetch(CONFIG.GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "joinEvent", lineId: userState.lineId, eventId, title: eventData.title, point: eventData.point })
              });
              const text = await res.text();
              showAlert("สถานะ", text, async () => {
                if (text.includes("สำเร็จ")) {
                  await fetchAndUpdateUserState();
                  joinBtn.textContent = "รับพ้อยต์แล้ว";
                  joinBtn.disabled = true;
                } else {
                  joinBtn.textContent = "รับพ้อยต์แล้ว";
                  joinBtn.disabled = true;
                }
              });
            } catch (e) {
              console.error("Join event failed:", e);
              showAlert('ข้อผิดพลาด', 'ไม่สามารถเข้าร่วมได้');
              joinBtn.textContent = "เข้าร่วม";
              joinBtn.disabled = false;
            }
          };
        }
      }
      cardSkeleton.classList.add("hidden"); card.classList.remove("hidden");
    }

    async function initProfile() {
      // [MODIFIED] Added skeleton elements
      const skeletonEl = document.getElementById('profileSkeleton');
      const contentEl = document.getElementById('profileContent');

      // Show skeleton, hide content initially
      skeletonEl.classList.remove('hidden');
      contentEl.classList.add('hidden');

      const dpEl = document.getElementById('profileDisplayPicture'), dnEl = document.getElementById('profileDisplayName'), lineIdEl = document.getElementById('profileLineId'), levelBadgeEl = document.getElementById('profileLevelBadge'), tagBadgeEl = document.getElementById('profileCustomTagBadge'), progressEl = document.getElementById('profileProgressBar'), progressTextEl = document.getElementById('profilePointsToNextLevel'), totalPointsEl = document.getElementById('profileTotalPoints'), nameEl = document.getElementById('profileName'), phoneEl = document.getElementById('profilePhone'), emailEl = document.getElementById('profileEmail'), addressEl = document.getElementById('profileAddress'), noteEl = document.getElementById('profileNote'), editBtn = document.getElementById('editProfileBtn'), formContainer = document.getElementById('profileFormContainer'), editButtonsDiv = document.getElementById('profileEditButtons'), saveBtn = document.getElementById('saveProfileBtn'), cancelBtn = document.getElementById('cancelEditBtn');
      const editableInputs = [nameEl, phoneEl, emailEl, addressEl, noteEl]; let initialData = {};

      let uData = dataCache.userProfileFull;
      if (!uData || userState.pointsChanged) { 
        try { 
            const res = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`);
            uData = await res.json(); 
            if (!uData.error) dataCache.userProfileFull = uData; 
        } catch (e) { uData = { error: 'โหลดข้อมูลล้มเหลว' }; } 
      }
      
      if (uData.error) { 
        showAlert('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลโปรไฟล์ได้'); 
        // Hide skeleton and show an error message or leave skeleton
        skeletonEl.innerHTML = '<div class="text-center text-red-500 py-8">เกิดข้อผิดพลาดในการโหลดโปรไฟล์</div>';
        return; 
      }
      
      // Populate data
      dpEl.src = userState.profile.pictureUrl || 'https://via.placeholder.com/96';
      dnEl.textContent = userState.profile.displayName || 'ผู้ใช้ LINE';
      totalPointsEl.textContent = userState.totalPoints.toLocaleString();
      const currentPointsEl = document.getElementById('profileCurrentPoints');
      if (currentPointsEl) currentPointsEl.textContent = userState.points.toLocaleString();

      const { progressValue, pointsToNext, nextLevelName } = calculateLevelAndProgress(userState.totalPoints);
      setBadgeContent(levelBadgeEl, LEVEL_STYLES[userState.level]?.text || userState.level, LEVEL_STYLES[userState.level]?.class || '');
      const primaryTag = (userState.customTag.split(',')[0] || '').trim().toLowerCase();
      const tagInfo = CUSTOM_TAG_STYLES[primaryTag] || CUSTOM_TAG_STYLES['default'];
      const tagText = tagInfo.text || (primaryTag ? primaryTag.charAt(0).toUpperCase() + primaryTag.slice(1) : '');
      if (!tagText) tagBadgeEl.classList.add('hidden'); else setBadgeContent(tagBadgeEl, tagText, tagInfo.class);

      if (progressEl) { progressEl.style.width = `${progressValue}%`; }
      progressTextEl.textContent = nextLevelName ? `อีก ${pointsToNext.toLocaleString()} พ้อยต์สู่ ${nextLevelName}` : `คุณอยู่ระดับสูงสุดแล้ว!`;

      initialData = { name: uData.name || '', phone: uData.phone || '', email: uData.email || '', address: uData.address || '', note: uData.note || '' };
      lineIdEl.value = userState.lineId; nameEl.value = initialData.name; phoneEl.value = initialData.phone; emailEl.value = initialData.email; addressEl.value = initialData.address; noteEl.value = initialData.note;

      const toggleEditMode = (enable) => {
          editableInputs.forEach(input => {
              input.readOnly = !enable;
              input.classList.toggle('bg-white', enable);
              input.classList.toggle('border-thm-primary', enable);
              input.classList.toggle('cursor-not-allowed', !enable);
              input.classList.toggle('bg-gray-100', !enable);
              input.classList.toggle('text-gray-500', !enable);
          });
          formContainer.classList.toggle('hidden', !enable);
          editBtn.classList.toggle('hidden', enable);
          editButtonsDiv.classList.toggle('hidden', !enable);
      };

      editBtn.onclick = () => toggleEditMode(true);
      cancelBtn.onclick = () => { Object.keys(initialData).forEach(k => document.getElementById(`profile${k.charAt(0).toUpperCase() + k.slice(1)}`).value = initialData[k]); toggleEditMode(false); };
      saveBtn.onclick = async () => {
        saveBtn.disabled = true; cancelBtn.disabled = true;
        try {
          const body = { action: 'updateProfile', lineId: userState.lineId, name: nameEl.value, phone: phoneEl.value, email: emailEl.value, address: addressEl.value, note: noteEl.value };
          const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify(body) });
          const text = await res.text();
          showAlert("สถานะ", text, async () => { if (text.includes("สำเร็จ")) { await fetchAndUpdateUserState(); toggleEditMode(false); } });
        } catch (e) { console.error("Update profile failed:", e); showAlert('ข้อผิดพลาด', 'ไม่สามารถอัปเดตได้'); } finally { saveBtn.disabled = false; cancelBtn.disabled = false; }
      };
      toggleEditMode(false);

      // [MODIFIED] Hide skeleton and show content after everything is ready
      skeletonEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
    }

    async function initRedeem() {
      const redeemListEl = document.getElementById('redeemList');
      if (redeemListEl) redeemListEl.innerHTML = generateCardSkeleton(4);
      let items = dataCache.redeemItems || [];
      if (!dataCache.redeemItems || dataCache.redeemItems.length === 0) {
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?action=getItems`);
          items = await res.json();
          if (items.error) throw new Error(items.error);
          dataCache.redeemItems = items;
        } catch (e) {
          console.error("Error fetching items:", e);
          if (redeemListEl) redeemListEl.innerHTML = `<li class="col-span-2 text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดของรางวัล</li>`;
          return;
        }
      }
      if (!items || items.length === 0) {
        redeemListEl.innerHTML = `<li class="col-span-2 text-center text-gray-500 py-4">ไม่มีของรางวัลให้แลก</li>`;
        return;
      }
      redeemListEl.innerHTML = items.map(item => `
            <li class="bg-white/80 p-4 rounded-lg shadow-sm text-center flex flex-col justify-between">
                <div>
                  <img src="${item.image}" alt="${item.name}" class="h-24 w-full object-cover mx-auto mb-2 rounded-lg">
                  <div class="font-bold mb-1 text-thm-primary-dark">${item.name}</div>
                  <div class="text-sm text-gray-600 mb-2">${item.point} พ้อยต์</div>
                </div>
                <button
                    data-item-id="${item.id}" data-item-name="${item.name}" data-item-point="${item.point}" data-item-type="${item.type}"
                    class="redeem-btn bg-thm-primary text-white font-bold py-1.5 px-3 text-sm rounded-lg hover:bg-thm-primary-dark transition-colors mt-2 disabled:bg-gray-400">แลกเลย</button>
            </li>
        `).join('');
      document.querySelectorAll('.redeem-btn').forEach(btn => btn.addEventListener('click', handleRedeemClick));
    }

    async function handleRedeemClick(event) {
      const btn = event.currentTarget;
      const { itemId, itemName, itemPoint, itemType } = btn.dataset;
      const point = parseInt(itemPoint, 10);
      if (userState.points < point) {
        showAlert("ไม่เพียงพอ", `แต้มของคุณ (${userState.points}) ไม่พอสำหรับแลก "${itemName}" ซึ่งใช้ ${point} พ้อยต์`);
        return;
      }
      if (itemType === 'physical') {
        showShippingForm({ itemId, itemName, point });
      } else {
        const confirmed = await showConfirm(`ยืนยันการแลก`, `แลก "${itemName}" ด้วย ${point} พ้อยต์ ใช่หรือไม่?`);
        if (!confirmed) return;
        await executeRedemption(btn, { itemId, point });
      }
    }

    function showShippingForm(item) {
      const dialog = document.getElementById('shippingFormDialog');
      const titleEl = document.getElementById('shippingFormTitle');
      const nameInput = document.getElementById('shippingName');
      const phoneInput = document.getElementById('shippingPhone');
      const addressInput = document.getElementById('shippingAddress');
      const confirmBtn = document.getElementById('shippingFormConfirmBtn');
      const cancelBtn = document.getElementById('shippingFormCancelBtn');
      titleEl.textContent = `ข้อมูลจัดส่งสำหรับ: ${item.itemName}`;
      const profile = dataCache.userProfileFull || {};
      nameInput.value = profile.name || '';
      phoneInput.value = profile.phone || '';
      addressInput.value = profile.address || '';
      dialog.showModal();
      const handleConfirm = async () => {
        const shippingName = nameInput.value.trim();
        const shippingPhone = phoneInput.value.trim();
        const shippingAddress = addressInput.value.trim();
        if (!shippingName || !shippingPhone || !shippingAddress) {
          showAlert("ข้อมูลไม่ครบ", "กรุณากรอกชื่อ, เบอร์โทร, และที่อยู่ให้ครบถ้วน");
          return;
        }
        dialog.close();
        const originalButton = document.querySelector(`.redeem-btn[data-item-id="${item.itemId}"]`);
        await executeRedemption(originalButton, {
          itemId: item.itemId, point: item.point,
          shippingInfo: { name: shippingName, phone: shippingPhone, address: shippingAddress }
        });
      };
      confirmBtn.onclick = handleConfirm;
      cancelBtn.onclick = () => dialog.close();
    }

    async function executeRedemption(buttonElement, payload) {
      buttonElement.disabled = true;
      buttonElement.textContent = "กำลังแลก...";
      try {
        const body = { action: 'redeemItem', lineId: userState.lineId, itemId: payload.itemId, point: payload.point, ...(payload.shippingInfo && { shippingInfo: payload.shippingInfo }) };
        const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify(body) });
        const text = await res.text();
        showAlert("สถานะการแลก", text, async () => {
          if (text.includes("สำเร็จ")) {
            await fetchAndUpdateUserState();
            buttonElement.textContent = "แลกแล้ว";
          } else {
            buttonElement.disabled = false;
            buttonElement.textContent = "แลกเลย";
          }
        });
      } catch (e) {
        console.error("Redemption failed:", e);
        showAlert('ข้อผิดพลาด', 'ไม่สามารถทำรายการแลกของได้ กรุณาลองใหม่');
        buttonElement.disabled = false;
        buttonElement.textContent = "แลกเลย";
      }
    }

    async function initTransfer() {
      const toEl = document.getElementById('transferTo'), amountEl = document.getElementById('transferAmount'), transferBtn = document.getElementById('transferBtn');
      transferBtn.onclick = async () => {
        const to = toEl.value.trim(), amount = parseInt(amountEl.value, 10);
        if (!to) { showAlert("ข้อผิดพลาด", "กรุณากรอก LINE ID / เบอร์โทรปลายทาง"); return; }
        if (isNaN(amount) || amount <= 0) { showAlert("ข้อผิดพลาด", "กรอกจำนวนพ้อยต์ให้ถูกต้อง"); return; }
        if (to === userState.lineId) { showAlert("ข้อผิดพลาด", "ไม่สามารถโอนให้ตัวเอง"); return; }
        if (userState.points < amount) { showAlert("ไม่เพียงพอ", `แต้มของคุณ (${userState.points}) ไม่พอสำหรับโอน`); return; }
        if (!(await showConfirm("ยืนยัน", `โอน ${amount} พ้อยต์ให้ ${to}?`))) return;
        transferBtn.disabled = true;
        try {
          const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'transferPoints', from: userState.lineId, to, amount }) });
          const txt = await res.text();
          showAlert("สถานะ", txt, async () => { if (/สำเร็จ|เรียบร้อย/.test(txt)) { await fetchAndUpdateUserState(); toEl.value = ''; amountEl.value = ''; } });
        } catch (e) { showAlert("ข้อผิดพลาด", "ไม่สามารถโอนได้"); }
        finally { transferBtn.disabled = false; }
      };
    }

    async function initAddpoint() {
      const scanContainer = document.getElementById('scanContainer'), scanBtn = document.getElementById('scanBtn'), enterBtn = document.getElementById('enterBtn'), manualInput = document.getElementById('manualCode');
      async function processCode(code) {
        if (!code) return;
        const history = await getFreshOrCachedHistory();
        if (history.some(item => (item.type === 'code' || item.type === 'event') && item.eventId === code)) {
          showAlert('รับแล้ว', 'คุณเคยรับโค้ดนี้ไปแล้ว');
          return;
        }
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?action=getCodeById&id=${code}`);
          const data = await res.json();
          if (data.error) { showAlert('ไม่พบโค้ด', data.error); return; }
          scanContainer.innerHTML = `<div class="bg-white/80 p-6 rounded-lg shadow-md mb-4 text-center"><div class="font-bold text-lg mb-2 text-thm-primary-dark">${data.title}</div><div class="text-sm text-gray-700 mb-4">${data.desc}</div><div class="font-bold text-yellow-600 mb-4 text-xl">คุณจะได้รับ: ${data.point} พ้อยต์</div><button id="acceptBtn" class="w-full bg-thm-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-thm-primary-dark">ยืนยันการรับพ้อยต์</button></div>`;
          document.getElementById('acceptBtn').addEventListener('click', () => joinCode(data));
        } catch (e) { console.error("Error processing code:", e); showAlert('ข้อผิดพลาด', 'ไม่สามารถประมวลผลโค้ดได้'); }
      }
      async function joinCode(codeData) {
        const { id: scannedCode, title: codeTitle, point: codePoint } = codeData;
        if (!(await showConfirm('ยืนยัน', `รับพ้อยต์จาก "${codeTitle}" จำนวน ${codePoint} พ้อยต์?`))) return;
        const btn = document.getElementById("acceptBtn");
        if (!btn) return;
        btn.disabled = true; btn.textContent = "กำลังดำเนินการ..."; let success = false;
        try {
          const res = await fetch(CONFIG.GAS_URL, { method: "POST", body: JSON.stringify({ action: "joinCode", lineId: userState.lineId, id: scannedCode, title: codeTitle, point: codePoint }) });
          const text = await res.text();
          if (text.includes("สำเร็จ")) {
            success = true; btn.textContent = "รับพ้อยต์แล้ว";
            showAlert("สำเร็จ", text, async () => { await fetchAndUpdateUserState(); window.location.hash = '#dashboard'; });
          } else { showAlert("เกิดข้อผิดพลาด", text); window.location.hash = '#addpoint'; }
        } catch (e) { console.error("Join code failed:", e); showAlert('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อได้'); }
        finally { if (!success && btn) { btn.disabled = false; btn.textContent = "ยืนยันการรับพ้อยต์"; } }
      }
      scanBtn.onclick = async () => {
        try { const result = await liff.scanCodeV2(); if (result && result.value) await processCode(result.value); }
        catch (e) { if (e.code !== 'USER_CANCEL') { console.error("Scan failed:", e); showAlert('สแกนไม่สำเร็จ', e.message || 'กรุณาลองใหม่'); } }
      };
      enterBtn.onclick = () => { const codeValue = manualInput.value.trim(); if (codeValue) processCode(codeValue); else showAlert('ข้อมูลไม่ครบ', 'กรุณากรอกโค้ด'); };
    }

    async function initWarehouse() {
        if (warehousePollingInterval) {
            clearInterval(warehousePollingInterval);
            warehousePollingInterval = null;
            if (qrDialog.open) qrDialog.close();
        }
        const warehouseListEl = document.getElementById('warehouseList');
        if (warehouseListEl) warehouseListEl.innerHTML = generateListSkeleton(3);

        try {
            const res = await fetch(`${CONFIG.GAS_URL}?action=getWarehouseItems&lineId=${userState.lineId}`);
            const ownedItems = await res.json();
            if (!ownedItems || ownedItems.error) throw new Error(ownedItems.error || 'Failed to load data');

            if (ownedItems.length === 0) {
                warehouseListEl.innerHTML = '<li class="text-center text-gray-500 py-4">ยังไม่มีของรางวัลในคลัง</li>';
                return;
            }

            warehouseListEl.innerHTML = ownedItems.map(item => {
                let statusBlockHTML = '';
                let detailsBlockHTML = '';

                switch (item.status) {
                    case 'claimed':
                        statusBlockHTML = `<div class="inline-block px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">รับแล้ว</div>`;
                        detailsBlockHTML = `<div class="text-xs text-gray-500">วันที่รับ: ${item.claimDate || '-'}</div>`;
                        break;
                    case 'shipped':
                        statusBlockHTML = `<div class="inline-block px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full">จัดส่งแล้ว</div>`;
                        if (item.expressTracking && String(item.expressTracking).trim() !== '') {
                            detailsBlockHTML = `<div class="text-xs text-gray-500">วันที่จัดส่ง: ${item.claimDate || '-'}</div><div class="text-xs text-gray-700 font-semibold mt-1">Tracking: ${item.expressTracking}</div>`;
                        } else {
                            detailsBlockHTML = `<div class="text-xs text-gray-500">วันที่จัดส่ง: ${item.claimDate || '-'}</div>`;
                        }
                        break;
                    case 'pending_claim':
                    default:
                        statusBlockHTML = `<button class="claim-btn bg-thm-primary text-white font-bold py-1 px-3 text-sm rounded-lg hover:bg-thm-primary-dark transition-colors" data-unique-id="${item.uniqueId}" data-item-name="${item.itemName}">รับของ</button>`;
                        detailsBlockHTML = `<div class="inline-block px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">รอรับ</div>`;
                        break;
                }

                return `
                    <li class="bg-white/80 p-4 rounded-lg shadow-sm">
                        <div class="flex justify-between items-start space-x-4">
                            <div class="flex-grow">
                                <div class="font-semibold text-thm-primary-dark">${item.itemName}</div>
                                <div class="text-xs text-gray-500 mt-2">วันที่แลก: ${item.redeemDate}</div>
                            </div>
                            <div class="flex-shrink-0 text-right space-y-2">
                                <div class="flex justify-end">${statusBlockHTML}</div>
                                ${detailsBlockHTML}
                            </div>
                        </div>
                    </li>`;

            }).join('');
            document.querySelectorAll('.claim-btn').forEach(button => button.addEventListener('click', handleClaimButtonClick));
        } catch (e) {
            console.error("Error in initWarehouse:", e);
            showAlert("เกิดข้อผิดพลาด", "ไม่สามารถโหลดคลังของรางวัลได้");
            if (warehouseListEl) warehouseListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดคลัง</li>`;
        }
    }
    function handleClaimButtonClick(event) {
      if (warehousePollingInterval) { clearInterval(warehousePollingInterval); warehousePollingInterval = null; }
      const btn = event.currentTarget;
      const { uniqueId, itemName } = btn.dataset;
      qrConfirmBtn.classList.add('hidden');
      qrDialogTitle.textContent = `สแกนเพื่อรับ: ${itemName}`;
      qrDialogItemName.textContent = `ID เฉพาะ: ${uniqueId}`;
      qrcodeContainer.innerHTML = '';
      try { const qr = qrcode(4, 'L'); qr.addData(uniqueId); qr.make(); qrcodeContainer.innerHTML = qr.createImgTag(6, 4); }
      catch (e) { qrcodeContainer.innerHTML = `<p class="text-red-500">ไม่สามารถสร้าง QR Code ได้</p>`; console.error(e); }
      document.getElementById('sendMessageToOABtn').onclick = async () => {
        const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(uniqueId)}`;
        const flexMessage = { "type": "bubble", "body": { "type": "box", "layout": "vertical", "spacing": "md", "contents": [{ "type": "image", "url": qrImageUrl, "size": "5xl", "aspectRatio": "1:1", "aspectMode": "cover" }, { "type": "text", "text": "แจ้งรับของรางวัล", "weight": "bold", "align": "center", "size": "md", "color": "#000000" }, { "type": "separator" }, { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [{ "type": "box", "layout": "baseline", "spacing": "sm", "contents": [{ "type": "text", "text": "สินค้า", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": itemName, "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }] }, { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [{ "type": "text", "text": "รหัส", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": uniqueId, "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }] }] }] }, "footer": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": `แจ้งจากคุณ: ${userState.profile.displayName}`, "size": "xs", "color": "#888888", "align": "center" }] } };
        try { if (!liff.isInClient()) { showAlert('ไม่สามารถส่งได้', 'ฟังก์ชันนี้ใช้ได้เมื่อเปิดผ่านแอป LINE เท่านั้น'); return; } await liff.sendMessages([{ type: 'flex', altText: `แจ้งรับของรางวัล: ${itemName}`, contents: flexMessage }]); showAlert('ส่งข้อความสำเร็จ', 'ข้อความของคุณถูกส่งไปยังพนักงานแล้ว'); }
        catch (error) { console.error('Failed to send flex message:', error); showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถส่งข้อความได้'); }
      };
      async function checkClaimStatus() {
        try {
          const res = await fetch(`${CONFIG.GAS_URL}?action=getWarehouseItemStatus&uniqueId=${uniqueId}`);
          const data = await res.json();
          if (data && data.status === 'claimed') {
            console.log('Item has been claimed!'); clearInterval(warehousePollingInterval); warehousePollingInterval = null;
            qrcodeContainer.innerHTML = `<div class="text-center text-green-600 font-bold text-lg p-4">✅ สินค้า "${itemName}" ถูกรับแล้ว!</div>`;
            qrCloseBtn.textContent = 'ปิด'; setTimeout(() => { qrDialog.close(); initWarehouse(); }, 2000);
          } else if (data && data.status === 'not_found') {
            console.error(`Polling: Warehouse item with UniqueID ${uniqueId} not found.`); clearInterval(warehousePollingInterval); warehousePollingInterval = null;
            qrcodeContainer.innerHTML = `<p class="text-red-500">รายการนี้ไม่ถูกต้องหรือไม่พบในระบบ</p>`; setTimeout(() => qrDialog.close(), 3000);
          }
        } catch (err) {
          console.error('Polling failed:', err); clearInterval(warehousePollingInterval); warehousePollingInterval = null;
          qrcodeContainer.innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาดในการตรวจสอบสถานะ.</p>`; setTimeout(() => qrDialog.close(), 3000);
        }
      }
      warehousePollingInterval = setInterval(checkClaimStatus, 2000); // Poll every 2 seconds
      qrCloseBtn.onclick = () => { if (warehousePollingInterval) { clearInterval(warehousePollingInterval); warehousePollingInterval = null; } qrDialog.close(); };
      qrDialog.addEventListener('close', () => { if (warehousePollingInterval) { clearInterval(warehousePollingInterval); warehousePollingInterval = null; } }, { once: true });
      qrDialog.showModal();
    }

    // --- APP START ---
    async function initializeApp() {
      const liffReady = await ensureLIFFAndFetchInitialData();
      if (!liffReady) return;
      window.addEventListener('hashchange', router);
      router();
    }

    initializeApp();
  </script>
</body>

</html>
