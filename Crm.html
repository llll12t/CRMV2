<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CRM-3RN</title>
  <!-- Load config before main script -->
  <script src="Config.js"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- DaisyUI CDN (includes Tailwind CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- QR Code Generator Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

  <style>
    .hidden { display: none !important; }
    .neon-text {
      color: #fff;
      text-shadow: 0 0 5px #ff005e, 0 0 10px #ff005e, 0 0 20px #ff005e, 0 0 40px #ff005e, 0 0 80px #ff005e;
      animation: glow 1.5s infinite alternate;
    }
    @keyframes glow {
      from { text-shadow: 0 0 5px #ff005e, 0 0 10px #ff005e, 0 0 20px #ff005e; }
      to { text-shadow: 0 0 10px #00d4ff, 0 0 20px #00d4ff, 0 0 40px #00d4ff; }
    }
    @keyframes pulse-opacity {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .loading-card-animation { animation: pulse-opacity 1.5s infinite ease-in-out; }
    .glass-white {
      background: rgba(255, 255, 255, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8.1px); -webkit-backdrop-filter: blur(8.1px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
     /* ปรับขนาด QR Code ให้เหมาะสมกับ container */
     #qrcode canvas {
      width: 100% !important;
      height: auto !important;
    }
    #qrcode img {
       width: 100% !important;
      height: auto !important;
      image-rendering: pixelated; /* ช่วยให้ QR code คมชัดขึ้น */
    }
  </style>
</head>

<body class="bg-gradient-to-b from-neutral via-white to-white min-h-screen relative bg-fixed p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 id="pageTitle" class="text-xl font-bold text-white">กำลังโหลด...</h2>
    <div class="glass-white rounded-full flex items-center p-1 space-x-2">
      <div id="pointVal" class="font-bold neon-text text-lg px-2">0</div>
      <img id="lineDisplayPicture" class="mask mask-circle w-10 h-10 rounded-full object-cover border border-black" src="https://img.daisyui.com/images/stock/photo-1567653418876-5bb0e566e1c2.webp" alt="รูปโปรไฟล์" />
    </div>
  </div>

  <!-- Main App Container -->
  <div id="app">
    <div class="text-center text-gray-100 py-8">กำลังโหลดเนื้อหา...</div>
  </div>

  <!-- Dialogs -->
  <dialog id="customAlertDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="customAlertTitle" class="font-bold text-lg mb-3"></h3>
      <p id="customAlertMessage" class="py-4 whitespace-pre-line"></p>
      <div class="modal-action justify-center">
        <button id="customAlertButton" class="btn btn-neutral w-full">ตกลง</button>
      </div>
    </div>
  </dialog>

  <dialog id="customConfirmDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="customConfirmTitle" class="font-bold text-lg mb-3"></h3>
      <p id="customConfirmMessage" class="py-4"></p>
      <div class="modal-action justify-around">
        <button id="customConfirmCancelButton" class="btn btn-outline btn-neutral">ยกเลิก</button>
        <button id="customConfirmConfirmButton" class="btn btn-neutral">ยืนยัน</button>
      </div>
    </div>
  </dialog>

  <!-- QR Code Dialog (for Warehouse Claim) -->
  <dialog id="qrDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="qrDialogTitle" class="font-bold text-lg mb-2">สแกนเพื่อรับของ</h3>
      <p id="qrDialogItemName" class="mb-4 text-sm text-gray-600"></p>
      <div id="qrcode" class="flex justify-center mb-4 p-4 bg-white rounded-lg"></div>
      <p class="text-xs text-gray-500 mb-4">ให้พนักงานสแกน QR Code นี้เพื่อตรวจสอบและยืนยันการรับสินค้า</p>
      <div class="modal-action justify-around">
        <button id="qrDialogCloseBtn" class="btn btn-outline">ปิด</button>
        <!-- ปุ่มยืนยันจะถูกซ่อนด้วย JavaScript เพราะเราจะใช้ระบบตรวจสอบอัตโนมัติ -->
        <button id="qrDialogConfirmBtn" class="btn btn-neutral hidden">ยืนยันการรับของ</button>
      </div>
    </div>
  </dialog>

<!-- Shipping Form Dialog (for Physical Items) -->
<dialog id="shippingFormDialog" class="modal">
  <div class="modal-box">
    <h3 id="shippingFormTitle" class="font-bold text-lg mb-4">ข้อมูลสำหรับจัดส่ง</h3>
    <div class="space-y-4">
      <div>
        <label class="label"><span class="label-text">ชื่อ-นามสกุล ผู้รับ</span></label>
        <input id="shippingName" type="text" placeholder="กรอกชื่อ-นามสกุล" class="input input-bordered w-full" />
      </div>
      <div>
        <label class="label"><span class="label-text">เบอร์โทรศัพท์ติดต่อ</span></label>
        <input id="shippingPhone" type="tel" placeholder="กรอกเบอร์โทรศัพท์" class="input input-bordered w-full" />
      </div>
      <div>
        <label class="label"><span class="label-text">ที่อยู่สำหรับจัดส่ง</span></label>
        <textarea id="shippingAddress" class="textarea textarea-bordered w-full" rows="4" placeholder="บ้านเลขที่, ถนน, ตำบล, อำเภอ, จังหวัด, รหัสไปรษณีย์"></textarea>
      </div>
    </div>
    <div class="modal-action justify-between mt-6">
      <button id="shippingFormCancelBtn" class="btn btn-outline">ยกเลิก</button>
      <button id="shippingFormConfirmBtn" class="btn btn-neutral">ยืนยันและแลกของ</button>
    </div>
  </div>
</dialog>


  <!-- Template: Dashboard (Main Menu) -->
  <template id="view-dashboard">
    <div class="glass-white rounded p-4 grid grid-cols-3 gap-3 text-center text-sm font-medium mb-6">
      <a href="#event" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
        <span>กิจกรรม</span>
      </a>
      <a href="#warehouse" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
        <span>คลัง</span>
      </a>
      <a href="#addpoint" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="none"><path d="M2.5 8.18677C2.60406 6.08705 2.91537 4.77792 3.84664 3.84664C4.77792 2.91537 6.08705 2.60406 8.18677 2.5M21.5 8.18677C21.3959 6.08705 21.0846 4.77792 20.1534 3.84664C19.2221 2.91537 17.9129 2.60406 15.8132 2.5M15.8132 21.5C17.9129 21.3959 19.2221 21.0846 20.1534 20.1534C21.0846 19.2221 21.3959 17.9129 21.5 15.8132M8.18676 21.5C6.08705 21.3959 4.77792 21.0846 3.84664 20.1534C2.91537 19.2221 2.60406 17.9129 2.5 15.8132" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path><path d="M2.49986 12H21.4999" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path><path d="M6 12C6 8.68629 8.68629 6 12 6C12 7.65685 13.3431 9 15 9C15.6755 9 16.2989 8.77672 16.8004 8.39993C17.5536 9.40273 18 10.6492 18 12M17.1973 15C16.1599 16.7934 14.2208 18 12 18C9.77915 18 7.84012 16.7934 6.80269 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        <span>สแกนรับ</span>
      </a>
      <a href="#transfer" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
        <span>โอนพ้อย</span>
      </a>
      <a href="#redeem" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
        <span>แลกพ้อย</span>
      </a>
      <a href="#profile" class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        <span>บัญชี</span>
      </a>
    </div>

    <div id="checkinBox" class="flex items-center justify-between mb-8 hidden">
      <div class="bg-gray-100 rounded-full px-4 py-2 flex items-center space-x-2 text-gray-700">
        <span class="text-sm">วันที่</span><span id="todayDate" class="font-bold text-md">00</span>
      </div>
      <div class="bg-yellow-400 rounded-full w-10 h-10 flex items-center justify-center text-white font-bold text-sm">+1</div>
      <button id="checkinBtn" class="btn btn-neutral btn-sm">เช็คอิน</button>
    </div>

    <div>
      <div class="flex justify-between items-center mb-4">
        <div class="font-bold text-lg">รายการล่าสุด</div>
        <div class="text-xs text-gray-400 font-medium">POINT</div>
      </div>
      <ul id="historyList" class="space-y-4"></ul>
    </div>
  </template>

  <!-- Template: Event List -->
  <template id="view-event">
    <div id="eventList" class="space-y-3"></div>
  </template>

  <!-- Template: Event Detail -->
  <template id="view-event-detail">
    <div id="cardWrapper">
      <div id="cardSkeleton" class="bg-white p-6 rounded shadow-md mb-6 animate-pulse"><div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div><div class="h-4 bg-gray-200 rounded w-1/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-full mb-6"></div><div class="h-12 bg-gray-200 rounded-full w-full"></div></div>
      <div id="card" class="bg-white p-6 rounded shadow-md text-gray-800 mb-6 hidden">
        <div class="flex justify-between items-start mb-3"><div class="font-bold text-lg" id="eventDetailTitle">–</div><div class="bg-yellow-400 text-black font-bold text-md px-3 py-1 rounded-full" id="eventPoint">0+</div></div>
        <div class="text-sm text-gray-700 mb-6 leading-relaxed" id="eventDetailDesc">...</div>
        <button id="joinBtn" class="btn btn-neutral w-full">เข้าร่วม</button>
      </div>
    </div>
  </template>

  <!-- Template: Profile -->
  <template id="view-profile">
    <div class="space-y-4">
      <div class="glass-white p-6 rounded-lg text-center shadow-md">
        <div class="relative w-24 h-24 mx-auto mb-4">
          <img id="profileDisplayPicture" class="mask mask-circle w-24 h-24 rounded-full object-cover border-4 border-black" src="https://img.daisyui.com/images/stock/photo-1567653418876-5bb0e566e1c2.webp" alt="รูปโปรไฟล์" />
          <button id="editProfileBtn" class="absolute bottom-0 right-0 bg-white rounded-full p-1.5 shadow-md hover:scale-110 transition-transform"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.389-2.828-2.828z" /></svg></button>
        </div>
        <div class="text-2xl font-bold mb-2" id="profileDisplayName">กำลังโหลด...</div>
        <div class="flex items-center justify-center space-x-2 mb-2"><span id="profileLevelBadge" class="badge badge-lg"></span><span id="profileCustomTagBadge" class="badge badge-lg"></span></div>
        <progress id="profileProgressBar" class="progress progress-warning w-full" value="0" max="100"></progress>
        <div id="profilePointsToNextLevel" class="text-sm text-gray-700 mt-1"></div>
        <div class="font-bold text-xl mt-4">รวมพ้อยต์: <span id="profileTotalPoints">0</span></div>
      </div>
      <div id="profileFormContainer" class="bg-white p-6 rounded-lg shadow-md space-y-4 hidden">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">LINE ID</label><input id="profileLineId" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label><input id="profileName" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label><input id="profilePhone" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label><input id="profileEmail" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่</label><input id="profileAddress" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label><input id="profileNote" readonly class="input input-bordered w-full cursor-not-allowed text-gray-500" /></div>
        <div id="profileEditButtons" class="flex space-x-2 hidden"><button id="saveProfileBtn" class="btn btn-neutral flex-1">บันทึกข้อมูล</button><button id="cancelEditBtn" class="btn btn-outline btn-neutral flex-1">ยกเลิก</button></div>
      </div>
    </div>
  </template>

  <!-- Template: Redeem -->
  <template id="view-redeem">
    <div class="p-0"><ul id="redeemList" class="grid grid-cols-2 gap-4"></ul></div>
  </template>

  <!-- Template: Transfer -->
  <template id="view-transfer">
    <div class="space-y-4 mb-6">
      <input id="transferTo" placeholder="LINE ID เพื่อน / เบอร์โทรปลายทาง" type="text" class="input input-bordered input-neutral w-full">
      <input id="transferAmount" placeholder="จำนวนพ้อยที่ต้องการโอน" type="number" class="input input-bordered input-neutral w-full">
      <button id="transferBtn" class="btn btn-neutral w-full">โอนพ้อย</button>
    </div>
  </template>

  <!-- Template: Warehouse -->
  <template id="view-warehouse">
    <ul id="warehouseList" class="space-y-3"></ul>
  </template>

  <!-- Template: Add Points (Scan/Manual Code) -->
  <template id="view-addpoint">
    <div id="scanContainer" class="space-y-4 mb-6">
      <button id="scanBtn" class="btn btn-neutral w-full">สแกน QR Code</button>
      <div class="flex space-x-2">
        <input id="manualCode" type="text" placeholder="กรอกโค้ดที่นี่" class="input input-bordered input-neutral flex-1">
        <button id="enterBtn" class="btn btn-neutral">รับโค้ด</button>
      </div>
    </div>
  </template>

<script>
    // --- GLOBAL STATE & CACHE ---
    let liffInitialized = false;
    const userState = { profile: null, lineId: "", points: 0, pointsChanged: false, level: "Member", customTag: "" };
    const dataCache = { events: null, redeemItems: null, eventDetails: {}, userProfileFull: null, history: null, levelSettings: null };

    // เพิ่มตัวแปรนี้สำหรับเก็บ Polling interval
    let pollingInterval = null;

    // --- DIALOGS & UI ELEMENTS ---
    const alertDialog = document.getElementById('customAlertDialog'), alertT = document.getElementById('customAlertTitle'), alertM = document.getElementById('customAlertMessage'), alertBtn = document.getElementById('customAlertButton');
    const confirmDialog = document.getElementById('customConfirmDialog'), confT = document.getElementById('customConfirmTitle'), confM = document.getElementById('customConfirmMessage'), okBtn = document.getElementById('customConfirmConfirmButton'), noBtn = document.getElementById('customConfirmCancelButton');
    const pageTitleEl = document.getElementById('pageTitle'), pointValEl = document.getElementById('pointVal'), dpEl = document.getElementById('lineDisplayPicture');
    // Warehouse QR Dialog Elements
    const qrDialog = document.getElementById('qrDialog'), qrDialogTitle = document.getElementById('qrDialogTitle'), qrDialogItemName = document.getElementById('qrDialogItemName'), qrcodeContainer = document.getElementById('qrcode'), qrConfirmBtn = document.getElementById('qrDialogConfirmBtn'), qrCloseBtn = document.getElementById('qrDialogCloseBtn');
    // Shipping Form Dialog Elements
    const shippingFormDialog = document.getElementById('shippingFormDialog'), shippingFormTitle = document.getElementById('shippingFormTitle'), shippingNameInput = document.getElementById('shippingName'), shippingPhoneInput = document.getElementById('shippingPhone'), shippingAddressInput = document.getElementById('shippingAddress'), shippingFormConfirmBtn = document.getElementById('shippingFormConfirmBtn'), shippingFormCancelBtn = document.getElementById('shippingFormCancelBtn');


    // --- STYLES ---
    const LEVEL_STYLES = { 'Member': { text: 'Member', class: 'badge-info badge-outline' }, 'VIP': { text: 'VIP', class: 'badge-primary badge-outline' }, 'Super': { text: 'Super', class: 'badge-success badge-outline' } };
    const CUSTOM_TAG_STYLES = { 'newuser': { class: 'badge-warning', text: 'สมาชิกใหม่' }, 'ceo': { class: 'badge-accent', text: 'CEO' }, 'admin': { class: 'badge-error', text: 'ผู้ดูแล' }, 'tester': { class: 'badge-secondary', text: 'ผู้ทดสอบ' }, 'default': { class: 'badge-neutral', text: '' } };

    // --- COMMON UI FUNCTIONS ---
    function showAlert(title, message, cb) {
      alertT.textContent = title; alertM.textContent = message; alertDialog.showModal();
      const hide = () => { alertDialog.close(); alertBtn.removeEventListener('click', hide); cb && cb(); };
      alertBtn.addEventListener('click', hide);
    }
    function showConfirm(title, message) {
      return new Promise(res => {
        confT.textContent = title; confM.textContent = message; confirmDialog.showModal();
        const onOk = () => { cleanup(); res(true); }; const onNo = () => { cleanup(); res(false); };
        function cleanup() { confirmDialog.close(); okBtn.removeEventListener('click', onOk); noBtn.removeEventListener('click', onNo); }
        okBtn.addEventListener('click', onOk); noBtn.addEventListener('click', onNo);
      });
    }

    // --- DATA & STATE MANAGEMENT ---
    function calculateLevelAndProgress(currentPoints) {
      const vipPoints = dataCache.levelSettings?.VIP_points || 5000;
      const superPoints = dataCache.levelSettings?.SUPER_points || 10000;
      let level = 'Member', currentLevelMin = 0, nextLevelMin = vipPoints, nextLevelName = 'VIP';
      if (currentPoints >= superPoints) { level = 'Super'; currentLevelMin = superPoints; nextLevelMin = currentPoints; nextLevelName = ''; }
      else if (currentPoints >= vipPoints) { level = 'VIP'; currentLevelMin = vipPoints; nextLevelMin = superPoints; nextLevelName = 'Super'; }
      const pointsInCurrentTier = currentPoints - currentLevelMin; const pointsToNextTier = nextLevelMin - currentLevelMin;
      let progressValue = 0, pointsNeeded = 0;
      if (nextLevelName) { progressValue = (pointsInCurrentTier / pointsToNextTier) * 100; pointsNeeded = nextLevelMin - currentPoints; }
      else { progressValue = 100; pointsNeeded = 0; }
      return { level, progressValue: Math.min(100, Math.max(0, progressValue)), pointsToNext: pointsNeeded, nextLevelName };
    }
    function setBadgeContent(badgeElement, text, className) {
      if (!badgeElement) return; badgeElement.textContent = text; badgeElement.className = className;
      if (text) badgeElement.classList.remove('hidden'); else badgeElement.classList.add('hidden');
    }
    async function fetchAndUpdateUserState() {
      try {
        const userRes = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`);
        const userData = await userRes.json();
        if (userData && !userData.error) {
          userState.points = parseInt(userData.point || 0, 10);
          userState.level = userData.level || 'Member';
          userState.customTag = userData.customTag || '';
          dataCache.userProfileFull = userData;
          pointValEl.textContent = userState.points;
          userState.pointsChanged = true; // Mark history cache as potentially stale
          console.log(`User state updated: Points=${userState.points}, Level=${userState.level}, Tag=${userState.customTag}`);
        } else { console.error("Failed to fetch user data after action:", userData?.error || "Unknown error"); }
      } catch (e) { console.error("Error fetching user info after action:", e); }
    }

    // --- LIFF & APP INITIALIZATION ---
    async function ensureLIFFAndFetchInitialData() {
      if (!liffInitialized) {
        try { await liff.init({ liffId: CONFIG.LIFF_ID }); liffInitialized = true; }
        catch (e) { console.error("LIFF initialization failed", e); showAlert("ข้อผิดพลาด", "ไม่สามารถเริ่มต้น LIFF ได้ กรุณาลองใหม่ภายหลัง"); return false; }
      }
      if (!liff.isLoggedIn()) { liff.login(); return false; }
      if (!userState.profile) {
        userState.profile = await liff.getProfile(); userState.lineId = userState.profile.userId;
        dpEl.src = userState.profile.pictureUrl || 'https://via.placeholder.com/40';
        dpEl.alt = `รูปโปรไฟล์ของ ${userState.profile.displayName}`;
      }
      pointValEl.textContent = '...'; // Show loading indicator for points
      try {
        // Fetch initial data concurrently
        const [userRes, histRes, eventsRes, redeemRes, settingsRes] = await Promise.all([
          fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`),
          fetch(`${CONFIG.GAS_URL}?action=getHistory&lineId=${userState.lineId}`),
          fetch(`${CONFIG.GAS_URL}?action=getEvents`),
          fetch(`${CONFIG.GAS_URL}?action=getItems`),
          fetch(`${CONFIG.GAS_URL}?action=getLevelConfig`)
        ]);

        const userData = await userRes.json();
        const historyData = await histRes.json();
        dataCache.events = await eventsRes.json();
        dataCache.redeemItems = await redeemRes.json();
        const settingsData = await settingsRes.json();

        // Process level settings
        if (settingsData && !settingsData.error) { dataCache.levelSettings = { VIP_points: parseInt(settingsData.VIP_points || 0), SUPER_points: parseInt(settingsData.SUPER_points || 0) }; }
        else { console.warn("Failed to load level settings, using defaults."); dataCache.levelSettings = { VIP_points: 5000, SUPER_points: 10000 }; }

        // Check user registration status
        if (!userData || !userData.isRegistered) { window.location.href = 'register.html'; return false; }

        // Update user state and cache
        userState.points = parseInt(userData.point || 0, 10);
        userState.level = userData.level || 'Member';
        userState.customTag = userData.customTag || '';
        dataCache.userProfileFull = userData;
        pointValEl.textContent = userState.points.toLocaleString(); // Update points display
        dataCache.history = historyData; // Cache initial history
        userState.pointsChanged = false; // Reset flag after loading history

      } catch (error) {
          console.error("Failed to fetch initial data:", error);
          pointValEl.textContent = 'N/A';
          showAlert("ข้อผิดพลาด", `ไม่สามารถโหลดข้อมูลผู้ใช้ได้ กรุณาลองใหม่ (${error.message})`);
          // Depending on severity, you might want to prevent navigation or show a specific error page
          return false;
      }
      return true; // Indicate successful initialization and data fetch
    }


    // --- ROUTER ---
    const routes = {
      '#dashboard': { title: 'CRM-3RN', tpl: 'view-dashboard', init: initDashboard },
      '#event': { title: 'กิจกรรม', tpl: 'view-event', init: initEvent },
      '#event-detail': { title: 'รายละเอียดกิจกรรม', tpl: 'view-event-detail', init: initEventDetail },
      '#profile': { title: 'โปรไฟล์ของคุณ', tpl: 'view-profile', init: initProfile },
      '#redeem': { title: 'ร้านค้าแลกของรางวัล', tpl: 'view-redeem', init: initRedeem },
      '#transfer': { title: 'โอนพ้อยให้เพื่อน', tpl: 'view-transfer', init: initTransfer },
      '#warehouse': { title: 'คลังของรางวัล', tpl: 'view-warehouse', init: initWarehouse },
      '#addpoint': { title: 'โค้ดเพื่อรับรางวัล', tpl: 'view-addpoint', init: initAddpoint },
      '': { title: 'CRM-3RN', tpl: 'view-dashboard', init: initDashboard }
    };
    async function router() {
      // Clear any active polling before navigating
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('Cleared polling interval on route change.');
      }
      // Close any open modals on route change (optional but good practice)
      if (qrDialog.open) qrDialog.close();
      if (shippingFormDialog.open) shippingFormDialog.close();
      if (alertDialog.open) alertDialog.close();
      if (confirmDialog.open) confirmDialog.close();


      const hash = window.location.hash.split('?')[0] || '';
      const route = routes[hash] || routes[''];
      pageTitleEl.textContent = route.title;
      const appDiv = document.getElementById('app'); appDiv.innerHTML = ''; // Clear previous view
      const template = document.getElementById(route.tpl);
      if (template) { appDiv.appendChild(template.content.cloneNode(true)); }
      else { appDiv.innerHTML = `<p class="text-center text-red-500 py-8">เกิดข้อผิดพลาด: ไม่พบเทมเพลตสำหรับ ${hash}</p>`; return; }

      // Call the initialization function for the new view
      try {
          console.log(`Initializing view: ${route.tpl}`);
          await route.init();
      } catch (error) {
          console.error(`Error initializing view ${route.tpl}:`, error);
          showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลหน้านี้ได้');
      }
    }

    // --- SKELETONS & HELPERS ---
    function generateListSkeleton(count) { return Array.from({ length: count }).map(_ => `<li class="flex justify-between items-center animate-pulse py-3"><div class="space-y-2 flex-1"><div class="h-4 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-1/3 mt-1"></div></div><div class="h-6 w-12 bg-gray-200 rounded-full"></div></li>`).join(""); }
    function generateCardSkeleton(count) { return Array.from({ length: count }).map(_ => `<li class="bg-white p-4 rounded shadow-sm loading-card-animation"><div class="h-24 bg-gray-200 rounded-md mb-3"></div><div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div><div class="h-8 bg-gray-200 rounded-full w-full"></div></li>`).join(''); }
    function renderHistoryList(historyData) {
      const el = document.getElementById('historyList'); if (!el) return;
      // Sort history by date descending and take the latest 10
      const sortedHistory = historyData.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
      if (sortedHistory.length === 0) { el.innerHTML = `<li class="text-center text-gray-400 py-4">ไม่มีประวัติการทำรายการ</li>`; return; }
      el.innerHTML = sortedHistory.map(item => {
        const isDebit = ['redeem', 'transfer_out'].includes(item.type);
        const datePart = item.date ? item.date.split(' ')[0] : ''; // Get only date part
        return `<li class="flex justify-between items-center"><div><div class="font-medium text-gray-800 text-sm">${item.detail}</div><div class="text-xs text-gray-400 mt-1">${datePart}</div></div><div class="text-sm font-bold px-4 py-1.5 rounded-full ${isDebit ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${isDebit ? '-' : '+'} ${item.amount.toLocaleString()}</div></li>`;
      }).join("");
    }
     // Helper to get fresh or cached history
    async function getFreshOrCachedHistory() {
      // Fetch fresh history only if points have changed or cache is empty
      if (userState.pointsChanged || !dataCache.history || dataCache.history.length === 0) {
        try {
          console.log("Fetching fresh history...");
          const res = await fetch(`${CONFIG.GAS_URL}?action=getHistory&lineId=${userState.lineId}`);
          dataCache.history = await res.json();
          userState.pointsChanged = false; // Reset flag
        } catch (e) {
          console.error("Error fetching history:", e);
          dataCache.history = []; // Set to empty array on error
          userState.pointsChanged = false; // Reset flag even on error
        }
      } else {
           console.log("Using cached history.");
      }
      return dataCache.history;
    }


    // --- VIEW INITIALIZATION FUNCTIONS ---
    async function initDashboard() {
      const historyListEl = document.getElementById('historyList');
      const checkinBox = document.getElementById('checkinBox');
      const todayDateEl = document.getElementById('todayDate');
      const checkinBtn = document.getElementById('checkinBtn');

      // Show skeleton while waiting for history
      if (historyListEl) historyListEl.innerHTML = generateListSkeleton(5);

      try {
        // Fetch checkin status and history concurrently
        const [checkRes, history] = await Promise.all([
            fetch(`${CONFIG.GAS_URL}?action=checkinStatus&lineId=${userState.lineId}`).then(r => r.json()),
            getFreshOrCachedHistory() // Use the helper function
        ]);

        // Render history once fetched
        renderHistoryList(history);

        // Handle check-in status
        if (checkBox && !checkRes.checkedInToday) {
          checkinBox.classList.remove('hidden');
          todayDateEl.textContent = new Date().getDate().toString().padStart(2, "0");
          checkinBtn.onclick = async () => {
            checkinBtn.disabled = true;
            checkinBtn.textContent = 'กำลังเช็คอิน...';
            try {
              const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify({ action: "dailyCheckin", lineId: userState.lineId }) });
              const text = await res.text();
              showAlert('เช็คอิน', text, async () => {
                  if (text.includes("สำเร็จ")) {
                      await fetchAndUpdateUserState(); // Update points and mark history stale
                       checkinBox.classList.add('hidden'); // Hide check-in box
                      // Re-render dashboard to show updated points and potentially new history
                      router(); // Navigate back to dashboard to refresh
                  } else {
                     checkinBtn.disabled = false;
                     checkinBtn.textContent = 'เช็คอิน';
                  }
              });
            } catch (e) {
              console.error("Check-in failed:", e);
              showAlert('ข้อผิดพลาด', 'ไม่สามารถเช็คอินได้');
              checkinBtn.disabled = false;
              checkinBtn.textContent = 'เช็คอิน';
            }
          };
        } else if (checkinBox) {
             console.log("Checked in today or checkinBox not found.");
             checkinBox.classList.add('hidden');
        }
      } catch (e) {
        console.error("Error in initDashboard:", e);
         if (historyListEl) historyListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดข้อมูล</li>`;
         if (checkinBox) checkinBox.classList.add('hidden'); // Hide on error
      }
    }


    async function initEvent() {
      const eventListEl = document.getElementById('eventList');
      if (eventListEl) eventListEl.innerHTML = generateListSkeleton(5); // Show skeleton

      let events = dataCache.events;
      if (!events || events.length === 0) {
        try {
            console.log("Fetching events...");
            const res = await fetch(`${CONFIG.GAS_URL}?action=getEvents`);
            events = await res.json();
            if (events.error) throw new Error(events.error);
            dataCache.events = events; // Cache fetched events
        } catch (e) {
            console.error("Error fetching events:", e);
            if (eventListEl) eventListEl.innerHTML = `<div class="text-center text-red-500 py-8">เกิดข้อผิดพลาดในการโหลดกิจกรรม: ${e.message}</div>`;
            return; // Exit if fetching fails
        }
      } else {
          console.log("Using cached events.");
      }


      if (!events || events.length === 0) {
          eventListEl.innerHTML = `<div class="text-center text-gray-400 py-8">ไม่มีกิจกรรมในขณะนี้</div>`;
          return;
      }

      // Filter events by allowed levels
      const filteredEvents = events.filter(e => !e.allowedLevels || e.allowedLevels.length === 0 || e.allowedLevels.includes(userState.level));

      if (filteredEvents.length === 0) {
          eventListEl.innerHTML = `<div class="text-center text-gray-400 py-8">ไม่มีกิจกรรมสำหรับระดับของคุณในขณะนี้</div>`;
          return;
      }

      // Render event list
      eventListEl.innerHTML = filteredEvents.map(e => `
          <div class="bg-white rounded p-4 flex justify-between items-center shadow-sm">
              <div>
                  <div class="font-semibold text-gray-800 text-sm">${e.title}</div>
                  <div class="text-xs text-gray-500">${e.desc ? e.desc.substring(0, 50) + '...' : 'ไม่มีคำอธิบาย'}</div>
              </div>
              <a href="#event-detail?id=${e.id}" class="btn btn-neutral btn-sm">ดูรายละเอียด</a>
          </div>
      `).join('');
    }


    async function initEventDetail() {
      const params = new URLSearchParams(window.location.hash.split('?')[1]);
      const eventId = params.get("id");
      if (!eventId) {
          showAlert('ข้อผิดพลาด', 'ไม่พบ ID กิจกรรม');
          window.location.hash = '#event'; // Redirect back to event list
          return;
      }

      const cardSkeleton = document.getElementById('cardSkeleton');
      const card = document.getElementById('card');
      const titleEl = document.getElementById('eventDetailTitle');
      const descEl = document.getElementById('eventDetailDesc');
      const pointEl = document.getElementById('eventPoint');
      const joinBtn = document.getElementById('joinBtn');

      // Show skeleton, hide card
      if(cardSkeleton && card) {
        cardSkeleton.classList.remove('hidden');
        card.classList.add('hidden');
      } else {
           // Handle case where elements aren't found
           console.error("Event detail elements not found.");
           showAlert('ข้อผิดพลาด', 'ไม่สามารถแสดงรายละเอียดกิจกรรมได้');
            window.location.hash = '#event';
            return;
      }


      let eventData = dataCache.eventDetails[eventId];

      // Fetch event detail if not in cache
      if (!eventData) {
        try {
            console.log(`Fetching event detail for ID: ${eventId}`);
            const res = await fetch(`${CONFIG.GAS_URL}?action=getEventById&id=${eventId}`);
            const fetchedData = await res.json();
            if (fetchedData.error) throw new Error(fetchedData.error);
            eventData = fetchedData;
            dataCache.eventDetails[eventId] = eventData; // Cache the fetched data
        } catch (e) {
            console.error("Error fetching event detail:", e);
            // Set a placeholder error state if fetch fails
            eventData = { error: `ไม่สามารถโหลดรายละเอียดได้: ${e.message}` };
            dataCache.eventDetails[eventId] = eventData; // Cache the error state too? Depends on desired behavior
        }
      } else {
           console.log(`Using cached event detail for ID: ${eventId}`);
      }

      // Fetch history to check if user already joined
      const history = await getFreshOrCachedHistory(); // Use the helper function

      // Hide skeleton and show card (even if there's an error to display the message)
      cardSkeleton.classList.add("hidden");
      card.classList.remove("hidden");

      if (eventData.error) {
          // Display error message
          titleEl.textContent = "ไม่พบกิจกรรม";
          descEl.textContent = eventData.error;
          pointEl.textContent = 'N/A';
          joinBtn.textContent = "ไม่พร้อมใช้งาน";
          joinBtn.disabled = true;
      } else {
          // Display event details
          titleEl.textContent = eventData.title;
          pointEl.textContent = `${eventData.point}+`;
          descEl.textContent = eventData.desc;

          // Check if user has already joined this event
          const hasJoined = history.some(item => item.type === 'event' && item.eventId === eventId);

          // Check if user's level is allowed
          const isLevelAllowed = !eventData.allowedLevels || eventData.allowedLevels.length === 0 || eventData.allowedLevels.includes(userState.level);

          if (hasJoined) {
              joinBtn.textContent = "รับพ้อยต์แล้ว";
              joinBtn.disabled = true;
              console.log(`User ${userState.lineId} already joined event ${eventId}.`);
          } else if (!isLevelAllowed) {
              joinBtn.textContent = `สำหรับระดับ ${eventData.allowedLevels.join(', ')}`;
              joinBtn.disabled = true;
              console.log(`User ${userState.lineId} level ${userState.level} not allowed for event ${eventId}.`);
          } else {
              // Enable join button and set click handler
              joinBtn.textContent = "เข้าร่วม";
              joinBtn.disabled = false;
              joinBtn.onclick = async () => {
                  const confirmed = await showConfirm('ยืนยัน', `เข้าร่วม "${eventData.title}" และรับ ${eventData.point} พ้อยต์?`);
                  if (!confirmed) return;

                  joinBtn.disabled = true;
                  joinBtn.textContent = "กำลังเข้าร่วม...";

                  try {
                      console.log(`Joining event ${eventId}...`);
                      const res = await fetch(CONFIG.GAS_URL, {
                          method: "POST",
                          body: JSON.stringify({ action: "joinEvent", lineId: userState.lineId, eventId: eventData.id, title: eventData.title, point: eventData.point })
                      });
                      const text = await res.text();

                      showAlert("สถานะ", text, async () => {
                          if (text.includes("สำเร็จ")) {
                              await fetchAndUpdateUserState(); // Update points and mark history stale
                               // Refresh current view or navigate back
                               router(); // Best way to re-initialize the view and history
                          } else {
                              // If not successful, re-enable the button
                              joinBtn.disabled = false;
                              joinBtn.textContent = "เข้าร่วม";
                          }
                      });
                  } catch (e) {
                      console.error("Join event failed:", e);
                      showAlert('ข้อผิดพลาด', `ไม่สามารถเข้าร่วมได้: ${e.message}`);
                      joinBtn.disabled = false;
                      joinBtn.textContent = "เข้าร่วม";
                  }
              };
          }
      }
    }


    async function initProfile() {
      const dpEl = document.getElementById('profileDisplayPicture');
      const dnEl = document.getElementById('profileDisplayName');
      const lineIdEl = document.getElementById('profileLineId');
      const levelBadgeEl = document.getElementById('profileLevelBadge');
      const tagBadgeEl = document.getElementById('profileCustomTagBadge');
      const progressEl = document.getElementById('profileProgressBar');
      const progressTextEl = document.getElementById('profilePointsToNextLevel');
      const totalPointsEl = document.getElementById('profileTotalPoints');
      const nameEl = document.getElementById('profileName');
      const phoneEl = document.getElementById('profilePhone');
      const emailEl = document.getElementById('profileEmail');
      const addressEl = document.getElementById('profileAddress');
      const noteEl = document.getElementById('profileNote');
      const editBtn = document.getElementById('editProfileBtn');
      const formContainer = document.getElementById('profileFormContainer');
      const editButtonsDiv = document.getElementById('profileEditButtons');
      const saveBtn = document.getElementById('saveProfileBtn');
      const cancelBtn = document.getElementById('cancelEditBtn');

      // Array of editable input elements
      const editableInputs = [nameEl, phoneEl, emailEl, addressEl, noteEl];
      let initialData = {}; // To store original values when editing starts

      // Display basic LIFF profile info
      dpEl.src = userState.profile.pictureUrl || 'https://via.placeholder.com/96';
      dnEl.textContent = userState.profile.displayName || 'ผู้ใช้ LINE';
      totalPointsEl.textContent = userState.points.toLocaleString();

      // Calculate and display level/progress
      const { level, progressValue, pointsToNext, nextLevelName } = calculateLevelAndProgress(userState.points);
      setBadgeContent(levelBadgeEl, LEVEL_STYLES[userState.level]?.text || userState.level, `badge badge-lg ${LEVEL_STYLES[userState.level]?.class || ''}`);
      const primaryTag = (userState.customTag.split(',')[0] || '').trim().toLowerCase();
      const tagInfo = CUSTOM_TAG_STYLES[primaryTag] || CUSTOM_TAG_STYLES['default'];
      const tagText = tagInfo.text || (primaryTag ? primaryTag.charAt(0).toUpperCase() + primaryTag.slice(1) : '');
      if (!tagText) tagBadgeEl.classList.add('hidden'); else setBadgeContent(tagBadgeEl, tagText, `badge badge-lg ${tagInfo.class}`);
      progressEl.value = progressValue;
      progressTextEl.textContent = nextLevelName ? `อีก ${pointsToNext.toLocaleString()} พ้อยต์สู่ ${nextLevelName}` : `คุณอยู่ระดับสูงสุดแล้ว!`;


      // Fetch full user data if not already cached
      let uData = dataCache.userProfileFull;
      if (!uData) {
          try {
              console.log("Fetching full user profile data...");
              uData = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`).then(r => r.json());
              if (uData.error) throw new Error(uData.error);
              dataCache.userProfileFull = uData; // Cache the full data
          } catch (e) {
              console.error("Error fetching full user profile:", e);
              uData = { error: `โหลดข้อมูลล้มเหลว: ${e.message}` }; // Set error state
          }
      } else {
           console.log("Using cached full user profile data.");
      }


      if (uData.error) {
          showAlert('ข้อผิดพลาด', `ไม่สามารถโหลดข้อมูลโปรไฟล์ได้: ${uData.error}`);
           // Hide form or show error state in form area
           if (formContainer) formContainer.innerHTML = `<div class="text-center text-red-500 py-4">${uData.error}</div>`;
           if (editBtn) editBtn.classList.add('hidden'); // Hide edit button if data loading failed
           return; // Exit if data failed to load
      }

      // Populate form fields with fetched data
      initialData = {
          name: uData.name || '',
          phone: uData.phone || '',
          email: uData.email || '',
          address: uData.address || '',
          note: uData.note || ''
      };
      lineIdEl.value = userState.lineId; // Line ID is not editable
      nameEl.value = initialData.name;
      phoneEl.value = initialData.phone;
      emailEl.value = initialData.email;
      addressEl.value = initialData.address;
      noteEl.value = initialData.note;

      // Function to toggle form edit mode
      const toggleEditMode = (enable) => {
        editableInputs.forEach(input => {
            input.readOnly = !enable;
            input.classList.toggle('input-neutral', enable);
            input.classList.toggle('cursor-not-allowed', !enable);
            input.classList.toggle('text-gray-500', !enable);
        });
        formContainer.classList.toggle('hidden', !enable);
        editBtn.classList.toggle('hidden', enable);
        editButtonsDiv.classList.toggle('hidden', !enable);
      };

      // Set up event listeners for edit/cancel/save buttons
      if (editBtn) editBtn.onclick = () => toggleEditMode(true);
      if (cancelBtn) cancelBtn.onclick = () => {
          // Reset values to initial data
          Object.keys(initialData).forEach(key => {
              const inputEl = document.getElementById(`profile${key.charAt(0).toUpperCase() + key.slice(1)}`);
              if (inputEl) inputEl.value = initialData[key];
          });
          toggleEditMode(false);
      };
      if (saveBtn) saveBtn.onclick = async () => {
        // Disable buttons during save
        saveBtn.disabled = true;
        if(cancelBtn) cancelBtn.disabled = true;
        saveBtn.textContent = 'กำลังบันทึก...';

        try {
          const body = {
              action: 'updateProfile',
              lineId: userState.lineId,
              name: nameEl.value.trim(),
              phone: phoneEl.value.trim(),
              email: emailEl.value.trim(),
              address: addressEl.value.trim(),
              note: noteEl.value.trim()
          };

          console.log("Saving profile...", body);
          const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify(body) });
          const text = await res.text(); // Assuming GAS returns plain text status

          showAlert("สถานะ", text, async () => {
              if (text.includes("สำเร็จ")) {
                  // Update user state and full profile cache after successful save
                  await fetchAndUpdateUserState();
                  // Update initialData with new saved values so cancel works correctly
                  initialData = { name: nameEl.value.trim(), phone: phoneEl.value.trim(), email: emailEl.value.trim(), address: addressEl.value.trim(), note: noteEl.value.trim() };
                  toggleEditMode(false); // Exit edit mode
              }
               // Re-enable buttons regardless of success for user to retry if needed
              saveBtn.disabled = false;
              if(cancelBtn) cancelBtn.disabled = false;
               saveBtn.textContent = 'บันทึกข้อมูล';
          });
        } catch (e) {
          console.error("Update profile failed:", e);
          showAlert('ข้อผิดพลาด', `ไม่สามารถอัปเดตได้: ${e.message}`);
           // Re-enable buttons on error
          saveBtn.disabled = false;
          if(cancelBtn) cancelBtn.disabled = false;
           saveBtn.textContent = 'บันทึกข้อมูล';
        }
      };

      // Initialize in read-only mode
      toggleEditMode(false);
      if (formContainer) formContainer.classList.remove('hidden'); // Ensure form container is visible initially
    }


    async function initRedeem() {
        const redeemListEl = document.getElementById('redeemList');
        if (redeemListEl) redeemListEl.innerHTML = generateCardSkeleton(4); // Show skeleton

        let items = dataCache.redeemItems;
        if (!items || items.length === 0) {
            try {
                console.log("Fetching redeem items...");
                const res = await fetch(`${CONFIG.GAS_URL}?action=getItems`);
                items = await res.json();
                if (items.error) throw new Error(items.error);
                dataCache.redeemItems = items; // Cache items
            } catch (e) {
                console.error("Error fetching items:", e);
                if (redeemListEl) redeemListEl.innerHTML = `<li class="col-span-2 text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดของรางวัล: ${e.message}</li>`;
                return; // Exit if fetch fails
            }
        } else {
            console.log("Using cached redeem items.");
        }

        if (!items || items.length === 0) {
            redeemListEl.innerHTML = `<li class="col-span-2 text-center text-gray-400 py-4">ไม่มีของรางวัลให้แลกในขณะนี้</li>`;
            return;
        }

        // Render items
        redeemListEl.innerHTML = items.map(item => `
            <li class="bg-white p-4 rounded shadow-sm text-center flex flex-col justify-between">
                <div>
                  <img src="${item.image || 'https://via.placeholder.com/100x80?text=No+Image'}" alt="${item.name}" class="h-24 w-full object-cover mx-auto mb-2 rounded-md">
                  <div class="font-bold mb-1 text-gray-800">${item.name}</div>
                  <div class="text-sm text-gray-600 mb-2">${item.point.toLocaleString()} พ้อยต์</div>
                </div>
                <button
                    data-item-id="${item.id}"
                    data-item-name="${item.name}"
                    data-item-point="${item.point}"
                    data-item-type="${item.type}"
                    class="redeem-btn btn btn-neutral btn-sm mt-2"
                    ${userState.points < item.point ? 'disabled' : ''}> <!-- Disable button if not enough points -->
                    ${userState.points < item.point ? 'พ้อยต์ไม่พอ' : 'แลกเลย'}
                </button>
            </li>
        `).join('');

        // Add event listeners after rendering
        document.querySelectorAll('.redeem-btn').forEach(btn => {
            // Only add listener if button is not disabled (i.e., user has enough points)
            if (!btn.disabled) {
                 btn.addEventListener('click', handleRedeemClick);
            }
        });
    }

    async function handleRedeemClick(event) {
        const btn = event.currentTarget;
        const { itemId, itemName, itemPoint, itemType } = btn.dataset;
        const point = parseInt(itemPoint, 10);

        // This check should technically not be needed if button is disabled correctly, but good fallback
        if (userState.points < point) {
            showAlert("ไม่เพียงพอ", `แต้มของคุณ (${userState.points.toLocaleString()}) ไม่พอสำหรับแลก "${itemName}" ซึ่งใช้ ${point.toLocaleString()} พ้อยต์`);
            return;
        }

        if (itemType === 'physical') {
            // Show shipping form for physical items
            showShippingForm({ itemId, itemName, point });
        } else {
            // Direct redemption for digital items
            const confirmed = await showConfirm(`ยืนยันการแลก`, `แลก "${itemName}" ด้วย ${point.toLocaleString()} พ้อยต์ ใช่หรือไม่?`);
            if (!confirmed) return;
            await executeRedemption(btn, { itemId, point });
        }
    }

     // Function to show the shipping form dialog
    function showShippingForm(item) {
        shippingFormTitle.textContent = `ข้อมูลจัดส่งสำหรับ: ${item.itemName}`;

        // Pre-fill form with user's profile info if available
        const profile = dataCache.userProfileFull || {};
        shippingNameInput.value = profile.name || '';
        shippingPhoneInput.value = profile.phone || '';
        shippingAddressInput.value = profile.address || '';

        // Remove previous listeners to avoid duplicates
        shippingFormConfirmBtn.onclick = null;
        shippingFormCancelBtn.onclick = null;

        // Show the dialog
        shippingFormDialog.showModal();

        // Set up new listeners
        shippingFormConfirmBtn.onclick = async () => {
            const shippingName = shippingNameInput.value.trim();
            const shippingPhone = shippingPhoneInput.value.trim();
            const shippingAddress = shippingAddressInput.value.trim();

            if (!shippingName || !shippingPhone || !shippingAddress) {
                showAlert("ข้อมูลไม่ครบ", "กรุณากรอกชื่อ, เบอร์โทร, และที่อยู่ให้ครบถ้วน");
                return;
            }

            // Close the shipping form dialog
            shippingFormDialog.close();

            // Find the original redeem button element by item ID
            const originalButton = document.querySelector(`.redeem-btn[data-item-id="${item.itemId}"]`);

            // Proceed with redemption, including shipping info
            await executeRedemption(originalButton, {
                itemId: item.itemId,
                point: item.point,
                shippingInfo: { name: shippingName, phone: shippingPhone, address: shippingAddress }
            });
        };

        shippingFormCancelBtn.onclick = () => {
            shippingFormDialog.close();
        };
    }


    async function executeRedemption(buttonElement, payload) {
        if (!buttonElement) {
            console.error("Redeem button element not found.");
            showAlert('ข้อผิดพลาด', 'ไม่สามารถทำรายการแลกของได้ (ปุ่มไม่พร้อมใช้งาน)');
            return;
        }

        buttonElement.disabled = true;
        buttonElement.textContent = "กำลังแลก...";

        try {
            console.log("Executing redemption...", payload);
            const body = {
                action: 'redeemItem',
                lineId: userState.lineId,
                itemId: payload.itemId,
                point: payload.point,
                ...(payload.shippingInfo && { shippingInfo: payload.shippingInfo }) // Include shippingInfo if present
            };

            const res = await fetch(CONFIG.GAS_URL, { method: 'POST', body: JSON.stringify(body) });
            const text = await res.text(); // Assuming GAS returns plain text status

            showAlert("สถานะการแลก", text, async () => {
                if (text.includes("สำเร็จ") || text.includes("เข้าคลังแล้ว")) {
                    // Update user state (points will change)
                    await fetchAndUpdateUserState();
                    // Mark the item as 'แลกแล้ว' on the button
                    buttonElement.textContent = "แลกแล้ว";
                     // Optionally, disable the button permanently or remove it
                     buttonElement.disabled = true;
                     // Refresh the redeem list to show updated availability/state (optional)
                     initRedeem(); // Re-initialize the redeem view
                } else {
                    // If not successful, re-enable the button
                    buttonElement.disabled = false;
                    buttonElement.textContent = "แลกเลย";
                    // Re-render the redeem list to reset state
                    initRedeem();
                }
            });
        } catch (e) {
            console.error("Redemption failed:", e);
            showAlert('ข้อผิดพลาด', `ไม่สามารถทำรายการแลกของได้: ${e.message}`);
            // Re-enable button on error
            buttonElement.disabled = false;
            buttonElement.textContent = "แลกเลย";
             // Re-render the redeem list to reset state
             initRedeem();
        }
    }

    async function initTransfer() {
      const toEl = document.getElementById('transferTo'), amountEl = document.getElementById('transferAmount'), transferBtn = document.getElementById('transferBtn');

        if (!toEl || !amountEl || !transferBtn) {
             console.error("Transfer elements not found.");
             return;
        }

      transferBtn.onclick = async () => {
          const to = toEl.value.trim();
          const amount = parseInt(amountEl.value, 10);

          if (!to) { showAlert("ข้อผิดพลาด", "กรุณากรอก LINE ID / เบอร์โทรปลายทาง"); return; }
          if (isNaN(amount) || amount <= 0) { showAlert("ข้อผิดพลาด", "กรุณากรอกจำนวนพ้อยต์ให้ถูกต้อง (ต้องเป็นตัวเลขบวก)"); return; }
          if (to === userState.lineId) { showAlert("ข้อผิดพลาด", "ไม่สามารถโอนให้ตัวเองได้"); return; }
          if (userState.points < amount) { showAlert("ไม่เพียงพอ", `แต้มของคุณ (${userState.points.toLocaleString()}) ไม่พอสำหรับโอน ${amount.toLocaleString()} พ้อยต์`); return; }

          const confirmed = await showConfirm("ยืนยันการโอน", `คุณต้องการโอน ${amount.toLocaleString()} พ้อยต์ให้ "${to}" ใช่หรือไม่?`);
          if (!confirmed) return;

          transferBtn.disabled = true;
          transferBtn.textContent = 'กำลังโอน...';

          try {
              console.log(`Attempting to transfer ${amount} points from ${userState.lineId} to ${to}`);
              const res = await fetch(CONFIG.GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify({ action: 'transferPoints', from: userState.lineId, to: to, amount: amount })
              });
              const text = await res.text(); // Assuming GAS returns plain text status

              showAlert("สถานะ", text, async () => {
                  if (text.includes("สำเร็จ") || text.includes("เรียบร้อย")) {
                      await fetchAndUpdateUserState(); // Update points and mark history stale
                      // Clear input fields on success
                      toEl.value = '';
                      amountEl.value = '';
                       // Refresh dashboard to show updated points and history
                       router(); // Navigate back to dashboard
                  }
                   // Re-enable button regardless of success for user to retry if needed
                  transferBtn.disabled = false;
                  transferBtn.textContent = 'โอนพ้อย';
              });
          } catch (e) {
              console.error("Transfer failed:", e);
              showAlert("ข้อผิดพลาด", `ไม่สามารถโอนได้: ${e.message}`);
              // Re-enable button on error
              transferBtn.disabled = false;
              transferBtn.textContent = 'โอนพ้อย';
          }
      };
    }

    async function initAddpoint() {
      const scanContainer = document.getElementById('scanContainer');
      const scanBtn = document.getElementById('scanBtn');
      const enterBtn = document.getElementById('enterBtn');
      const manualInput = document.getElementById('manualCode');

      if (!scanContainer || !scanBtn || !enterBtn || !manualInput) {
           console.error("Addpoint elements not found.");
           return;
      }

      // Function to process a given code (from scan or manual input)
      async function processCode(code) {
          if (!code) {
              showAlert('ข้อมูลไม่ครบ', 'กรุณาระบุโค้ด');
              return;
          }
          // Prevent duplicate processing if user tries same code again quickly
           scanBtn.disabled = true;
           enterBtn.disabled = true;
           manualInput.disabled = true;

          try {
               // Check history first if code was already used (less API calls if cached history is fresh)
               const history = await getFreshOrCachedHistory();
               // Check if item.eventId or item.id matches the code
               const alreadyUsed = history.some(item => {
                   const relatedId = item.eventId || item.id; // history uses eventId, maybe code history uses id? Check your history structure.
                   return (item.type === 'code' || item.type === 'event') && String(relatedId) === String(code);
               });

               if (alreadyUsed) {
                   showAlert('รับแล้ว', 'คุณเคยรับโค้ดนี้ไปแล้ว');
                   return; // Stop processing
               }

              console.log(`Processing code: ${code}`);
              // Fetch code details from GAS
              const res = await fetch(`${CONFIG.GAS_URL}?action=getCodeById&id=${code}`);
              const data = await res.json();

              if (data.error) {
                  showAlert('ไม่พบโค้ด', data.error);
                  return; // Stop processing
              }

              // If code is found and valid, display details and confirmation button
              scanContainer.innerHTML = `
                <div class="bg-white p-6 rounded shadow mb-4 text-center">
                  <div class="font-bold text-lg mb-2 text-gray-800">${data.title}</div>
                  <div class="text-sm text-gray-700 mb-4">${data.desc || 'ไม่มีคำอธิบาย'}</div>
                  <div class="font-bold text-yellow-600 mb-4 text-xl">คุณจะได้รับ: ${data.point.toLocaleString()} พ้อยต์</div>
                  <button id="acceptBtn" class="btn btn-neutral w-full">ยืนยันการรับพ้อยต์</button>
                </div>`;

              // Add event listener to the new accept button
              const acceptBtn = document.getElementById('acceptBtn');
              if (acceptBtn) {
                 acceptBtn.addEventListener('click', () => joinCode(data));
              } else {
                   console.error("Accept button not found after rendering code details.");
                   showAlert('ข้อผิดพลาด', 'ไม่สามารถแสดงปุ่มยืนยันได้');
              }


          } catch (e) {
              console.error("Error processing code:", e);
              showAlert('ข้อผิดพลาด', `ไม่สามารถประมวลผลโค้ดได้: ${e.message}`);
          } finally {
              // Re-enable input elements regardless of success (except if replaced by acceptBtn)
               if (document.getElementById('manualCode')) manualInput.disabled = false;
               if (document.getElementById('scanBtn')) scanBtn.disabled = false;
               if (document.getElementById('enterBtn')) enterBtn.disabled = false;
          }
      }

        // Function to join the code (called after confirmation)
      async function joinCode(codeData) {
          const { id: scannedCode, title: codeTitle, point: codePoint } = codeData;

          const confirmed = await showConfirm('ยืนยันการรับพ้อยต์', `คุณต้องการรับพ้อยต์จาก "${codeTitle}" จำนวน ${codePoint.toLocaleString()} พ้อยต์ใช่หรือไม่?`);
          if (!confirmed) {
              // If cancelled, re-render the initial addpoint view
              router(); // Navigate back to #addpoint
              return;
          }

          const btn = document.getElementById("acceptBtn");
          if (!btn) {
              console.error("Accept button missing during joinCode.");
              showAlert('ข้อผิดพลาด', 'ไม่สามารถดำเนินการได้ (ปุ่มไม่พร้อมใช้งาน)');
              router(); // Navigate back to #addpoint
              return;
          }

          btn.disabled = true;
          btn.textContent = "กำลังดำเนินการ...";

          let success = false;
          try {
              console.log(`Joining code ${scannedCode}...`);
              const res = await fetch(CONFIG.GAS_URL, {
                  method: "POST",
                  body: JSON.stringify({ action: "joinCode", lineId: userState.lineId, id: scannedCode, title: codeTitle, point: codePoint })
              });
              const text = await res.text(); // Assuming GAS returns plain text status

              if (text.includes("สำเร็จ")) {
                  success = true;
                  btn.textContent = "รับพ้อยต์แล้ว";
                  showAlert("สำเร็จ", text, async () => {
                      await fetchAndUpdateUserState(); // Update points and mark history stale
                      window.location.hash = '#dashboard'; // Navigate to dashboard after success
                  });
              } else {
                  // Handle error message from GAS
                  showAlert("เกิดข้อผิดพลาด", text, () => {
                       window.location.hash = '#addpoint'; // Navigate back to #addpoint on error
                  });
              }
          } catch (e) {
              console.error("Join code failed:", e);
              showAlert('ข้อผิดพลาด', `ไม่สามารถเชื่อมต่อเพื่อรับพ้อยต์ได้: ${e.message}`, () => {
                   window.location.hash = '#addpoint'; // Navigate back to #addpoint on error
              });
          } finally {
               // No need to re-enable the button if navigating away or successful
               // If navigation failed, router() would handle it.
          }
      }


      // Set up initial button listeners
      scanBtn.onclick = async () => {
          try {
              console.log("Starting LIFF scanCodeV2...");
              const result = await liff.scanCodeV2();
              if (result && result.value) {
                  console.log("Scan successful, value:", result.value);
                  await processCode(result.value);
              } else {
                   console.log("Scan returned no value.");
              }
          } catch (e) {
              if (e.code !== 'USER_CANCEL') { // Ignore user cancelling scan
                 console.error("Scan failed:", e);
                 showAlert('สแกนไม่สำเร็จ', e.message || 'กรุณาลองใหม่อีกครั้ง');
              } else {
                   console.log("LIFF scan cancelled by user.");
              }
              // Re-enable inputs if scan fails/cancelled without showing code details
              manualInput.disabled = false;
              scanBtn.disabled = false;
              enterBtn.disabled = false;
          }
      };

      enterBtn.onclick = () => {
        const codeValue = manualInput.value.trim();
        console.log("Manual code entered:", codeValue);
        processCode(codeValue); // Process the manually entered code
      };
    }

    // --- WAREHOUSE ---

    // Function to fetch and render warehouse items
    async function initWarehouse() {
      const warehouseListEl = document.getElementById('warehouseList');
      if (warehouseListEl) warehouseListEl.innerHTML = generateListSkeleton(3); // Show skeleton

      try {
        console.log("Fetching warehouse items for user:", userState.lineId);
        const res = await fetch(`${CONFIG.GAS_URL}?action=getWarehouseItems&lineId=${userState.lineId}`);
        const ownedItems = await res.json();

        if (!ownedItems || ownedItems.error) {
             const errorMessage = ownedItems?.error || 'Failed to load data';
             console.error("Error fetching warehouse items:", errorMessage);
             if (warehouseListEl) warehouseListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดคลัง: ${errorMessage}</li>`;
             return;
        }

        if (ownedItems.length === 0) {
          warehouseListEl.innerHTML = '<li class="text-center text-gray-400 py-4">ยังไม่มีของรางวัลในคลังของคุณ</li>';
          return;
        }

        // Render the list of items
        warehouseListEl.innerHTML = ownedItems.map(item => {
          const isClaimed = item.status === 'claimed';
          const statusBadgeClass = isClaimed ? 'badge-success' : 'badge-warning';
          const statusText = isClaimed ? 'รับแล้ว' : 'รอรับ';

          const actionArea = isClaimed
            ? `<div class="text-xs text-gray-500 mt-1">วันที่รับ: ${item.claimDate || '-'}</div>`
            : `<button class="btn btn-neutral btn-sm claim-btn"
                        data-warehouse-id="${item.warehouseId}"
                        data-item-name="${item.itemName}"
                        data-unique-id="${item.uniqueId}"
                        data-item-status="${item.status}"
                        >รับของ</button>`; // Added data-item-status

          return `<li class="bg-white rounded p-4 shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-semibold text-gray-800 text-sm">${item.itemName}</div>
                        <div class="text-xs text-gray-500 mt-1">วันที่แลก: ${item.redeemDate}</div>
                        <span class="badge ${statusBadgeClass}">${statusText}</span>
                    </div>
                    <div class="text-right">${actionArea}</div>
                  </li>`;
        }).join('');

        // Attach event listeners to 'claim-btn' elements
        document.querySelectorAll('.claim-btn').forEach(button => {
            button.addEventListener('click', handleClaimButtonClick);
        });

      } catch (e) {
        console.error("Error in initWarehouse:", e);
        showAlert("เกิดข้อผิดพลาด", `ไม่สามารถโหลดคลังของรางวัลได้: ${e.message}`);
        if (warehouseListEl) warehouseListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดคลัง</li>`;
      }
    }

    // Function to check item status via polling
    async function checkClaimStatus(warehouseId, itemName) {
        console.log(`Polling status for warehouseId: ${warehouseId}...`);
        try {
            // Call GAS endpoint to get the item status
            const res = await fetch(`${CONFIG.GAS_URL}?action=getWarehouseItemStatus&warehouseId=${warehouseId}`);
            const data = await res.json();

            if (data && data.status === 'claimed') {
                console.log(`Item ${warehouseId} has been claimed!`);
                // Stop polling
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.log('Polling stopped.');
                }

                // Close the QR dialog
                qrDialog.close();

                // Notify the user and refresh the warehouse list
                showAlert("รับสินค้าสำเร็จ", `"${itemName}" ถูกบันทึกเข้าระบบเรียบร้อยแล้ว`, () => {
                    // Re-initialize the warehouse view to show updated status
                    initWarehouse();
                });

            } else if (data && data.status === 'not_found') {
                 console.warn(`Warehouse item ${warehouseId} not found during polling.`);
                 // Stop polling if item is not found (e.g., deleted?)
                  if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.log('Polling stopped due to item not found.');
                }
                qrDialog.close();
                showAlert("ข้อผิดพลาด", `ไม่พบรายการสินค้าในคลัง (ID: ${warehouseId})`, () => {
                    initWarehouse(); // Refresh in case list needs update
                });

            } else if (data && data.error) {
                console.error(`Error status from GAS during polling for ${warehouseId}:`, data.error);
                 // Optionally stop polling on severe errors
                // if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
                // showAlert("ข้อผิดพลาดในการตรวจสอบ", `ไม่สามารถตรวจสอบสถานะได้: ${data.error}`);
                 // Decide if polling should stop on error or retry
            }
            // If status is still 'pending_claim' or other, polling continues

        } catch (err) {
            console.error('Polling failed due to network error:', err);
            // Stop polling if there's a network error
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('Polling stopped due to network error.');
            }
            // Optionally notify user of polling failure, but avoid spamming alerts
            // showAlert('การตรวจสอบล้มเหลว', 'ไม่สามารถเชื่อมต่อเพื่อตรวจสอบสถานะได้');
        }
    }


    // Function handling the click on the 'รับของ' button
    function handleClaimButtonClick(event) {
        // Ensure any previous polling is stopped
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            console.log('Cleared existing polling interval.');
        }

        const btn = event.currentTarget;
        const { warehouseId, itemName, uniqueId, itemStatus } = btn.dataset;

        // Optional: Check status again just in case UI is stale (less critical with polling)
        if (itemStatus === 'claimed') {
            showAlert('รับแล้ว', `รายการ "${itemName}" นี้ถูกรับไปแล้ว`);
            // Re-initialize warehouse to refresh UI if it was stale
             initWarehouse();
            return;
        }


        // Set text and QR data in the dialog
        qrDialogTitle.textContent = `รับ: ${itemName}`;
        // Display warehouseId or a shortened uniqueId for user reference
        qrDialogItemName.textContent = `ID รายการ: ${warehouseId}`; // Or `ID: ${uniqueId.substring(0, 8)}...`;

        // Clear previous QR and generate new one
        qrcodeContainer.innerHTML = '';
        try {
            const qr = qrcode(4, 'L'); // Error correction level L
            qr.addData(uniqueId); // The UniqueID is the data the Admin Scanner will read
            qr.make();
            // Create an image tag from the QR code data
            qrcodeContainer.innerHTML = qr.createImgTag(6, 4); // Module size 6, Margin 4
            console.log(`Generated QR code for UniqueID: ${uniqueId}`);
        } catch(e) {
            qrcodeContainer.innerHTML = `<p class="text-red-500">ไม่สามารถสร้าง QR Code ได้</p>`;
            console.error("QR code generation failed:", e);
        }

        // Set up the close button listener for the QR dialog
        // Remove existing listener first to avoid duplicates
        qrCloseBtn.onclick = null;
        qrCloseBtn.onclick = () => {
            // Stop polling when the user closes the dialog
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('Polling stopped by user closing dialog.');
            }
            qrDialog.close();
        };

        // Show the QR dialog
        qrDialog.showModal();

        // Start polling for status updates
        // Call checkClaimStatus for this specific warehouseId every 3 seconds
        pollingInterval = setInterval(() => checkClaimStatus(warehouseId, itemName), 3000); // Poll every 3 seconds
        console.log(`Started polling for warehouseId: ${warehouseId} every 3 seconds.`);
    }


    // --- APP START ---
    async function initializeApp() {
      const liffReady = await ensureLIFFAndFetchInitialData();
      if (!liffReady) return; // Stop if LIFF/data initialization failed

      // Add event listener for hash changes to handle navigation
      window.addEventListener('hashchange', router);

      // Initial route handling based on current hash or default
      router();
    }

    // Start the application initialization process
    initializeApp();
</script>
</body>
</html>
