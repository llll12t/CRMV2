<!DOCTYPE html>
<html lang="th" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Scanner - ยืนยันการแลกของรางวัล</title>
    <!-- 1. เรียกใช้ config-scan.js -->
    <script src="config-admin.js"></script>
    <!-- DaisyUI & TailwindCSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            background-color: #f0f2f5;
        }

        .qr-reader-container {
            max-width: 500px;
            margin: auto;
        }

        #qr-reader {
            border: 2px dashed #9ca3af;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
        }

        .scan-success {
            color: #16a34a;
        }

        .scan-warning {
            color: #f59e0b;
        }

        .scan-error {
            color: #dc2626;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">จุดสแกนรับของรางวัล</h1>
            <p class="text-gray-600">สำหรับพนักงาน: กรุณาสแกน QR Code ของลูกค้าเพื่อยืนยัน</p>
        </header>

        <!-- Scanner Section -->
        <section class="card bg-base-100 shadow-xl mb-8 qr-reader-container">
            <div class="card-body items-center text-center">
                <div id="qr-reader" class="w-full h-64 overflow-hidden"></div>
                <div class="card-actions w-full mt-4">
                    <button id="startScanBtn" class="btn btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff"
                            fill="none">
                            <path
                                d="M2.5 8.18677C2.60406 6.08705 2.91537 4.77792 3.84664 3.84664C4.77792 2.91537 6.08705 2.60406 8.18677 2.5M21.5 8.18677C21.3959 6.08705 21.0846 4.77792 20.1534 3.84664C19.2221 2.91537 17.9129 2.60406 15.8132 2.5M15.8132 21.5C17.9129 21.3959 19.2221 21.0846 20.1534 20.1534C21.0846 19.2221 21.3959 17.9129 21.5 15.8132M8.18676 21.5C6.08705 21.3959 4.77792 21.0846 3.84664 20.1534C2.91537 19.2221 2.60406 17.9129 2.5 15.8132"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M2.49986 12H21.4999" stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" />
                            <path
                                d="M6 12C6 8.68629 8.68629 6 12 6C12 7.65685 13.3431 9 15 9C15.6755 9 16.2989 8.77672 16.8004 8.39993C17.5536 9.40273 18 10.6492 18 12M17.1973 15C16.1599 16.7934 14.2208 18 12 18C9.77915 18 7.84012 16.7934 6.80269 15"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg> เริ่มสแกน
                    </button>
                    <button id="stopScanBtn" class="btn btn-ghost w-full hidden">หยุดสแกน</button>
                </div>
                <div id="scan-result" class="mt-4 text-lg font-semibold h-16"></div>
            </div>
        </section>

        <!-- History Section -->
        <section>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">ประวัติการสแกนล่าสุด</h2>
                <button id="refreshHistoryBtn" class="btn btn-sm btn-ghost">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" color="#000000" fill="none">
                    <path d="M20.0092 2V5.13219C20.0092 5.42605 19.6418 5.55908 19.4537 5.33333C17.6226 3.2875 14.9617 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>> รีเฟรช
                </button>
            </div>
            <div class="overflow-x-auto bg-base-100 rounded-lg shadow-md">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>ของรางวัล</th>
                            <th>ผู้รับ (Line ID)</th>
                            <th>สถานะ</th>
                            <th>วันที่แลก</th>
                            <th>วันที่ยืนยัน</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="5" class="text-center p-4">กำลังโหลดประวัติ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Alert Dialog -->
    <dialog id="alert-dialog" class="modal">
        <div class="modal-box text-center">
            <h3 id="alert-title" class="font-bold text-lg"></h3>
            <p id="alert-message" class="py-4"></p>
            <div class="modal-action">
                <form method="dialog"><button class="btn btn-primary w-full">ตกลง</button></form>
            </div>
        </div>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const readerElement = document.getElementById('qr-reader');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const resultElement = document.getElementById('scan-result');
            const historyTableBody = document.getElementById('historyTableBody');
            const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');

            let html5QrCode = null;
            let lastScanTime = 0;
            const SCAN_COOLDOWN = 3000; // 3 seconds cooldown to prevent multiple scans

            // --- Helper Functions ---
            const showAlert = (title, message) => {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').textContent = message;
                document.getElementById('alert-dialog').showModal();
            };

            const postData = async (action, data) => {
                try {
                    // 2. ใช้ CONFIG.GAS_URL_ADMIN ที่มาจาก config-scan.js
                    const r = await fetch(CONFIG.GAS_URL_ADMIN, {
                        method: 'POST',
                        body: JSON.stringify({ action, ...data })
                    });
                    if (!r.ok) throw new Error(`Server error (${r.status}): ${await r.text()}`);
                    return await r.text();
                } catch (e) {
                    showAlert('API Error', `Post request failed: ${e.message}`);
                    throw e;
                }
            };

            const fetchData = async (action, params = {}) => {
                // 3. ใช้ CONFIG.GAS_URL_ADMIN ที่มาจาก config-scan.js
                const url = new URL(CONFIG.GAS_URL_ADMIN);
                url.searchParams.append('action', action);
                for (const k in params) if (params[k]) url.searchParams.append(k, params[k]);
                try {
                    const r = await fetch(url);
                    if (!r.ok) throw new Error(`Server error (${r.status}): ${await r.text()}`);
                    return await r.json();
                } catch (e) {
                    showAlert('API Error', `Fetch request failed: ${e.message}`);
                    throw e;
                }
            };

            // --- Core Functions ---
            const loadHistory = async () => {
                historyTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4"><span class="loading loading-dots loading-md"></span></td></tr>`;
                try {
                    // ดึงเฉพาะรายการที่ยืนยันแล้ว และแสดงแค่ 10 รายการล่าสุด
                    const items = await fetchData('getWarehouseItems', { status: 'claimed' });
                    if (!items || items.length === 0) {
                        historyTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">ยังไม่มีประวัติการยืนยัน</td></tr>`;
                        return;
                    }
                    historyTableBody.innerHTML = items.slice(0, 10).map(item => `
                    <tr>
                        <td><strong>${item.itemName}</strong></td>
                        <td class="font-mono text-xs">${item.lineId}</td>
                        <td><span class="badge badge-success">${item.status}</span></td>
                        <td>${item.redeemDate}</td>
                        <td>${item.claimDate}</td>
                    </tr>
                `).join('');
                } catch (error) {
                    historyTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-error">ไม่สามารถโหลดประวัติได้</td></tr>`;
                }
            };

            const onScanSuccess = async (decodedText, decodedResult) => {
                const now = Date.now();
                if (now - lastScanTime < SCAN_COOLDOWN) return;
                lastScanTime = now;

                await stopScanning();

                resultElement.innerHTML = `<span class="loading loading-spinner loading-sm"></span> กำลังตรวจสอบ...`;
                resultElement.className = 'mt-4 text-lg font-semibold h-8';

                try {
                    const responseText = await postData('claimItemByUniqueId', { uniqueId: decodedText });

                    showAlert('ผลการยืนยัน', responseText);

                    if (responseText.includes('สำเร็จ')) {
                        resultElement.innerHTML = `✅ ยืนยันสำเร็จ`;
                        resultElement.className = 'mt-4 text-lg font-semibold h-8 scan-success';
                        await loadHistory();
                    } else {
                        resultElement.innerHTML = `⚠️ ${responseText.includes('แล้ว') ? 'ใช้ไปแล้ว' : 'ไม่สำเร็จ'}`;
                        resultElement.className = `mt-4 text-lg font-semibold h-8 ${responseText.includes('แล้ว') ? 'scan-warning' : 'scan-error'}`;
                    }
                } catch (error) {
                    resultElement.innerHTML = `❌ เกิดข้อผิดพลาด`;
                    resultElement.className = 'mt-4 text-lg font-semibold h-8 scan-error';
                }
            };

            const startScanning = () => {
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (error) => { })
                    .then(() => {
                        startBtn.classList.add('hidden');
                        stopBtn.classList.remove('hidden');
                        resultElement.textContent = 'กรุณาหันกล้องไปที่ QR Code';
                        resultElement.className = 'mt-4 text-lg font-semibold h-8 text-gray-500';
                    })
                    .catch(err => {
                        showAlert("ข้อผิดพลาด", "ไม่สามารถเปิดกล้องได้ กรุณาตรวจสอบการอนุญาตให้ใช้กล้องใน Browser");
                    });
            };

            const stopScanning = async () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    try {
                        await html5QrCode.stop();
                        startBtn.classList.remove('hidden');
                        stopBtn.classList.add('hidden');
                    } catch (err) { console.error("Failed to stop scanning.", err); }
                }
            };

            // --- Event Listeners ---
            startBtn.onclick = startScanning;
            stopBtn.onclick = stopScanning;
            refreshHistoryBtn.onclick = loadHistory;

            // --- Initial Load ---
            loadHistory();
        });
    </script>

</body>

</html>
